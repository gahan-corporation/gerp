
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>gerp.http &#8212; gerp 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for gerp.http</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># OpenERP HTTP layer</span>
<span class="c1">#----------------------------------------------------------</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">mimetypes</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="k">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">opj</span>
<span class="kn">from</span> <span class="nn">zlib</span> <span class="k">import</span> <span class="n">adler32</span>

<span class="kn">import</span> <span class="nn">babel.core</span>
<span class="kn">import</span> <span class="nn">passlib.utils</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">werkzeug.contrib.sessions</span>
<span class="kn">import</span> <span class="nn">werkzeug.datastructures</span>
<span class="kn">import</span> <span class="nn">werkzeug.exceptions</span>
<span class="kn">import</span> <span class="nn">werkzeug.local</span>
<span class="kn">import</span> <span class="nn">werkzeug.routing</span>
<span class="kn">import</span> <span class="nn">werkzeug.wrappers</span>
<span class="kn">import</span> <span class="nn">werkzeug.wsgi</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="k">import</span> <span class="n">urls</span>
<span class="kn">from</span> <span class="nn">werkzeug.wsgi</span> <span class="k">import</span> <span class="n">wrap_file</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">psutil</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">psutil</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">import</span> <span class="nn">gerp</span>
<span class="kn">from</span> <span class="nn">.service.server</span> <span class="k">import</span> <span class="n">memory_info</span>
<span class="kn">from</span> <span class="nn">.service</span> <span class="k">import</span> <span class="n">security</span><span class="p">,</span> <span class="n">model</span> <span class="k">as</span> <span class="n">service_model</span>
<span class="kn">from</span> <span class="nn">.tools.func</span> <span class="k">import</span> <span class="n">lazy_property</span>
<span class="kn">from</span> <span class="nn">.tools</span> <span class="k">import</span> <span class="n">ustr</span><span class="p">,</span> <span class="n">consteq</span><span class="p">,</span> <span class="n">frozendict</span><span class="p">,</span> <span class="n">pycompat</span><span class="p">,</span> <span class="n">unique</span>

<span class="kn">from</span> <span class="nn">.modules.module</span> <span class="k">import</span> <span class="n">module_manifest</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">rpc_request</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;.rpc.request&#39;</span><span class="p">)</span>
<span class="n">rpc_response</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;.rpc.response&#39;</span><span class="p">)</span>

<span class="c1"># 1 week cache for statics as advised by Google Page Speed</span>
<span class="n">STATIC_CACHE</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span>

<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># RequestHandler</span>
<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># Thread local global request object</span>
<span class="n">_request_stack</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">LocalStack</span><span class="p">()</span>

<span class="n">request</span> <span class="o">=</span> <span class="n">_request_stack</span><span class="p">()</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A global proxy that always redirect to the current request object.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">replace_request_password</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="c1"># password is always 3rd argument in a request, we replace it in RPC logs</span>
    <span class="c1"># so it&#39;s easier to forward logs for diagnostics/debugging purposes...</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

<span class="c1"># don&#39;t trigger debugger for those exceptions, they carry user-facing warnings</span>
<span class="c1"># and indications, they&#39;re not necessarily indicative of anything being</span>
<span class="c1"># *broken*</span>
<span class="n">NO_POSTMORTEM</span> <span class="o">=</span> <span class="p">(</span><span class="n">gerp</span><span class="o">.</span><span class="n">osv</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">except_orm</span><span class="p">,</span>
                 <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">AccessError</span><span class="p">,</span>
                 <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">,</span>
                 <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">MissingError</span><span class="p">,</span>
                 <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">AccessDenied</span><span class="p">,</span>
                 <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Warning</span><span class="p">,</span>
                 <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RedirectWarning</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dispatch_rpc</span><span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Handle a RPC call.</span>

<span class="sd">    This is pure Python code, the actual marshalling (from/to XML-RPC) is done</span>
<span class="sd">    in a upper layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rpc_request_flag</span> <span class="o">=</span> <span class="n">rpc_request</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="n">rpc_response_flag</span> <span class="o">=</span> <span class="n">rpc_response</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rpc_request_flag</span> <span class="ow">or</span> <span class="n">rpc_response_flag</span><span class="p">:</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">start_rss</span><span class="p">,</span> <span class="n">start_vms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">psutil</span><span class="p">:</span>
                <span class="n">start_rss</span><span class="p">,</span> <span class="n">start_vms</span> <span class="o">=</span> <span class="n">memory_info</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">rpc_request</span> <span class="ow">and</span> <span class="n">rpc_response_flag</span><span class="p">:</span>
                <span class="n">gerp</span><span class="o">.</span><span class="n">netsvc</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rpc_request</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="n">method</span><span class="p">),</span> <span class="n">replace_request_password</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>

        <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">dbname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">service_name</span> <span class="o">==</span> <span class="s1">&#39;common&#39;</span><span class="p">:</span>
            <span class="n">dispatch</span> <span class="o">=</span> <span class="n">gerp</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">dispatch</span>
        <span class="k">elif</span> <span class="n">service_name</span> <span class="o">==</span> <span class="s1">&#39;db&#39;</span><span class="p">:</span>
            <span class="n">dispatch</span> <span class="o">=</span> <span class="n">gerp</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">dispatch</span>
        <span class="k">elif</span> <span class="n">service_name</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
            <span class="n">dispatch</span> <span class="o">=</span> <span class="n">gerp</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">dispatch</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">dispatch</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rpc_request_flag</span> <span class="ow">or</span> <span class="n">rpc_response_flag</span><span class="p">:</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">end_rss</span><span class="p">,</span> <span class="n">end_vms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">psutil</span><span class="p">:</span>
                <span class="n">end_rss</span><span class="p">,</span> <span class="n">end_vms</span> <span class="o">=</span> <span class="n">memory_info</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>
            <span class="n">logline</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> time:</span><span class="si">%.3f</span><span class="s1">s mem: </span><span class="si">%s</span><span class="s1">k -&gt; </span><span class="si">%s</span><span class="s1">k (diff: </span><span class="si">%s</span><span class="s1">k)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">service_name</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">start_vms</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">end_vms</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">(</span><span class="n">end_vms</span> <span class="o">-</span> <span class="n">start_vms</span><span class="p">)</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rpc_response_flag</span><span class="p">:</span>
                <span class="n">gerp</span><span class="o">.</span><span class="n">netsvc</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rpc_response</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">logline</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gerp</span><span class="o">.</span><span class="n">netsvc</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rpc_request</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">logline</span><span class="p">,</span> <span class="n">replace_request_password</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="k">except</span> <span class="n">NO_POSTMORTEM</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">DeferredException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">exception_to_unicode</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">post_mortem</span><span class="p">(</span><span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">traceback</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">exception_to_unicode</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">post_mortem</span><span class="p">(</span><span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="k">raise</span>

<span class="k">def</span> <span class="nf">local_redirect</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keep_hash</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">forward_debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">303</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="p">:</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">forward_debug</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">url_encode</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">keep_hash</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect_with_hash</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">redirect_with_hash</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">303</span><span class="p">):</span>
    <span class="c1"># Most IE and Safari versions decided not to preserve location.hash upon</span>
    <span class="c1"># redirect. And even if IE10 pretends to support it, it still fails</span>
    <span class="c1"># inexplicably in case of multiple redirects (and we do have some).</span>
    <span class="c1"># See extensive test page at http://greenbytes.de/tech/tc/httpredirects/</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">user_agent</span><span class="o">.</span><span class="n">browser</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;firefox&#39;</span><span class="p">,):</span>
        <span class="k">return</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
    <span class="c1"># FIXME: decide whether urls should be bytes or text, apparently</span>
    <span class="c1"># addons/website/controllers/main.py:91 calls this with a bytes url</span>
    <span class="c1"># but addons/web/controllers/main.py:481 uses text... (blows up on login)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">to_text</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">urls</span><span class="o">.</span><span class="n">url_parse</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="s1">&#39;http&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="n">url</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;%27&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;%3C&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;&lt;html&gt;&lt;head&gt;&lt;script&gt;window.location = &#39;</span><span class="si">%s</span><span class="s2">&#39; + location.hash;&lt;/script&gt;&lt;/head&gt;&lt;/html&gt;&quot;</span> <span class="o">%</span> <span class="n">url</span>

<div class="viewcode-block" id="WebRequest"><a class="viewcode-back" href="../../reference/http.html#gerp.http.WebRequest">[docs]</a><span class="k">class</span> <span class="nc">WebRequest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Parent class for all Odoo Web request types, mostly deals with</span>
<span class="sd">    initialization and setup of the request object (the dispatching itself has</span>
<span class="sd">    to be handled by the subclasses)</span>

<span class="sd">    :param httprequest: a wrapped werkzeug Request object</span>
<span class="sd">    :type httprequest: :class:`werkzeug.wrappers.BaseRequest`</span>

<span class="sd">    .. attribute:: httprequest</span>

<span class="sd">        the original :class:`werkzeug.wrappers.Request` object provided to the</span>
<span class="sd">        request</span>

<span class="sd">    .. attribute:: params</span>

<span class="sd">        :class:`~collections.Mapping` of request parameters, not generally</span>
<span class="sd">        useful as they&#39;re provided directly to the handler method as keyword</span>
<span class="sd">        arguments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">httprequest</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span> <span class="o">=</span> <span class="n">httprequest</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">httpresponse</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_db</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_arguments</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_method</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># prevents transaction commit, use when you catch an exception during handling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_failed</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># set db/uid trackers - they&#39;re cleaned up at the WSGI</span>
        <span class="c1"># dispatching phase in gerp.service.wsgi_server.application</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">dbname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">uid</span><span class="p">:</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">uid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; :class:`~gerp.sql_db.Cursor` initialized for the current method call.</span>

<span class="sd">        Accessing the cursor when the current request uses the ``none``</span>
<span class="sd">        authentication will raise an exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># can not be a lazy_property because manual rollback in _call_function</span>
        <span class="c1"># if already set (?)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;request not bound to a database&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span>

    <span class="nd">@uid</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">uid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; :class:`~collections.Mapping` of context values for the current request &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">frozendict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span>

    <span class="nd">@context</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">frozendict</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; The :class:`~gerp.api.Environment` bound to current request. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="n">gerp</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">lang</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_fix_lang</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="k">return</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;lang&quot;</span><span class="p">]</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; :class:`OpenERPSession` holding the HTTP session data for the</span>
<span class="sd">        current http session</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">session</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_request_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">_request_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_failed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">signal_changes</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">reset_changes</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># just to be sure no one tries to re-use the request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_db</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">set_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">auth</span><span class="p">):</span>
        <span class="c1"># is this needed ?</span>
        <span class="n">arguments</span> <span class="o">=</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arguments</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                         <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_ignored_&quot;</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_arguments</span> <span class="o">=</span> <span class="n">arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">endpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth_method</span> <span class="o">=</span> <span class="n">auth</span>

    <span class="k">def</span> <span class="nf">_handle_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called within an except block to allow converting exceptions</span>
<span class="sd">           to abitrary responses. Anything returned (except None) will</span>
<span class="sd">           be used as response.&quot;&quot;&quot;</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">_failed</span> <span class="o">=</span> <span class="n">exception</span> <span class="c1"># prevent tx commit</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">NO_POSTMORTEM</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">):</span>
            <span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">post_mortem</span><span class="p">(</span>
                <span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="c1"># otherwise &quot;no active exception to reraise&quot;</span>
        <span class="k">raise</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">reraise</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">exception</span><span class="p">),</span> <span class="n">exception</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_call_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_type</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">: Function declared as capable of handling request of type &#39;</span><span class="si">%s</span><span class="s2">&#39; but called with a request of type &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="o">.</span><span class="n">original</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_type</span><span class="p">)</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint_arguments</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint_arguments</span><span class="p">)</span>

        <span class="c1"># Backward for 7.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="o">.</span><span class="n">first_arg_is_req</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="p">,)</span> <span class="o">+</span> <span class="n">args</span>

        <span class="c1"># Correct exception handling and concurency retry</span>
        <span class="nd">@service_model</span><span class="o">.</span><span class="n">check</span>
        <span class="k">def</span> <span class="nf">checked_call</span><span class="p">(</span><span class="n">___dbname</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="c1"># The decorator can call us more than once if there is an database error. In this</span>
            <span class="c1"># case, the request cursor is unusable. Rollback transaction to create a new one.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Response</span><span class="p">)</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">is_qweb</span><span class="p">:</span>
                <span class="c1"># Early rendering of lazy responses to benefit from @service_model.check protection</span>
                <span class="n">result</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">checked_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Indicates whether the current request is in &quot;debug&quot; mode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">args</span>
        <span class="k">if</span> <span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;assets&#39;</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">=</span> <span class="s1">&#39;assets&#39;</span>

        <span class="c1"># check if request from rpc in debug mode</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_X_DEBUG_MODE&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">debug</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">referrer</span><span class="p">:</span>
            <span class="n">debug</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span> <span class="ow">in</span> <span class="n">urls</span><span class="o">.</span><span class="n">url_parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">referrer</span><span class="p">)</span><span class="o">.</span><span class="n">decode_query</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">debug</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">registry_cr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;please use request.registry and request.cr directly&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="k">yield</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">registry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The registry to the database linked to this request. Can be ``None``</span>
<span class="sd">        if the current request uses the ``none`` authentication.</span>

<span class="sd">        .. deprecated:: 8.0</span>

<span class="sd">            use :attr:`.env`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">gerp</span><span class="o">.</span><span class="n">registry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The database linked to this request. Can be ``None``</span>
<span class="sd">        if the current request uses the ``none`` authentication.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">db</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_db</span> <span class="k">else</span> <span class="kc">None</span>

<div class="viewcode-block" id="WebRequest.csrf_token"><a class="viewcode-back" href="../../reference/http.html#gerp.http.WebRequest.csrf_token">[docs]</a>    <span class="k">def</span> <span class="nf">csrf_token</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_limit</span><span class="o">=</span><span class="mi">3600</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates and returns a CSRF token for the current session</span>

<span class="sd">        :param time_limit: the CSRF token should only be valid for the</span>
<span class="sd">                           specified duration (in second), by default 1h,</span>
<span class="sd">                           ``None`` for the token to be valid as long as the</span>
<span class="sd">                           current user&#39;s session is.</span>
<span class="sd">        :type time_limit: int | None</span>
<span class="sd">        :returns: ASCII token string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">sid</span>
        <span class="n">max_ts</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">time_limit</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">time_limit</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">max_ts</span><span class="p">)</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;database.secret&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">secret</span><span class="p">,</span> <span class="s2">&quot;CSRF protection requires a configured database secret&quot;</span>
        <span class="n">hm</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">o</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hm</span><span class="p">,</span> <span class="n">max_ts</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">validate_csrf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">csrf</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">csrf</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">hm</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">max_ts</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">csrf</span><span class="p">)</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">max_ts</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_ts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()):</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">sid</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">max_ts</span><span class="p">)</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.config_parameter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s1">&#39;database.secret&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">secret</span><span class="p">,</span> <span class="s2">&quot;CSRF protection requires a configured database secret&quot;</span>
        <span class="n">hm_expected</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">secret</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">),</span> <span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">consteq</span><span class="p">(</span><span class="n">hm</span><span class="p">,</span> <span class="n">hm_expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="route"><a class="viewcode-back" href="../../reference/http.html#gerp.http.route">[docs]</a><span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="n">route</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator marking the decorated method as being a handler for</span>
<span class="sd">    requests. The method must be part of a subclass of ``Controller``.</span>

<span class="sd">    :param route: string or array. The route part that will determine which</span>
<span class="sd">                  http requests will match the decorated method. Can be a</span>
<span class="sd">                  single string or an array of strings. See werkzeug&#39;s routing</span>
<span class="sd">                  documentation for the format of route expression (</span>
<span class="sd">                  http://werkzeug.pocoo.org/docs/routing/ ).</span>
<span class="sd">    :param type: The type of request, can be ``&#39;http&#39;`` or ``&#39;json&#39;``.</span>
<span class="sd">    :param auth: The type of authentication method, can on of the following:</span>

<span class="sd">                 * ``user``: The user must be authenticated and the current request</span>
<span class="sd">                   will perform using the rights of the user.</span>
<span class="sd">                 * ``public``: The user may or may not be authenticated. If she isn&#39;t,</span>
<span class="sd">                   the current request will perform using the shared Public user.</span>
<span class="sd">                 * ``none``: The method is always active, even if there is no</span>
<span class="sd">                   database. Mainly used by the framework and authentication</span>
<span class="sd">                   modules. There request code will not have any facilities to access</span>
<span class="sd">                   the database nor have any configuration indicating the current</span>
<span class="sd">                   database nor the current user.</span>
<span class="sd">    :param methods: A sequence of http methods this route applies to. If not</span>
<span class="sd">                    specified, all methods are allowed.</span>
<span class="sd">    :param cors: The Access-Control-Allow-Origin cors directive value.</span>
<span class="sd">    :param bool csrf: Whether CSRF protection should be enabled for the route.</span>

<span class="sd">                      Defaults to ``True``. See :ref:`CSRF Protection</span>
<span class="sd">                      &lt;csrf&gt;` for more.</span>

<span class="sd">    .. _csrf:</span>

<span class="sd">    .. admonition:: CSRF Protection</span>
<span class="sd">        :class: alert-warning</span>

<span class="sd">        .. versionadded:: 9.0</span>

<span class="sd">        Odoo implements token-based `CSRF protection</span>
<span class="sd">        &lt;https://en.wikipedia.org/wiki/CSRF&gt;`_.</span>

<span class="sd">        CSRF protection is enabled by default and applies to *UNSAFE*</span>
<span class="sd">        HTTP methods as defined by :rfc:`7231` (all methods other than</span>
<span class="sd">        ``GET``, ``HEAD``, ``TRACE`` and ``OPTIONS``).</span>

<span class="sd">        CSRF protection is implemented by checking requests using</span>
<span class="sd">        unsafe methods for a value called ``csrf_token`` as part of</span>
<span class="sd">        the request&#39;s form data. That value is removed from the form</span>
<span class="sd">        as part of the validation and does not have to be taken in</span>
<span class="sd">        account by your own form processing.</span>

<span class="sd">        When adding a new controller for an unsafe method (mostly POST</span>
<span class="sd">        for e.g. forms):</span>

<span class="sd">        * if the form is generated in Python, a csrf token is</span>
<span class="sd">          available via :meth:`request.csrf_token()</span>
<span class="sd">          &lt;gerp.http.WebRequest.csrf_token`, the</span>
<span class="sd">          :data:`~gerp.http.request` object is available by default</span>
<span class="sd">          in QWeb (python) templates, it may have to be added</span>
<span class="sd">          explicitly if you are not using QWeb.</span>

<span class="sd">        * if the form is generated in Javascript, the CSRF token is</span>
<span class="sd">          added by default to the QWeb (js) rendering context as</span>
<span class="sd">          ``csrf_token`` and is otherwise available as ``csrf_token``</span>
<span class="sd">          on the ``web.core`` module:</span>

<span class="sd">          .. code-block:: javascript</span>

<span class="sd">              require(&#39;web.core&#39;).csrf_token</span>

<span class="sd">        * if the endpoint can be called by external parties (not from</span>
<span class="sd">          Odoo) as e.g. it is a REST API or a `webhook</span>
<span class="sd">          &lt;https://en.wikipedia.org/wiki/Webhook&gt;`_, CSRF protection</span>
<span class="sd">          must be disabled on the endpoint. If possible, you may want</span>
<span class="sd">          to implement other methods of request validation (to ensure</span>
<span class="sd">          it is not called by an unrelated third-party).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">routing</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">assert</span> <span class="s1">&#39;type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">routing</span> <span class="ow">or</span> <span class="n">routing</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">route</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">routes</span> <span class="o">=</span> <span class="n">route</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">routes</span> <span class="o">=</span> <span class="p">[</span><span class="n">route</span><span class="p">]</span>
            <span class="n">routing</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">routes</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">response_wrap</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">Response</span><span class="p">)</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">routing_type</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">response</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">text_type</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPException</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">wrappers</span><span class="o">.</span><span class="n">BaseResponse</span><span class="p">):</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="o">.</span><span class="n">force_type</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">set_default</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">response</span>

            <span class="n">_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;&lt;function </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&gt; returns an invalid response type for an http request&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="n">response_wrap</span><span class="o">.</span><span class="n">routing</span> <span class="o">=</span> <span class="n">routing</span>
        <span class="n">response_wrap</span><span class="o">.</span><span class="n">original_func</span> <span class="o">=</span> <span class="n">f</span>
        <span class="k">return</span> <span class="n">response_wrap</span>
    <span class="k">return</span> <span class="n">decorator</span></div>

<div class="viewcode-block" id="JsonRequest"><a class="viewcode-back" href="../../reference/http.html#gerp.http.JsonRequest">[docs]</a><span class="k">class</span> <span class="nc">JsonRequest</span><span class="p">(</span><span class="n">WebRequest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Request handler for `JSON-RPC 2</span>
<span class="sd">    &lt;http://www.jsonrpc.org/specification&gt;`_ over HTTP</span>

<span class="sd">    * ``method`` is ignored</span>
<span class="sd">    * ``params`` must be a JSON object (not an array) and is passed as keyword</span>
<span class="sd">      arguments to the handler method</span>
<span class="sd">    * the handler method&#39;s result is returned as JSON-RPC ``result`` and</span>
<span class="sd">      wrapped in the `JSON-RPC Response</span>
<span class="sd">      &lt;http://www.jsonrpc.org/specification#response_object&gt;`_</span>

<span class="sd">    Sucessful request::</span>

<span class="sd">      --&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;,</span>
<span class="sd">           &quot;method&quot;: &quot;call&quot;,</span>
<span class="sd">           &quot;params&quot;: {&quot;context&quot;: {},</span>
<span class="sd">                      &quot;arg1&quot;: &quot;val1&quot; },</span>
<span class="sd">           &quot;id&quot;: null}</span>

<span class="sd">      &lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;,</span>
<span class="sd">           &quot;result&quot;: { &quot;res1&quot;: &quot;val1&quot; },</span>
<span class="sd">           &quot;id&quot;: null}</span>

<span class="sd">    Request producing a error::</span>

<span class="sd">      --&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;,</span>
<span class="sd">           &quot;method&quot;: &quot;call&quot;,</span>
<span class="sd">           &quot;params&quot;: {&quot;context&quot;: {},</span>
<span class="sd">                      &quot;arg1&quot;: &quot;val1&quot; },</span>
<span class="sd">           &quot;id&quot;: null}</span>

<span class="sd">      &lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;,</span>
<span class="sd">           &quot;error&quot;: {&quot;code&quot;: 1,</span>
<span class="sd">                     &quot;message&quot;: &quot;End user error message.&quot;,</span>
<span class="sd">                     &quot;data&quot;: {&quot;code&quot;: &quot;codestring&quot;,</span>
<span class="sd">                              &quot;debug&quot;: &quot;traceback&quot; } },</span>
<span class="sd">           &quot;id&quot;: null}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_request_type</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">JsonRequest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">jsonp_handler</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">args</span>
        <span class="n">jsonp</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jsonp&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jsonp</span> <span class="o">=</span> <span class="n">jsonp</span>
        <span class="n">request</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">jsonp</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
            <span class="c1"># jsonp 2 steps step1 POST: save call</span>
            <span class="k">def</span> <span class="nf">handler</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;jsonp_request_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain; charset=utf-8&#39;</span><span class="p">)]</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">wrappers</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">r</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jsonp_handler</span> <span class="o">=</span> <span class="n">handler</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">jsonp</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>
            <span class="c1"># jsonp method GET</span>
            <span class="n">request</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">jsonp</span> <span class="ow">and</span> <span class="n">request_id</span><span class="p">:</span>
            <span class="c1"># jsonp 2 steps step2 GET: run and return result</span>
            <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;jsonp_request_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request_id</span><span class="p">,),</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># regular jsonrpc2</span>
            <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">charset</span><span class="p">)</span>

        <span class="c1"># Read POST content or POST Form Data named &quot;request&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jsonrequest</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Invalid JSON data: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">request</span><span class="p">,)</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsonrequest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;context&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">context</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_json_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;jsonrpc&#39;</span><span class="p">:</span> <span class="s1">&#39;2.0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">jsonrequest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jsonp</span><span class="p">:</span>
            <span class="c1"># If we use jsonp, that&#39;s mean we are called from another host</span>
            <span class="c1"># Some browser (IE and Safari) do no allow third party cookies</span>
            <span class="c1"># We need then to manage http sessions manually.</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;session_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">sid</span>
            <span class="n">mime</span> <span class="o">=</span> <span class="s1">&#39;application/javascript&#39;</span>
            <span class="n">body</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%s</span><span class="s2">);&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jsonp</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ustr</span><span class="p">),)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mime</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ustr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
                    <span class="n">body</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="n">mime</span><span class="p">),</span>
                                   <span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">))])</span>

    <span class="k">def</span> <span class="nf">_handle_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called within an except block to allow converting exceptions</span>
<span class="sd">           to arbitrary responses. Anything returned (except None) will</span>
<span class="sd">           be used as response.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">JsonRequest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_handle_exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="p">(</span><span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Warning</span><span class="p">,</span> <span class="n">SessionExpiredException</span><span class="p">,</span> <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">except_orm</span><span class="p">)):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception during JSON request handling.&quot;</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
                    <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s2">&quot;Odoo Server Error&quot;</span><span class="p">,</span>
                    <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">serialize_exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">AuthenticationError</span><span class="p">):</span>
                <span class="n">error</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
                <span class="n">error</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Odoo Session Invalid&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="n">SessionExpiredException</span><span class="p">):</span>
                <span class="n">error</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
                <span class="n">error</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Odoo Session Expired&quot;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_response</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jsonp_handler</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jsonp_handler</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rpc_request_flag</span> <span class="o">=</span> <span class="n">rpc_request</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="n">rpc_response_flag</span> <span class="o">=</span> <span class="n">rpc_response</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rpc_request_flag</span> <span class="ow">or</span> <span class="n">rpc_response_flag</span><span class="p">:</span>
                <span class="n">endpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="vm">__name__</span>
                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
                <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">)</span>
                <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;args&#39;</span><span class="p">,</span> <span class="p">[])</span>

                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">start_vms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">psutil</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">start_vms</span> <span class="o">=</span> <span class="n">memory_info</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>
                <span class="k">if</span> <span class="n">rpc_request</span> <span class="ow">and</span> <span class="n">rpc_response_flag</span><span class="p">:</span>
                    <span class="n">rpc_request</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">endpoint</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_function</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">rpc_request_flag</span> <span class="ow">or</span> <span class="n">rpc_response_flag</span><span class="p">:</span>
                <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">end_vms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">psutil</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">end_vms</span> <span class="o">=</span> <span class="n">memory_info</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>
                <span class="n">logline</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">: time:</span><span class="si">%.3f</span><span class="s1">s mem: </span><span class="si">%s</span><span class="s1">k -&gt; </span><span class="si">%s</span><span class="s1">k (diff: </span><span class="si">%s</span><span class="s1">k)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">endpoint</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">start_vms</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">end_vms</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">(</span><span class="n">end_vms</span> <span class="o">-</span> <span class="n">start_vms</span><span class="p">)</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rpc_response_flag</span><span class="p">:</span>
                    <span class="n">rpc_response</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">logline</span><span class="p">,</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rpc_request</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">logline</span><span class="p">)</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_response</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">serialize_exception</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span> <span class="k">else</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span>
        <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">ustr</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
        <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
        <span class="s2">&quot;exception_type&quot;</span><span class="p">:</span> <span class="s2">&quot;internal_error&quot;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">UserError</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;exception_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user_error&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Warning</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;exception_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;warning&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RedirectWarning</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;exception_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;warning&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">AccessError</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;exception_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;access_error&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">MissingError</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;exception_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;missing_error&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">AccessDenied</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;exception_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;access_denied&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;exception_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;validation_error&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">gerp</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">except_orm</span><span class="p">):</span>
        <span class="n">tmp</span><span class="p">[</span><span class="s2">&quot;exception_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;except_orm&quot;</span>
    <span class="k">return</span> <span class="n">tmp</span>

<div class="viewcode-block" id="HttpRequest"><a class="viewcode-back" href="../../reference/http.html#gerp.http.HttpRequest">[docs]</a><span class="k">class</span> <span class="nc">HttpRequest</span><span class="p">(</span><span class="n">WebRequest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Handler for the ``http`` request type.</span>

<span class="sd">    matched routing parameters, query string parameters, form_ parameters</span>
<span class="sd">    and files are passed to the handler method as keyword arguments.</span>

<span class="sd">    In case of name conflict, routing parameters have priority.</span>

<span class="sd">    The handler method&#39;s result can be:</span>

<span class="sd">    * a falsy value, in which case the HTTP response will be an</span>
<span class="sd">      `HTTP 204`_ (No Content)</span>
<span class="sd">    * a werkzeug Response object, which is returned as-is</span>
<span class="sd">    * a ``str`` or ``unicode``, will be wrapped in a Response object and</span>
<span class="sd">      interpreted as HTML</span>

<span class="sd">    .. _form: http://www.w3.org/TR/html401/interact/forms.html#h-17.13.4.2</span>
<span class="sd">    .. _HTTP 204: http://tools.ietf.org/html/rfc7231#section-6.3.5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_request_type</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HttpRequest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>

    <span class="k">def</span> <span class="nf">_handle_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called within an except block to allow converting exceptions</span>
<span class="sd">           to abitrary responses. Anything returned (except None) will</span>
<span class="sd">           be used as response.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">HttpRequest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_handle_exception</span><span class="p">(</span><span class="n">exception</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">SessionExpiredException</span><span class="p">:</span>
            <span class="n">redirect</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span>
            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">save_request_data</span><span class="p">()</span>
                <span class="n">redirect</span> <span class="o">=</span> <span class="s1">&#39;/web/proxy/post</span><span class="si">{r.full_path}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">req</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;noredirect&#39;</span><span class="p">):</span>
                <span class="n">redirect</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">url</span>
            <span class="k">if</span> <span class="n">redirect</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">url_encode</span><span class="p">({</span>
                    <span class="s1">&#39;redirect&#39;</span><span class="p">:</span> <span class="n">redirect</span><span class="p">,</span>
                <span class="p">})</span>
                <span class="k">return</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/web/login?</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span>

    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;OPTIONS&#39;</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">endpoint</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cors&#39;</span><span class="p">):</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;Access-Control-Max-Age&#39;</span><span class="p">:</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">,</span>
                <span class="s1">&#39;Access-Control-Allow-Headers&#39;</span><span class="p">:</span> <span class="s1">&#39;Origin, X-Requested-With, Content-Type, Accept, X-Debug-Mode&#39;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;HEAD&#39;</span><span class="p">,</span> <span class="s1">&#39;OPTIONS&#39;</span><span class="p">,</span> <span class="s1">&#39;TRACE&#39;</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;csrf&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span> <span class="c1"># csrf checked by default</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;csrf_token&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_csrf</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;CSRF validation failed on path &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
                                 <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;No CSRF validation token provided for path &#39;</span><span class="si">%s</span><span class="s2">&#39;</span>

<span class="s2">Odoo URLs are CSRF-protected by default (when accessed with unsafe</span>
<span class="s2">HTTP methods). See</span>
<span class="s2">https://www.gerp.com/documentation/9.0/reference/http.html#csrf for</span>
<span class="s2">more details.</span>

<span class="s2">* if this endpoint is accessed through Odoo via py-QWeb form, embed a CSRF</span>
<span class="s2">  token in the form, Tokens are available via `request.csrf_token()`</span>
<span class="s2">  can be provided through a hidden input and must be POST-ed named</span>
<span class="s2">  `csrf_token` e.g. in your form add:</span>

<span class="s2">      &lt;input type=&quot;hidden&quot; name=&quot;csrf_token&quot; t-att-value=&quot;request.csrf_token()&quot;/&gt;</span>

<span class="s2">* if the form is generated or posted in javascript, the token value is</span>
<span class="s2">  available as `csrf_token` on `web.core` and as the `csrf_token`</span>
<span class="s2">  value in the default js-qweb execution context</span>

<span class="s2">* if the form is accessed by an external third party (e.g. REST API</span>
<span class="s2">  endpoint, payment gateway callback) you will need to disable CSRF</span>
<span class="s2">  protection (and implement your own protection if necessary) by</span>
<span class="s2">  passing the `csrf=False` parameter to the `route` decorator.</span>
<span class="s2">                    &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

                <span class="k">raise</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">BadRequest</span><span class="p">(</span><span class="s1">&#39;Session expired (invalid CSRF token)&#39;</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_function</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="mi">204</span><span class="p">)</span>  <span class="c1"># no content</span>
        <span class="k">return</span> <span class="n">r</span>

<div class="viewcode-block" id="HttpRequest.make_response"><a class="viewcode-back" href="../../reference/http.html#gerp.http.HttpRequest.make_response">[docs]</a>    <span class="k">def</span> <span class="nf">make_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper for non-HTML responses, or HTML responses with custom</span>
<span class="sd">        response headers or cookies.</span>

<span class="sd">        While handlers can just return the HTML markup of a page they want to</span>
<span class="sd">        send as a string if non-HTML data is returned they need to create a</span>
<span class="sd">        complete response object, or the returned data will not be correctly</span>
<span class="sd">        interpreted by the clients.</span>

<span class="sd">        :param basestring data: response body</span>
<span class="sd">        :param headers: HTTP headers to set on the response</span>
<span class="sd">        :type headers: ``[(name, value)]``</span>
<span class="sd">        :param collections.Mapping cookies: cookies to set on the client</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cookies</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cookies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="HttpRequest.render"><a class="viewcode-back" href="../../reference/http.html#gerp.http.HttpRequest.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">qcontext</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Lazy render of a QWeb template.</span>

<span class="sd">        The actual rendering of the given template will occur at then end of</span>
<span class="sd">        the dispatching. Meanwhile, the template and/or qcontext can be</span>
<span class="sd">        altered or even replaced by a static response.</span>

<span class="sd">        :param basestring template: template to render</span>
<span class="sd">        :param dict qcontext: Rendering context to use</span>
<span class="sd">        :param bool lazy: whether the template rendering should be deferred</span>
<span class="sd">                          until the last possible moment</span>
<span class="sd">        :param kw: forwarded to werkzeug&#39;s Response object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">qcontext</span><span class="o">=</span><span class="n">qcontext</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lazy</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="HttpRequest.not_found"><a class="viewcode-back" href="../../reference/http.html#gerp.http.HttpRequest.not_found">[docs]</a>    <span class="k">def</span> <span class="nf">not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Shortcut for a `HTTP 404</span>
<span class="sd">        &lt;http://tools.ietf.org/html/rfc7231#section-6.5.4&gt;`_ (Not Found)</span>
<span class="sd">        response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">NotFound</span><span class="p">(</span><span class="n">description</span><span class="p">)</span></div></div>

<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># Controller and route registration</span>
<span class="c1">#----------------------------------------------------------</span>
<span class="n">addons_module</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">addons_manifest</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">controllers_per_module</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ControllerType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ControllerType</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>

        <span class="c1"># flag old-style methods with req as first argument</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;original_func&#39;</span><span class="p">):</span>
                <span class="c1"># Set routing type on original functions</span>
                <span class="n">routing_type</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">routing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="p">[</span><span class="n">claz</span> <span class="k">for</span> <span class="n">claz</span> <span class="ow">in</span> <span class="n">bases</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">claz</span><span class="p">,</span> <span class="n">ControllerType</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">claz</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span>
                <span class="n">parent_routing_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">original_func</span><span class="o">.</span><span class="n">routing_type</span> <span class="k">if</span> <span class="n">parent</span> <span class="k">else</span> <span class="n">routing_type</span> <span class="ow">or</span> <span class="s1">&#39;http&#39;</span>
                <span class="k">if</span> <span class="n">routing_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">routing_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">parent_routing_type</span><span class="p">:</span>
                    <span class="n">routing_type</span> <span class="o">=</span> <span class="n">parent_routing_type</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Subclass re-defines &lt;function </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&gt; with different type than original.&quot;</span>
                                    <span class="s2">&quot; Will use original type: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">parent_routing_type</span><span class="p">))</span>
                <span class="n">v</span><span class="o">.</span><span class="n">original_func</span><span class="o">.</span><span class="n">routing_type</span> <span class="o">=</span> <span class="n">routing_type</span> <span class="ow">or</span> <span class="n">parent_routing_type</span>

                <span class="n">spec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">original_func</span><span class="p">)</span>
                <span class="n">first_arg</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">first_arg</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;req&quot;</span><span class="p">,</span> <span class="s2">&quot;request&quot;</span><span class="p">]:</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">_first_arg_is_req</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># store the controller in the controllers list</span>
        <span class="n">name_class</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span> <span class="bp">cls</span><span class="p">)</span>
        <span class="n">class_path</span> <span class="o">=</span> <span class="n">name_class</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">class_path</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;gerp&quot;</span><span class="p">,</span> <span class="s2">&quot;addons&quot;</span><span class="p">]:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># we want to know all modules that have controllers</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">class_path</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># but we only store controllers directly inheriting from Controller</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;Controller&quot;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">Controller</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">controllers_per_module</span><span class="p">[</span><span class="n">module</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name_class</span><span class="p">)</span>

<span class="n">Controller</span> <span class="o">=</span> <span class="n">ControllerType</span><span class="p">(</span><span class="s1">&#39;Controller&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="p">{})</span>

<span class="k">class</span> <span class="nc">EndPoint</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">routing</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="s1">&#39;original_func&#39;</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routing</span> <span class="o">=</span> <span class="n">routing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">first_arg_is_req</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Backward for 7.0</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="s1">&#39;_first_arg_is_req&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">routing_map</span><span class="p">(</span><span class="n">modules</span><span class="p">,</span> <span class="n">nodb_only</span><span class="p">,</span> <span class="n">converters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">routing_map</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">routing</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">strict_slashes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">converters</span><span class="o">=</span><span class="n">converters</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_subclasses</span><span class="p">(</span><span class="n">klass</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">valid</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gerp.addons.&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="vm">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">modules</span>
        <span class="n">subclasses</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">subclass</span> <span class="ow">in</span> <span class="n">subclasses</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">valid</span><span class="p">(</span><span class="n">subclass</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">get_subclasses</span><span class="p">(</span><span class="n">subclass</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">valid</span><span class="p">(</span><span class="n">klass</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">klass</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">modules</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">controllers_per_module</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">controllers_per_module</span><span class="p">[</span><span class="n">module</span><span class="p">]:</span>
            <span class="n">subclasses</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">get_subclasses</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">subclasses</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (extended by </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subclasses</span><span class="p">))</span>
                <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">subclasses</span><span class="p">)),</span> <span class="p">{})</span>

            <span class="n">o</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
            <span class="n">members</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mv</span><span class="p">,</span> <span class="s1">&#39;routing&#39;</span><span class="p">):</span>
                    <span class="n">routing</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">routes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">methods_done</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                    <span class="c1"># update routing attributes from subclasses(auth, methods...)</span>
                    <span class="k">for</span> <span class="n">claz</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">mv</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">mro</span><span class="p">()):</span>
                        <span class="n">fn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">claz</span><span class="p">,</span> <span class="n">mv</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">fn</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;routing&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methods_done</span><span class="p">:</span>
                            <span class="n">methods_done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                            <span class="n">routing</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">routing</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">nodb_only</span> <span class="ow">or</span> <span class="n">routing</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">routing</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">],</span> <span class="s2">&quot;Method </span><span class="si">%r</span><span class="s2"> has not route defined&quot;</span> <span class="o">%</span> <span class="n">mv</span>
                        <span class="n">endpoint</span> <span class="o">=</span> <span class="n">EndPoint</span><span class="p">(</span><span class="n">mv</span><span class="p">,</span> <span class="n">routing</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">routing</span><span class="p">[</span><span class="s1">&#39;routes&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">routing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;combine&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                                <span class="c1"># deprecated v7 declaration</span>
                                <span class="n">url</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">_cp_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">url</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">[:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                            <span class="n">xtra_keys</span> <span class="o">=</span> <span class="s1">&#39;defaults subdomain build_only strict_slashes redirect_to alias host&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                            <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">routing</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">xtra_keys</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">routing</span><span class="p">}</span>
                            <span class="n">routing_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">werkzeug</span><span class="o">.</span><span class="n">routing</span><span class="o">.</span><span class="n">Rule</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="n">routing</span><span class="p">[</span><span class="s1">&#39;methods&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">kw</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">routing_map</span>

<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># HTTP Sessions</span>
<span class="c1">#----------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">AuthenticationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">SessionExpiredException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">OpenERPSession</span><span class="p">(</span><span class="n">werkzeug</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">Session</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inited</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotate</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">OpenERPSession</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inited</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_values</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;inited&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">object</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="nb">object</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">login</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticate the current user with the given db, login and</span>
<span class="sd">        password. If successful, store the authentication parameters in the</span>
<span class="sd">        current session and request.</span>

<span class="sd">        :param uid: If not None, that user id will be used instead the login</span>
<span class="sd">                    to authenticate the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">uid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wsgienv</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span>
            <span class="n">env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">base_location</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">url_root</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">),</span>
                <span class="n">HTTP_HOST</span><span class="o">=</span><span class="n">wsgienv</span><span class="p">[</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="p">],</span>
                <span class="n">REMOTE_ADDR</span><span class="o">=</span><span class="n">wsgienv</span><span class="p">[</span><span class="s1">&#39;REMOTE_ADDR&#39;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="n">dispatch_rpc</span><span class="p">(</span><span class="s1">&#39;common&#39;</span><span class="p">,</span> <span class="s1">&#39;authenticate&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">db</span><span class="p">,</span> <span class="n">login</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">env</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">security</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">login</span> <span class="o">=</span> <span class="n">login</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="n">request</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span>
        <span class="n">request</span><span class="o">.</span><span class="n">disable_db</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">uid</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">uid</span>

    <span class="k">def</span> <span class="nf">check_security</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the current authentication parameters to know if those are still</span>
<span class="sd">        valid. This method should be called at each request. If the</span>
<span class="sd">        authentication fails, a :exc:`SessionExpiredException` is raised.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SessionExpiredException</span><span class="p">(</span><span class="s2">&quot;Session expired&quot;</span><span class="p">)</span>
        <span class="n">security</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_db</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">keep_db</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;db&#39;</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_values</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotate</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_default_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;login&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">def</span> <span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Re-initializes the current user&#39;s session context (based on his</span>
<span class="sd">        preferences) by calling res.users.get_context() with the old context.</span>

<span class="sd">        :returns: the new context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span><span class="p">,</span> <span class="s2">&quot;The user needs to be logged-in to initialize his context&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">context_get</span><span class="p">()</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fix_lang</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>

    <span class="k">def</span> <span class="nf">_fix_lang</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; OpenERP provides languages which may not make sense and/or may not</span>
<span class="sd">        be understood by the web client&#39;s libraries.</span>

<span class="sd">        Fix those here.</span>

<span class="sd">        :param dict context: context to fix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span>

        <span class="c1"># inane OpenERP locale</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="o">==</span> <span class="s1">&#39;ar_AR&#39;</span><span class="p">:</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="s1">&#39;ar&#39;</span>

        <span class="c1"># lang to lang_REGION (datejs only handles lang_REGION, no bare langs)</span>
        <span class="k">if</span> <span class="n">lang</span> <span class="ow">in</span> <span class="n">babel</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LOCALE_ALIASES</span><span class="p">:</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">babel</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LOCALE_ALIASES</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lang</span> <span class="ow">or</span> <span class="s1">&#39;en_US&#39;</span>

    <span class="k">def</span> <span class="nf">save_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method store an action object in the session and returns an integer</span>
<span class="sd">        identifying that action. The method get_action() can be used to get</span>
<span class="sd">        back the action.</span>

<span class="sd">        :param the_action: The action to save in the session.</span>
<span class="sd">        :type the_action: anything</span>
<span class="sd">        :return: A key identifying the saved action.</span>
<span class="sd">        :rtype: integer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">saved_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;saved_actions&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;next&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;actions&quot;</span><span class="p">:</span> <span class="p">{}})</span>
        <span class="c1"># we don&#39;t allow more than 10 stored actions</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">saved_actions</span><span class="p">[</span><span class="s2">&quot;actions&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">saved_actions</span><span class="p">[</span><span class="s2">&quot;actions&quot;</span><span class="p">][</span><span class="nb">min</span><span class="p">(</span><span class="n">saved_actions</span><span class="p">[</span><span class="s2">&quot;actions&quot;</span><span class="p">])]</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">saved_actions</span><span class="p">[</span><span class="s2">&quot;next&quot;</span><span class="p">]</span>
        <span class="n">saved_actions</span><span class="p">[</span><span class="s2">&quot;actions&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">action</span>
        <span class="n">saved_actions</span><span class="p">[</span><span class="s2">&quot;next&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">key</span>

    <span class="k">def</span> <span class="nf">get_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets back a previously saved action. This method can return None if the action</span>
<span class="sd">        was saved since too much time (this case should be handled in a smart way).</span>

<span class="sd">        :param key: The key given by save_action()</span>
<span class="sd">        :type key: integer</span>
<span class="sd">        :return: The saved action or None.</span>
<span class="sd">        :rtype: anything</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">saved_actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;saved_actions&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="n">saved_actions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;actions&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_request_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">uuid</span>
        <span class="n">req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">datastructures</span><span class="o">.</span><span class="n">MultiDict</span><span class="p">()</span>
        <span class="c1"># NOTE we do not store files in the session itself to avoid loading them in memory.</span>
        <span class="c1">#      By storing them in the session store, we ensure every worker (even ones on other</span>
        <span class="c1">#      servers) can access them. It also allow stale files to be deleted by `session_gc`.</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">storename</span> <span class="o">=</span> <span class="s1">&#39;werkzeug_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">.file&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">storename</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
            <span class="n">files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">storename</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">content_type</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;serialized_request_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">form</span><span class="p">,</span>
            <span class="s1">&#39;files&#39;</span><span class="p">:</span> <span class="n">files</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">load_request_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;serialized_request_data&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">datastructures</span><span class="o">.</span><span class="n">MultiDict</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="c1"># regenerate files filenames with the current session store</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">storename</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">content_type</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">storename</span><span class="p">)</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">content_type</span><span class="p">))</span>
                <span class="k">yield</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">datastructures</span><span class="o">.</span><span class="n">CombinedMultiDict</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;form&#39;</span><span class="p">],</span> <span class="n">files</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="kc">None</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># cleanup files</span>
            <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">session_gc</span><span class="p">(</span><span class="n">session_store</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span>
        <span class="c1"># we keep session one week</span>
        <span class="n">last_week</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">session_store</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_store</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">last_week</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>

<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># WSGI Layer</span>
<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># Add potentially missing (older ubuntu) font mime types</span>
<span class="n">mimetypes</span><span class="o">.</span><span class="n">add_type</span><span class="p">(</span><span class="s1">&#39;application/font-woff&#39;</span><span class="p">,</span> <span class="s1">&#39;.woff&#39;</span><span class="p">)</span>
<span class="n">mimetypes</span><span class="o">.</span><span class="n">add_type</span><span class="p">(</span><span class="s1">&#39;application/vnd.ms-fontobject&#39;</span><span class="p">,</span> <span class="s1">&#39;.eot&#39;</span><span class="p">)</span>
<span class="n">mimetypes</span><span class="o">.</span><span class="n">add_type</span><span class="p">(</span><span class="s1">&#39;application/x-font-ttf&#39;</span><span class="p">,</span> <span class="s1">&#39;.ttf&#39;</span><span class="p">)</span>
<span class="c1"># Add potentially missing (detected on windows) svg mime types</span>
<span class="n">mimetypes</span><span class="o">.</span><span class="n">add_type</span><span class="p">(</span><span class="s1">&#39;image/svg+xml&#39;</span><span class="p">,</span> <span class="s1">&#39;.svg&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Response"><a class="viewcode-back" href="../../reference/http.html#gerp.http.Response">[docs]</a><span class="k">class</span> <span class="nc">Response</span><span class="p">(</span><span class="n">werkzeug</span><span class="o">.</span><span class="n">wrappers</span><span class="o">.</span><span class="n">Response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Response object passed through controller route chain.</span>

<span class="sd">    In addition to the :class:`werkzeug.wrappers.Response` parameters, this</span>
<span class="sd">    class&#39;s constructor can take the following additional parameters</span>
<span class="sd">    for QWeb Lazy Rendering.</span>

<span class="sd">    :param basestring template: template to render</span>
<span class="sd">    :param dict qcontext: Rendering context to use</span>
<span class="sd">    :param int uid: User id to use for the ir.ui.view render call,</span>
<span class="sd">                    ``None`` to use the request&#39;s user (the default)</span>

<span class="sd">    these attributes are available as parameters on the Response object and</span>
<span class="sd">    can be altered at any time before rendering</span>

<span class="sd">    Also exposes all the attributes and methods of</span>
<span class="sd">    :class:`werkzeug.wrappers.Response`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">default_mimetype</span> <span class="o">=</span> <span class="s1">&#39;text/html&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">qcontext</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;qcontext&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_default</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">qcontext</span><span class="p">,</span> <span class="n">uid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qcontext</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qcontext</span> <span class="o">=</span> <span class="n">qcontext</span> <span class="ow">or</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span>
        <span class="c1"># Support for Cross-Origin Resource Sharing</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">endpoint</span> <span class="ow">and</span> <span class="s1">&#39;cors&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span><span class="p">[</span><span class="s1">&#39;cors&#39;</span><span class="p">])</span>
            <span class="n">methods</span> <span class="o">=</span> <span class="s1">&#39;GET, POST&#39;</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                <span class="n">methods</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span>
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;methods&#39;</span><span class="p">):</span>
                <span class="n">methods</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">endpoint</span><span class="o">.</span><span class="n">routing</span><span class="p">[</span><span class="s1">&#39;methods&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_qweb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<div class="viewcode-block" id="Response.render"><a class="viewcode-back" href="../../reference/http.html#gerp.http.Response.render">[docs]</a>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Renders the Response&#39;s template, returns the result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uid</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">uid</span> <span class="ow">or</span> <span class="n">gerp</span><span class="o">.</span><span class="n">SUPERUSER_ID</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qcontext</span><span class="p">[</span><span class="s1">&#39;request&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span>
        <span class="k">return</span> <span class="n">env</span><span class="p">[</span><span class="s2">&quot;ir.ui.view&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qcontext</span><span class="p">)</span></div>

<div class="viewcode-block" id="Response.flatten"><a class="viewcode-back" href="../../reference/http.html#gerp.http.Response.flatten">[docs]</a>    <span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Forces the rendering of the response&#39;s template, sets the result</span>
<span class="sd">        as response body and unsets :attr:`.template`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="kc">None</span></div></div>

<span class="k">class</span> <span class="nc">DisableCacheMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">start_wrapped</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">):</span>
            <span class="n">referer</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_REFERER&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="n">url_parse</span><span class="p">(</span><span class="n">referer</span><span class="p">)</span>
            <span class="n">debug</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>

            <span class="n">new_headers</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">unwanted_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Last-Modified&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">new_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Cache-Control&#39;</span><span class="p">,</span> <span class="s1">&#39;no-cache&#39;</span><span class="p">)]</span>
                <span class="n">unwanted_keys</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;Expires&#39;</span><span class="p">,</span> <span class="s1">&#39;Etag&#39;</span><span class="p">,</span> <span class="s1">&#39;Cache-Control&#39;</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unwanted_keys</span><span class="p">:</span>
                    <span class="n">new_headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

            <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">new_headers</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_wrapped</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Root</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Root WSGI application for the OpenERP Web Client.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">session_store</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Setup http sessions</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">session_dir</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;HTTP sessions stored in: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">contrib</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">FilesystemSessionStore</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">session_class</span><span class="o">=</span><span class="n">OpenERPSession</span><span class="p">)</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">nodb_routing_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating nondb routing&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">routing_map</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">gerp</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">server_wide_modules</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Handle a WSGI request</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loaded</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_addons</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_addons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Load all addons from addons path containing static files and</span>
<span class="sd">        controllers and configure them.  &quot;&quot;&quot;</span>
        <span class="c1"># TODO should we move this to ir.http so that only configured modules are served ?</span>
        <span class="n">statics</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">addons_path</span> <span class="ow">in</span> <span class="n">gerp</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">ad_paths</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">addons_path</span><span class="p">))):</span>
                <span class="k">if</span> <span class="n">module</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">addons_module</span><span class="p">:</span>
                    <span class="n">mod_path</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">addons_path</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
                    <span class="n">manifest_path</span> <span class="o">=</span> <span class="n">module_manifest</span><span class="p">(</span><span class="n">mod_path</span><span class="p">)</span>
                    <span class="n">path_static</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">addons_path</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">manifest_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path_static</span><span class="p">):</span>
                        <span class="n">manifest_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">manifest_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">manifest</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">pycompat</span><span class="o">.</span><span class="n">to_native</span><span class="p">(</span><span class="n">manifest_data</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">manifest</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;installable&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="n">manifest</span><span class="p">[</span><span class="s1">&#39;addons_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">addons_path</span>
                        <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Loading </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">module</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;gerp.addons&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
                            <span class="n">m</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="s1">&#39;gerp.addons.&#39;</span> <span class="o">+</span> <span class="n">module</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">m</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">addons_module</span><span class="p">[</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span>
                        <span class="n">addons_manifest</span><span class="p">[</span><span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="n">manifest</span>
                        <span class="n">statics</span><span class="p">[</span><span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">/static&#39;</span> <span class="o">%</span> <span class="n">module</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_static</span>

        <span class="k">if</span> <span class="n">statics</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;HTTP Configuring static files&quot;</span><span class="p">)</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">wsgi</span><span class="o">.</span><span class="n">SharedDataMiddleware</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">,</span> <span class="n">statics</span><span class="p">,</span> <span class="n">cache_timeout</span><span class="o">=</span><span class="n">STATIC_CACHE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span> <span class="o">=</span> <span class="n">DisableCacheMiddleware</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">httprequest</span><span class="p">):</span>
        <span class="c1"># recover or create session</span>
        <span class="n">session_gc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_store</span><span class="p">)</span>

        <span class="n">sid</span> <span class="o">=</span> <span class="n">httprequest</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">)</span>
        <span class="n">explicit_session</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sid</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span>  <span class="n">httprequest</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;X-Openerp-Session-Id&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sid</span><span class="p">:</span>
            <span class="n">sid</span> <span class="o">=</span> <span class="n">httprequest</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;session_id&#39;</span><span class="p">)</span>
            <span class="n">explicit_session</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">sid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">httprequest</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">httprequest</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">explicit_session</span>

    <span class="k">def</span> <span class="nf">setup_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">httprequest</span><span class="p">):</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">httprequest</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">db</span>
        <span class="c1"># Check if session.db is legit</span>
        <span class="k">if</span> <span class="n">db</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">db</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">db_filter</span><span class="p">([</span><span class="n">db</span><span class="p">],</span> <span class="n">httprequest</span><span class="o">=</span><span class="n">httprequest</span><span class="p">):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Logged into database &#39;</span><span class="si">%s</span><span class="s2">&#39;, but dbfilter &quot;</span>
                             <span class="s2">&quot;rejects it; logging session out.&quot;</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
                <span class="n">httprequest</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
                <span class="n">db</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span>
            <span class="n">httprequest</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db_monodb</span><span class="p">(</span><span class="n">httprequest</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup_lang</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">httprequest</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;lang&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">httprequest</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
            <span class="n">alang</span> <span class="o">=</span> <span class="n">httprequest</span><span class="o">.</span><span class="n">accept_languages</span><span class="o">.</span><span class="n">best</span> <span class="ow">or</span> <span class="s2">&quot;en-US&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">code</span><span class="p">,</span> <span class="n">territory</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">babel</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">parse_locale</span><span class="p">(</span><span class="n">alang</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">territory</span><span class="p">:</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">territory</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lang</span> <span class="o">=</span> <span class="n">babel</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">LOCALE_ALIASES</span><span class="p">[</span><span class="n">code</span><span class="p">]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="s1">&#39;en_US&#39;</span>
            <span class="n">httprequest</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;lang&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lang</span>

    <span class="k">def</span> <span class="nf">get_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">httprequest</span><span class="p">):</span>
        <span class="c1"># deduce type of request</span>
        <span class="k">if</span> <span class="n">httprequest</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jsonp&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonRequest</span><span class="p">(</span><span class="n">httprequest</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">httprequest</span><span class="o">.</span><span class="n">mimetype</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="s2">&quot;application/json-rpc&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JsonRequest</span><span class="p">(</span><span class="n">httprequest</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpRequest</span><span class="p">(</span><span class="n">httprequest</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">httprequest</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">explicit_session</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">Response</span><span class="p">)</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">is_qweb</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;ir.http&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">text_type</span><span class="p">)):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;text/html&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">result</span>

        <span class="c1"># save to cache if requested and possible</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;cache_save&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">response</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">request</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">request</span><span class="o">.</span><span class="n">cache_save</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="s1">&#39;mimetype&#39;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="p">}</span>

        <span class="k">if</span> <span class="n">httprequest</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">should_save</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">httprequest</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rotate</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">httprequest</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
                <span class="n">httprequest</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">generate_key</span><span class="p">()</span>
                <span class="n">httprequest</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">httprequest</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
        <span class="c1"># We must not set the cookie if the session id was specified using a http header or a GET parameter.</span>
        <span class="c1"># There are two reasons to this:</span>
        <span class="c1"># - When using one of those two means we consider that we are overriding the cookie, which means creating a new</span>
        <span class="c1">#   session on top of an already existing session and we don&#39;t want to create a mess with the &#39;normal&#39; session</span>
        <span class="c1">#   (the one using the cookie). That is a special feature of the Session Javascript class.</span>
        <span class="c1"># - It could allow session fixation attacks.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">explicit_session</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;set_cookie&#39;</span><span class="p">):</span>
            <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
                <span class="s1">&#39;session_id&#39;</span><span class="p">,</span> <span class="n">httprequest</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">sid</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">90</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs the actual WSGI dispatching for the application.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">httprequest</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">wrappers</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
            <span class="n">httprequest</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">httprequest</span><span class="o">.</span><span class="n">parameter_storage_class</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">datastructures</span><span class="o">.</span><span class="n">ImmutableOrderedMultiDict</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">httprequest</span><span class="o">.</span><span class="n">url</span>

            <span class="n">explicit_session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_session</span><span class="p">(</span><span class="n">httprequest</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_db</span><span class="p">(</span><span class="n">httprequest</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_lang</span><span class="p">(</span><span class="n">httprequest</span><span class="p">)</span>

            <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_request</span><span class="p">(</span><span class="n">httprequest</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">_dispatch_nodb</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">func</span><span class="p">,</span> <span class="n">arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodb_routing_map</span><span class="o">.</span><span class="n">bind_to_environ</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">_handle_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">request</span><span class="o">.</span><span class="n">set_handler</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">dispatch</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="k">with</span> <span class="n">request</span><span class="p">:</span>
                <span class="n">db</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">db</span>
                <span class="k">if</span> <span class="n">db</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">gerp</span><span class="o">.</span><span class="n">registry</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">check_signaling</span><span class="p">()</span>
                        <span class="k">with</span> <span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">mute_logger</span><span class="p">(</span><span class="s1">&#39;gerp.sql_db&#39;</span><span class="p">):</span>
                            <span class="n">ir_http</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;ir.http&#39;</span><span class="p">]</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">OperationalError</span><span class="p">,</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">ProgrammingError</span><span class="p">):</span>
                        <span class="c1"># psycopg2 error or attribute error while constructing</span>
                        <span class="c1"># the registry. That means either</span>
                        <span class="c1"># - the database probably does not exists anymore</span>
                        <span class="c1"># - the database is corrupted</span>
                        <span class="c1"># - the database version doesnt match the server version</span>
                        <span class="c1"># Log the user out and fall back to nodb</span>
                        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
                        <span class="c1"># If requesting /web this will loop</span>
                        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;/web&#39;</span><span class="p">:</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;/web/database/selector&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">_dispatch_nodb</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">ir_http</span><span class="o">.</span><span class="n">_dispatch</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">_dispatch_nodb</span><span class="p">()</span>

                <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">httprequest</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">explicit_session</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_db_router</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">db</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodb_routing_map</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">registry</span><span class="p">[</span><span class="s1">&#39;ir.http&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">routing_map</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">db_list</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">httprequest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">dbs</span> <span class="o">=</span> <span class="n">gerp</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">list_dbs</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db_filter</span><span class="p">(</span><span class="n">dbs</span><span class="p">,</span> <span class="n">httprequest</span><span class="o">=</span><span class="n">httprequest</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">db_filter</span><span class="p">(</span><span class="n">dbs</span><span class="p">,</span> <span class="n">httprequest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">httprequest</span> <span class="o">=</span> <span class="n">httprequest</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;HTTP_HOST&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">d</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">r</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s2">&quot;www&quot;</span> <span class="ow">and</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dbfilter&#39;</span><span class="p">]:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dbfilter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%h&#39;</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">dbs</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dbs</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;db_name&#39;</span><span class="p">]:</span>
        <span class="c1"># In case --db-filter is not provided and --database is passed, Odoo will</span>
        <span class="c1"># use the value of --database as a comma seperated list of exposed databases.</span>
        <span class="n">exposed_dbs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;db_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
        <span class="n">dbs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">exposed_dbs</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">dbs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dbs</span>

<span class="k">def</span> <span class="nf">db_monodb</span><span class="p">(</span><span class="n">httprequest</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Magic function to find the current database.</span>

<span class="sd">        Implementation details:</span>

<span class="sd">        * Magic</span>
<span class="sd">        * More magic</span>

<span class="sd">        Returns ``None`` if the magic is not magic enough.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">httprequest</span> <span class="o">=</span> <span class="n">httprequest</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span>

    <span class="n">dbs</span> <span class="o">=</span> <span class="n">db_list</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">httprequest</span><span class="p">)</span>

    <span class="c1"># try the db already in the session</span>
    <span class="n">db_session</span> <span class="o">=</span> <span class="n">httprequest</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">db</span>
    <span class="k">if</span> <span class="n">db_session</span> <span class="ow">in</span> <span class="n">dbs</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">db_session</span>

    <span class="c1"># if there is only one possible db, we take that one</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dbs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dbs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="kc">None</span>

<span class="k">def</span> <span class="nf">send_file</span><span class="p">(</span><span class="n">filepath_or_fp</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mtime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">add_etags</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache_timeout</span><span class="o">=</span><span class="n">STATIC_CACHE</span><span class="p">,</span> <span class="n">conditional</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This is a modified version of Flask&#39;s send_file()</span>

<span class="sd">    Sends the contents of a file to the client. This will use the</span>
<span class="sd">    most efficient method available and configured.  By default it will</span>
<span class="sd">    try to use the WSGI server&#39;s file_wrapper support.</span>

<span class="sd">    By default it will try to guess the mimetype for you, but you can</span>
<span class="sd">    also explicitly provide one.  For extra security you probably want</span>
<span class="sd">    to send certain files as attachment (HTML for instance).  The mimetype</span>
<span class="sd">    guessing requires a `filename` or an `attachment_filename` to be</span>
<span class="sd">    provided.</span>

<span class="sd">    Please never pass filenames to this function from user sources without</span>
<span class="sd">    checking them first.</span>

<span class="sd">    :param filepath_or_fp: the filename of the file to send.</span>
<span class="sd">                           Alternatively a file object might be provided</span>
<span class="sd">                           in which case `X-Sendfile` might not work and</span>
<span class="sd">                           fall back to the traditional method.  Make sure</span>
<span class="sd">                           that the file pointer is positioned at the start</span>
<span class="sd">                           of data to send before calling :func:`send_file`.</span>
<span class="sd">    :param mimetype: the mimetype of the file if provided, otherwise</span>
<span class="sd">                     auto detection happens.</span>
<span class="sd">    :param as_attachment: set to `True` if you want to send this file with</span>
<span class="sd">                          a ``Content-Disposition: attachment`` header.</span>
<span class="sd">    :param filename: the filename for the attachment if it differs from the file&#39;s filename or</span>
<span class="sd">                     if using file object without &#39;name&#39; attribute (eg: E-tags with StringIO).</span>
<span class="sd">    :param mtime: last modification time to use for contitional response.</span>
<span class="sd">    :param add_etags: set to `False` to disable attaching of etags.</span>
<span class="sd">    :param conditional: set to `False` to disable conditional responses.</span>

<span class="sd">    :param cache_timeout: the timeout in seconds for the headers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filepath_or_fp</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filepath_or_fp</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath_or_fp</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mtime</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">filepath_or_fp</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">filepath_or_fp</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mimetype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">filename</span><span class="p">:</span>
        <span class="n">mimetype</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mimetype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mimetype</span> <span class="o">=</span> <span class="s1">&#39;application/octet-stream&#39;</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="n">werkzeug</span><span class="o">.</span><span class="n">datastructures</span><span class="o">.</span><span class="n">Headers</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">as_attachment</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;filename unavailable, required for sending as attachment&#39;</span><span class="p">)</span>
        <span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">,</span> <span class="s1">&#39;attachment&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">size</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">wrap_file</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">environ</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="n">mimetype</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                                    <span class="n">direct_passthrough</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mtime</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">server_format</span> <span class="o">=</span> <span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">DEFAULT_SERVER_DATETIME_FORMAT</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">mtime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">server_format</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">mtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">last_modified</span> <span class="o">=</span> <span class="n">mtime</span>

    <span class="n">rv</span><span class="o">.</span><span class="n">cache_control</span><span class="o">.</span><span class="n">public</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">cache_timeout</span><span class="p">:</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">cache_control</span><span class="o">.</span><span class="n">max_age</span> <span class="o">=</span> <span class="n">cache_timeout</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">expires</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">cache_timeout</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">add_etags</span> <span class="ow">and</span> <span class="n">filename</span> <span class="ow">and</span> <span class="n">mtime</span><span class="p">:</span>
        <span class="n">rv</span><span class="o">.</span><span class="n">set_etag</span><span class="p">(</span><span class="s1">&#39;gerp-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">mtime</span><span class="p">,</span>
            <span class="n">size</span><span class="p">,</span>
            <span class="n">adler32</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">text_type</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">filename</span>
            <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
        <span class="p">))</span>
        <span class="k">if</span> <span class="n">conditional</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">make_conditional</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="p">)</span>
            <span class="c1"># make sure we don&#39;t send x-sendfile for servers that</span>
            <span class="c1"># ignore the 304 status code for x-sendfile.</span>
            <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">304</span><span class="p">:</span>
                <span class="n">rv</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;x-sendfile&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rv</span>

<span class="k">def</span> <span class="nf">content_disposition</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">gerp</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">escaped</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="n">url_quote</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
    <span class="n">browser</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">user_agent</span><span class="o">.</span><span class="n">browser</span>
    <span class="n">version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">request</span><span class="o">.</span><span class="n">httprequest</span><span class="o">.</span><span class="n">user_agent</span><span class="o">.</span><span class="n">version</span> <span class="ow">or</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">browser</span> <span class="o">==</span> <span class="s1">&#39;msie&#39;</span> <span class="ow">and</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;attachment; filename=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">escaped</span>
    <span class="k">elif</span> <span class="n">browser</span> <span class="o">==</span> <span class="s1">&#39;safari&#39;</span> <span class="ow">and</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="mi">537</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">u</span><span class="s2">&quot;attachment; filename=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;attachment; filename*=UTF-8&#39;&#39;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">escaped</span>

<span class="c1">#----------------------------------------------------------</span>
<span class="c1"># RPC controller</span>
<span class="c1">#----------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">CommonController</span><span class="p">(</span><span class="n">Controller</span><span class="p">):</span>

    <span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/jsonrpc&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">jsonrpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method used by client APIs to contact OpenERP. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dispatch_rpc</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="nd">@route</span><span class="p">(</span><span class="s1">&#39;/gen_session_id&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">gen_session_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nsession</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">session_store</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">nsession</span><span class="o">.</span><span class="n">sid</span>

<span class="c1">#  main wsgi handler</span>
<span class="n">root</span> <span class="o">=</span> <span class="n">Root</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Gahan Corporation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>