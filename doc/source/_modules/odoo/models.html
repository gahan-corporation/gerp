
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>gerp.models &#8212; gerp 0.0.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for gerp.models</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Part of Odoo. See LICENSE file for full copyright and licensing details.</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object Relational Mapping module:</span>
<span class="sd">     * Hierarchical structure</span>
<span class="sd">     * Constraints consistency and validation</span>
<span class="sd">     * Object metadata depends on its status</span>
<span class="sd">     * Optimised processing by complex query (multiple actions at once)</span>
<span class="sd">     * Default field values</span>
<span class="sd">     * Permissions optimisation</span>
<span class="sd">     * Persistant object: DB postgresql</span>
<span class="sd">     * Data conversion</span>
<span class="sd">     * Multi-level caching system</span>
<span class="sd">     * Two different inheritance mechanisms</span>
<span class="sd">     * Rich set of field types:</span>
<span class="sd">          - classical (varchar, integer, boolean, ...)</span>
<span class="sd">          - relational (one2many, many2one, many2many)</span>
<span class="sd">          - functional</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">dateutil</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">MutableMapping</span><span class="p">,</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">closing</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="k">import</span> <span class="n">getmembers</span><span class="p">,</span> <span class="n">currentframe</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">attrgetter</span><span class="p">,</span> <span class="n">itemgetter</span>

<span class="kn">import</span> <span class="nn">babel.dates</span>
<span class="kn">import</span> <span class="nn">dateutil.relativedelta</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="k">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">lxml.builder</span> <span class="k">import</span> <span class="n">E</span>

<span class="kn">import</span> <span class="nn">gerp</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">SUPERUSER_ID</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">tools</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="k">import</span> <span class="n">AccessError</span><span class="p">,</span> <span class="n">MissingError</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="n">UserError</span>
<span class="kn">from</span> <span class="nn">.osv.query</span> <span class="k">import</span> <span class="n">Query</span>
<span class="kn">from</span> <span class="nn">.tools</span> <span class="k">import</span> <span class="n">frozendict</span><span class="p">,</span> <span class="n">lazy_classproperty</span><span class="p">,</span> <span class="n">lazy_property</span><span class="p">,</span> <span class="n">ormcache</span><span class="p">,</span> \
                   <span class="n">Collector</span><span class="p">,</span> <span class="n">LastOrderedSet</span><span class="p">,</span> <span class="n">OrderedSet</span><span class="p">,</span> <span class="n">pycompat</span>
<span class="kn">from</span> <span class="nn">.tools.config</span> <span class="k">import</span> <span class="n">config</span>
<span class="kn">from</span> <span class="nn">.tools.func</span> <span class="k">import</span> <span class="n">frame_codeinfo</span>
<span class="kn">from</span> <span class="nn">.tools.misc</span> <span class="k">import</span> <span class="n">CountingStream</span><span class="p">,</span> <span class="n">DEFAULT_SERVER_DATETIME_FORMAT</span><span class="p">,</span> <span class="n">DEFAULT_SERVER_DATE_FORMAT</span>
<span class="kn">from</span> <span class="nn">.tools.safe_eval</span> <span class="k">import</span> <span class="n">safe_eval</span>
<span class="kn">from</span> <span class="nn">.tools.translate</span> <span class="k">import</span> <span class="n">_</span>

<span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">_schema</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;.schema&#39;</span><span class="p">)</span>
<span class="n">_unlink</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;.unlink&#39;</span><span class="p">)</span>

<span class="n">regex_order</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;^(\s*([a-z0-9:_]+|&quot;[a-z0-9:_]+&quot;)(\s+(desc|asc))?\s*(,|$))+(?&lt;!,)$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
<span class="n">regex_object_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-z0-9_.]+$&#39;</span><span class="p">)</span>
<span class="n">regex_pg_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[a-z_][a-z0-9_$]*$&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>
<span class="n">onchange_v7</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(\w+)\((.*)\)$&quot;</span><span class="p">)</span>

<span class="n">AUTOINIT_RECALCULATE_STORED_FIELDS</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="k">def</span> <span class="nf">check_object_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check if the given name is a valid model name.</span>

<span class="sd">        The _name attribute in osv and osv_memory object is subject to</span>
<span class="sd">        some restrictions. This function returns True or False whether</span>
<span class="sd">        the given name is allowed or not.</span>

<span class="sd">        TODO: this is an approximation. The goal in this approximation</span>
<span class="sd">        is to disallow uppercase characters (in some places, we quote</span>
<span class="sd">        table/column names and in other not, which leads to this kind</span>
<span class="sd">        of errors:</span>

<span class="sd">            psycopg2.ProgrammingError: relation &quot;xxx&quot; does not exist).</span>

<span class="sd">        The same restriction should apply to both osv and osv_memory</span>
<span class="sd">        objects for consistency.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">regex_object_name</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">raise_on_invalid_object_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_object_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The _name attribute </span><span class="si">%s</span><span class="s2"> is not valid.&quot;</span> <span class="o">%</span> <span class="n">name</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_pg_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Check whether the given name is a valid PostgreSQL identifier name. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">regex_pg_name</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Invalid characters in table name </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Table name </span><span class="si">%r</span><span class="s2"> is too long&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

<span class="c1"># match private methods, to prevent their remote invocation</span>
<span class="n">regex_private</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(_.*|init)$&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_method_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Raise an ``AccessError`` if ``name`` is a private method name. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">regex_private</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Private methods (such as </span><span class="si">%s</span><span class="s1">) cannot be called remotely.&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,))</span>

<span class="k">def</span> <span class="nf">same_name</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Test whether functions ``f`` and ``g`` are identical or have the same name &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">f</span> <span class="o">==</span> <span class="n">g</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fix_import_export_id_paths</span><span class="p">(</span><span class="n">fieldname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fixes the id fields in import and exports, and splits field paths</span>
<span class="sd">    on &#39;/&#39;.</span>

<span class="sd">    :param str fieldname: name of the field to import/export</span>
<span class="sd">    :return: split field name</span>
<span class="sd">    :rtype: list of str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fixed_db_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([^/])\.id&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1/.id&#39;</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">)</span>
    <span class="n">fixed_external_id</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([^/]):id&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1/id&#39;</span><span class="p">,</span> <span class="n">fixed_db_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fixed_external_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MetaModel</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">Meta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; The metaclass of all model classes.</span>
<span class="sd">        Its main purpose is to register the models per module.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">module_to_models</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_register</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">MetaModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_module&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_addon_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span><span class="p">)</span>

        <span class="c1"># Remember which models to instanciate for this module.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">module_to_models</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># check for new-api conversion error: leave comma after field definition</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Field</span><span class="p">):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Trailing comma after field definition: </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Field</span><span class="p">):</span>
                <span class="n">val</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">_module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_module</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_addon_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_name</span><span class="p">):</span>
        <span class="c1"># The (OpenERP) module name can be in the ``gerp.addons`` namespace</span>
        <span class="c1"># or not. For instance, module ``sale`` can be imported as</span>
        <span class="c1"># ``gerp.addons.sale`` (the right way) or ``sale`` (for backward</span>
        <span class="c1"># compatibility).</span>
        <span class="n">module_parts</span> <span class="o">=</span> <span class="n">full_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">module_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">module_parts</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;gerp&#39;</span><span class="p">,</span> <span class="s1">&#39;addons&#39;</span><span class="p">]:</span>
            <span class="n">addon_name</span> <span class="o">=</span> <span class="n">full_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">addon_name</span> <span class="o">=</span> <span class="n">full_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">addon_name</span>


<span class="k">class</span> <span class="nc">NewId</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Pseudo-ids for new records, encapsulating an optional reference. &quot;&quot;&quot;</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ref&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">__nonzero__</span> <span class="o">=</span> <span class="fm">__bool__</span>

<span class="n">IdType</span> <span class="o">=</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">integer_types</span> <span class="o">+</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">string_types</span> <span class="o">+</span> <span class="p">(</span><span class="n">NewId</span><span class="p">,)</span>


<span class="c1"># maximum number of prefetched records</span>
<span class="n">PREFETCH_MAX</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># special columns automatically created by the ORM</span>
<span class="n">LOG_ACCESS_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;create_uid&#39;</span><span class="p">,</span> <span class="s1">&#39;create_date&#39;</span><span class="p">,</span> <span class="s1">&#39;write_uid&#39;</span><span class="p">,</span> <span class="s1">&#39;write_date&#39;</span><span class="p">]</span>
<span class="n">MAGIC_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">LOG_ACCESS_COLUMNS</span>


<span class="nd">@pycompat</span><span class="o">.</span><span class="n">implements_to_string</span>
<span class="k">class</span> <span class="nc">BaseModel</span><span class="p">(</span><span class="n">MetaModel</span><span class="p">(</span><span class="s1">&#39;DummyModel&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;_register&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})):</span>
    <span class="sd">&quot;&quot;&quot; Base class for Odoo models.</span>

<span class="sd">    Odoo models are created by inheriting:</span>

<span class="sd">    *   :class:`Model` for regular database-persisted models</span>

<span class="sd">    *   :class:`TransientModel` for temporary data, stored in the database but</span>
<span class="sd">        automatically vacuumed every so often</span>

<span class="sd">    *   :class:`AbstractModel` for abstract super classes meant to be shared by</span>
<span class="sd">        multiple inheriting models</span>

<span class="sd">    The system automatically instantiates every model once per database. Those</span>
<span class="sd">    instances represent the available models on each database, and depend on</span>
<span class="sd">    which modules are installed on that database. The actual class of each</span>
<span class="sd">    instance is built from the Python classes that create and inherit from the</span>
<span class="sd">    corresponding model.</span>

<span class="sd">    Every model instance is a &quot;recordset&quot;, i.e., an ordered collection of</span>
<span class="sd">    records of the model. Recordsets are returned by methods like</span>
<span class="sd">    :meth:`~.browse`, :meth:`~.search`, or field accesses. Records have no</span>
<span class="sd">    explicit representation: a record is represented as a recordset of one</span>
<span class="sd">    record.</span>

<span class="sd">    To create a class that should not be instantiated, the _register class</span>
<span class="sd">    attribute may be set to False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_auto</span> <span class="o">=</span> <span class="kc">False</span>               <span class="c1"># don&#39;t create any database backend</span>
    <span class="n">_register</span> <span class="o">=</span> <span class="kc">False</span>           <span class="c1"># not visible in ORM registry</span>
    <span class="n">_abstract</span> <span class="o">=</span> <span class="kc">True</span>            <span class="c1"># whether model is abstract</span>
    <span class="n">_transient</span> <span class="o">=</span> <span class="kc">False</span>          <span class="c1"># whether model is transient</span>

    <span class="n">_name</span> <span class="o">=</span> <span class="kc">None</span>                <span class="c1"># the model name</span>
    <span class="n">_description</span> <span class="o">=</span> <span class="kc">None</span>         <span class="c1"># the model&#39;s informal name</span>
    <span class="n">_custom</span> <span class="o">=</span> <span class="kc">False</span>             <span class="c1"># should be True for custom models only</span>

    <span class="n">_inherit</span> <span class="o">=</span> <span class="kc">None</span>             <span class="c1"># Python-inherited models (&#39;model&#39; or [&#39;model&#39;])</span>
    <span class="n">_inherits</span> <span class="o">=</span> <span class="p">{}</span>              <span class="c1"># inherited models {&#39;parent_model&#39;: &#39;m2o_field&#39;}</span>
    <span class="n">_constraints</span> <span class="o">=</span> <span class="p">[]</span>           <span class="c1"># Python constraints (old API)</span>

    <span class="n">_table</span> <span class="o">=</span> <span class="kc">None</span>               <span class="c1"># SQL table name used by model</span>
    <span class="n">_sequence</span> <span class="o">=</span> <span class="kc">None</span>            <span class="c1"># SQL sequence to use for ID field</span>
    <span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[]</span>       <span class="c1"># SQL constraints [(name, sql_def, message)]</span>

    <span class="n">_rec_name</span> <span class="o">=</span> <span class="kc">None</span>            <span class="c1"># field to use for labeling records</span>
    <span class="n">_order</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>               <span class="c1"># default order for searching results</span>
    <span class="n">_parent_name</span> <span class="o">=</span> <span class="s1">&#39;parent_id&#39;</span>  <span class="c1"># the many2one field used as parent field</span>
    <span class="n">_parent_store</span> <span class="o">=</span> <span class="kc">False</span>       <span class="c1"># set to True to compute MPTT (parent_left, parent_right)</span>
    <span class="n">_parent_order</span> <span class="o">=</span> <span class="kc">False</span>       <span class="c1"># order to use for siblings in MPTT</span>
    <span class="n">_date_name</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>         <span class="c1"># field to use for default calendar view</span>
    <span class="n">_fold_name</span> <span class="o">=</span> <span class="s1">&#39;fold&#39;</span>         <span class="c1"># field to determine folded groups in kanban views</span>

    <span class="n">_needaction</span> <span class="o">=</span> <span class="kc">False</span>         <span class="c1"># whether the model supports &quot;need actions&quot; (see mail)</span>
    <span class="n">_translate</span> <span class="o">=</span> <span class="kc">True</span>           <span class="c1"># False disables translations export for this model</span>

    <span class="n">_depends</span> <span class="o">=</span> <span class="p">{}</span>               <span class="c1"># dependencies of models backed up by sql views</span>
                                <span class="c1"># {model_name: field_names, ...}</span>

    <span class="c1"># default values for _transient_vacuum()</span>
    <span class="n">_transient_check_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">_transient_max_count</span> <span class="o">=</span> <span class="n">lazy_classproperty</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;osv_memory_count_limit&#39;</span><span class="p">))</span>
    <span class="n">_transient_max_hours</span> <span class="o">=</span> <span class="n">lazy_classproperty</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;osv_memory_age_limit&#39;</span><span class="p">))</span>

    <span class="n">CONCURRENCY_CHECK_FIELD</span> <span class="o">=</span> <span class="s1">&#39;__last_update&#39;</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">view_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Override this method to do specific things when a form view is</span>
<span class="sd">        opened. This method is invoked by :meth:`~default_get`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model_cr_context</span>
    <span class="k">def</span> <span class="nf">_reflect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reflect the model and its fields in the models &#39;ir.model&#39; and</span>
<span class="sd">        &#39;ir.model.fields&#39;. Also create entries in &#39;ir.model.data&#39; if the key</span>
<span class="sd">        &#39;module&#39; is passed to the context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_reflect_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_reflect_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.constraint&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_reflect_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_add_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add the given ``field`` under the given ``name`` in the class &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># add field as an attribute and in cls._fields (for reflection)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">),</span> <span class="n">Field</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;In model </span><span class="si">%r</span><span class="s2">, field </span><span class="si">%r</span><span class="s2"> overriding existing value&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span>

        <span class="c1"># basic setup of field</span>
        <span class="n">field</span><span class="o">.</span><span class="n">setup_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_pop_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove the field with the given ``name`` from the model.</span>
<span class="sd">            This method should only be used for manual fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">field</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_add_magic_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Introduce magic fields on the current class</span>

<span class="sd">        * id is a &quot;normal&quot; field (with a specific getter)</span>
<span class="sd">        * create_uid, create_date, write_uid and write_date have become</span>
<span class="sd">          &quot;normal&quot; fields</span>
<span class="sd">        * $CONCURRENCY_CHECK_FIELD is a computed field with its computing</span>
<span class="sd">          method defined dynamically. Uses ``str(datetime.datetime.utcnow())``</span>
<span class="sd">          to get the same structure as the previous</span>
<span class="sd">          ``(now() at time zone &#39;UTC&#39;)::timestamp``::</span>

<span class="sd">              # select (now() at time zone &#39;UTC&#39;)::timestamp;</span>
<span class="sd">                        timezone</span>
<span class="sd">              ----------------------------</span>
<span class="sd">               2013-06-18 08:30:37.292809</span>

<span class="sd">              &gt;&gt;&gt; str(datetime.datetime.utcnow())</span>
<span class="sd">              &#39;2013-06-18 08:31:32.821177&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; add ``field`` with the given ``name`` if it does not exist yet &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

        <span class="c1"># cyclic import</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">fields</span>

        <span class="c1"># this field &#39;id&#39; must override any other column or field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">Id</span><span class="p">(</span><span class="n">automatic</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="n">add</span><span class="p">(</span><span class="s1">&#39;display_name&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Display Name&#39;</span><span class="p">,</span> <span class="n">automatic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">compute</span><span class="o">=</span><span class="s1">&#39;_compute_display_name&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="n">add</span><span class="p">(</span><span class="s1">&#39;create_uid&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.users&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Created by&#39;</span><span class="p">,</span> <span class="n">automatic</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">add</span><span class="p">(</span><span class="s1">&#39;create_date&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Created on&#39;</span><span class="p">,</span> <span class="n">automatic</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">add</span><span class="p">(</span><span class="s1">&#39;write_uid&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">Many2one</span><span class="p">(</span><span class="s1">&#39;res.users&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Last Updated by&#39;</span><span class="p">,</span> <span class="n">automatic</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">add</span><span class="p">(</span><span class="s1">&#39;write_date&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="s1">&#39;Last Updated on&#39;</span><span class="p">,</span> <span class="n">automatic</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">last_modified_name</span> <span class="o">=</span> <span class="s1">&#39;compute_concurrency_field_with_access&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_modified_name</span> <span class="o">=</span> <span class="s1">&#39;compute_concurrency_field&#39;</span>

        <span class="c1"># this field must override any other column or field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONCURRENCY_CHECK_FIELD</span><span class="p">,</span> <span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="p">(</span>
            <span class="n">string</span><span class="o">=</span><span class="s1">&#39;Last Modified on&#39;</span><span class="p">,</span> <span class="n">compute</span><span class="o">=</span><span class="n">last_modified_name</span><span class="p">,</span> <span class="n">automatic</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">compute_concurrency_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CONCURRENCY_CHECK_FIELD</span><span class="p">]</span> <span class="o">=</span> <span class="n">gerp</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="s1">&#39;create_date&#39;</span><span class="p">,</span> <span class="s1">&#39;write_date&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">compute_concurrency_field_with_access</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">record</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CONCURRENCY_CHECK_FIELD</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">record</span><span class="o">.</span><span class="n">write_date</span> <span class="ow">or</span> <span class="n">record</span><span class="o">.</span><span class="n">create_date</span> <span class="ow">or</span> <span class="n">gerp</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">Datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="c1">#</span>
    <span class="c1"># Goal: try to apply inheritance at the instantiation level and</span>
    <span class="c1">#       put objects in the pool var</span>
    <span class="c1">#</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_model</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Instantiate a given model in the registry.</span>

<span class="sd">        This method creates or extends a &quot;registry&quot; class for the given model.</span>
<span class="sd">        This &quot;registry&quot; class carries inferred model metadata, and inherits (in</span>
<span class="sd">        the Python sense) from all classes that define the model, and possibly</span>
<span class="sd">        other registry classes.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># In the simplest case, the model&#39;s registry class inherits from cls and</span>
        <span class="c1"># the other classes that define the model in a flat hierarchy. The</span>
        <span class="c1"># registry contains the instance ``model`` (on the left). Its class,</span>
        <span class="c1"># ``ModelClass``, carries inferred metadata that is shared between all</span>
        <span class="c1"># the model&#39;s instances for this registry only.</span>
        <span class="c1">#</span>
        <span class="c1">#   class A1(Model):                          Model</span>
        <span class="c1">#       _name = &#39;a&#39;                           / | \</span>
        <span class="c1">#                                            A3 A2 A1</span>
        <span class="c1">#   class A2(Model):                          \ | /</span>
        <span class="c1">#       _inherit = &#39;a&#39;                      ModelClass</span>
        <span class="c1">#                                             /   \</span>
        <span class="c1">#   class A3(Model):                      model   recordset</span>
        <span class="c1">#       _inherit = &#39;a&#39;</span>
        <span class="c1">#</span>
        <span class="c1"># When a model is extended by &#39;_inherit&#39;, its base classes are modified</span>
        <span class="c1"># to include the current class and the other inherited model classes.</span>
        <span class="c1"># Note that we actually inherit from other ``ModelClass``, so that</span>
        <span class="c1"># extensions to an inherited model are immediately visible in the</span>
        <span class="c1"># current model class, like in the following example:</span>
        <span class="c1">#</span>
        <span class="c1">#   class A1(Model):</span>
        <span class="c1">#       _name = &#39;a&#39;                           Model</span>
        <span class="c1">#                                            / / \ \</span>
        <span class="c1">#   class B1(Model):                        / A2 A1 \</span>
        <span class="c1">#       _name = &#39;b&#39;                        /   \ /   \</span>
        <span class="c1">#                                         B2  ModelA  B1</span>
        <span class="c1">#   class B2(Model):                       \    |    /</span>
        <span class="c1">#       _name = &#39;b&#39;                         \   |   /</span>
        <span class="c1">#       _inherit = [&#39;a&#39;, &#39;b&#39;]                \  |  /</span>
        <span class="c1">#                                             ModelB</span>
        <span class="c1">#   class A2(Model):</span>
        <span class="c1">#       _inherit = &#39;a&#39;</span>

        <span class="c1"># Keep links to non-inherited constraints in cls; this is useful for</span>
        <span class="c1"># instance when exporting translations</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_local_constraints</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_constraints&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_local_sql_constraints</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_sql_constraints&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># determine inherited models</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_inherit</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="p">[</span><span class="n">parents</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parents</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">else</span> <span class="p">(</span><span class="n">parents</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># determine the model&#39;s name</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># all models except &#39;base&#39; implicitly inherit from &#39;base&#39;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;base&#39;</span><span class="p">:</span>
            <span class="n">parents</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">]</span>

        <span class="c1"># create or retrieve the model&#39;s class</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Model </span><span class="si">%r</span><span class="s2"> does not exist in registry.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">ModelClass</span> <span class="o">=</span> <span class="n">pool</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">ModelClass</span><span class="o">.</span><span class="n">_build_model_check_base</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            <span class="n">check_parent</span> <span class="o">=</span> <span class="n">ModelClass</span><span class="o">.</span><span class="n">_build_model_check_parent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ModelClass</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">BaseModel</span><span class="p">,),</span> <span class="p">{</span>
                <span class="s1">&#39;_name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;_register&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;_original_module&#39;</span><span class="p">:</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_module</span><span class="p">,</span>
                <span class="s1">&#39;_inherit_children&#39;</span><span class="p">:</span> <span class="n">OrderedSet</span><span class="p">(),</span>      <span class="c1"># names of children models</span>
                <span class="s1">&#39;_inherits_children&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>            <span class="c1"># names of children models</span>
                <span class="s1">&#39;_fields&#39;</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">(),</span>               <span class="c1"># populated in _setup_base()</span>
            <span class="p">})</span>
            <span class="n">check_parent</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_build_model_check_parent</span>

        <span class="c1"># determine all the classes the model should inherit from</span>
        <span class="n">bases</span> <span class="o">=</span> <span class="n">LastOrderedSet</span><span class="p">([</span><span class="bp">cls</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Model </span><span class="si">%r</span><span class="s2"> inherits from non-existing model </span><span class="si">%r</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">))</span>
            <span class="n">parent_class</span> <span class="o">=</span> <span class="n">pool</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">parent_class</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
                    <span class="n">bases</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">check_parent</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">parent_class</span><span class="p">)</span>
                <span class="n">bases</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">parent_class</span><span class="p">)</span>
                <span class="n">parent_class</span><span class="o">.</span><span class="n">_inherit_children</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ModelClass</span><span class="o">.</span><span class="vm">__bases__</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bases</span><span class="p">)</span>

        <span class="c1"># determine the attributes of the model&#39;s class</span>
        <span class="n">ModelClass</span><span class="o">.</span><span class="n">_build_model_attributes</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>

        <span class="n">check_pg_name</span><span class="p">(</span><span class="n">ModelClass</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>

        <span class="c1"># Transience</span>
        <span class="k">if</span> <span class="n">ModelClass</span><span class="o">.</span><span class="n">_transient</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ModelClass</span><span class="o">.</span><span class="n">_log_access</span><span class="p">,</span> \
                <span class="s2">&quot;TransientModels must have log_access turned on, &quot;</span> \
                <span class="s2">&quot;in order to implement their access rights policy&quot;</span>

        <span class="c1"># link the class to the registry, and update the registry</span>
        <span class="n">ModelClass</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span>
        <span class="n">pool</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ModelClass</span>

        <span class="c1"># backward compatibility: instantiate the model, and initialize it</span>
        <span class="n">model</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">ModelClass</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">cr</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ModelClass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_model_check_base</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check whether ``model_class`` can be extended with ``cls``. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_abstract</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_abstract</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> transforms the abstract model </span><span class="si">%r</span><span class="s2"> into a non-abstract model. &quot;</span>
                   <span class="s2">&quot;That class should either inherit from AbstractModel, or set a different &#39;_name&#39;.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_transient</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_transient</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_transient</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> transforms the transient model </span><span class="si">%r</span><span class="s2"> into a non-transient model. &quot;</span>
                       <span class="s2">&quot;That class should either inherit from TransientModel, or set a different &#39;_name&#39;.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> transforms the model </span><span class="si">%r</span><span class="s2"> into a transient model. &quot;</span>
                       <span class="s2">&quot;That class should either inherit from Model, or set a different &#39;_name&#39;.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_model_check_parent</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">parent_class</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check whether ``model_class`` can inherit from ``parent_class``. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_abstract</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">parent_class</span><span class="o">.</span><span class="n">_abstract</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;In </span><span class="si">%s</span><span class="s2">, the abstract model </span><span class="si">%r</span><span class="s2"> cannot inherit from the non-abstract model </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">parent_class</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_model_attributes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize base model attributes. &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_log_access</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_auto</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_inherits</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_depends</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_constraints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_sql_constraints</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s1">&#39;pool&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="c1"># the following attributes are not taken from model classes</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_description</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">_description</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_description</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">_table</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_table</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">_sequence</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sequence</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_log_access</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="s1">&#39;_log_access&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_log_access</span><span class="p">)</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">_inherits</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">mname</span><span class="p">,</span> <span class="n">fnames</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">_depends</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_depends</span><span class="p">[</span><span class="n">mname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_depends</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mname</span><span class="p">,</span> <span class="p">[])</span> <span class="o">+</span> <span class="n">fnames</span>

            <span class="k">for</span> <span class="n">cons</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="n">_constraints</span><span class="p">:</span>
                <span class="c1"># cons may override a constraint with the same function name</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_constraints</span><span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">cons</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="n">cons</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]</span> <span class="o">=</span> <span class="n">cons</span>

            <span class="bp">cls</span><span class="o">.</span><span class="n">_sql_constraints</span> <span class="o">+=</span> <span class="n">base</span><span class="o">.</span><span class="n">_sql_constraints</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_sequence</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sequence</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s1">&#39;_id_seq&#39;</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_constraints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_constraints</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="c1"># update _inherits_children of parent models</span>
        <span class="k">for</span> <span class="n">parent_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="n">pool</span><span class="p">[</span><span class="n">parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">_inherits_children</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="c1"># recompute attributes of _inherit_children models</span>
        <span class="k">for</span> <span class="n">child_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_inherit_children</span><span class="p">:</span>
            <span class="n">child_class</span> <span class="o">=</span> <span class="n">pool</span><span class="p">[</span><span class="n">child_name</span><span class="p">]</span>
            <span class="n">child_class</span><span class="o">.</span><span class="n">_build_model_attributes</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_init_constraints_onchanges</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># store sql constraint error messages</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sql_constraints</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_sql_error</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>

        <span class="c1"># reset properties memoized on cls</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_constraint_methods</span> <span class="o">=</span> <span class="n">BaseModel</span><span class="o">.</span><span class="n">_constraint_methods</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_onchange_methods</span> <span class="o">=</span> <span class="n">BaseModel</span><span class="o">.</span><span class="n">_onchange_methods</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_constraint_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a list of methods implementing Python constraints. &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">is_constraint</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;_constrains&#39;</span><span class="p">)</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">is_constraint</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">_constrains</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;method </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">: @constrains parameter </span><span class="si">%r</span><span class="s2"> is not a field name&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">inverse</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">):</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;method </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">: @constrains parameter </span><span class="si">%r</span><span class="s2"> is not writeable&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">methods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="c1"># optimization: memoize result on cls, it will not be recomputed</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_constraint_methods</span> <span class="o">=</span> <span class="n">methods</span>
        <span class="k">return</span> <span class="n">methods</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_onchange_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a dictionary mapping field names to onchange methods. &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">is_onchange</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;_onchange&#39;</span><span class="p">)</span>

        <span class="c1"># collect onchange methods on the model&#39;s class</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">methods</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">is_onchange</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">_onchange</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;@onchange</span><span class="si">%r</span><span class="s2"> parameters must be field names&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">_onchange</span><span class="p">)</span>
                <span class="n">methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="c1"># add onchange methods to implement &quot;change_default&quot; on fields</span>
        <span class="k">def</span> <span class="nf">onchange_default</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.default&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_model_defaults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">condition</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">change_default</span><span class="p">:</span>
                <span class="n">methods</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">onchange_default</span><span class="p">,</span> <span class="n">field</span><span class="p">))</span>

        <span class="c1"># optimization: memoize result on cls, it will not be recomputed</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_onchange_methods</span> <span class="o">=</span> <span class="n">methods</span>
        <span class="k">return</span> <span class="n">methods</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="c1"># In the past, this method was registering the model class in the server.</span>
        <span class="c1"># This job is now done entirely by the metaclass MetaModel.</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">cr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Deprecated method to initialize the model. &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@ormcache</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_is_an_ordinary_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tools</span><span class="o">.</span><span class="n">table_kind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span>

    <span class="k">def</span> <span class="nf">__export_xml_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a valid xml_id for the record ``self``. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_an_ordinary_table</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;You can not export the column ID of model </span><span class="si">%s</span><span class="s2">, because the &quot;</span>
                <span class="s2">&quot;table </span><span class="si">%s</span><span class="s2"> is not an ordinary table.&quot;</span>
                <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">))</span>
        <span class="n">ir_model_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ir_model_data</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">module</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">postfix</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">ir_model_data</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;__export__&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)]):</span>
                <span class="n">postfix</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">postfix</span><span class="p">)</span>
            <span class="n">ir_model_data</span><span class="o">.</span><span class="n">create</span><span class="p">({</span>
                <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s1">&#39;module&#39;</span><span class="p">:</span> <span class="s1">&#39;__export__&#39;</span><span class="p">,</span>
                <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="k">return</span> <span class="s1">&#39;__export__.&#39;</span> <span class="o">+</span> <span class="n">name</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">_export_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Export fields of the records in ``self``.</span>

<span class="sd">            :param fields: list of lists of fields to traverse</span>
<span class="sd">            :return: list of lists of corresponding values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1"># main line of record, initially empty</span>
            <span class="n">current</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>

            <span class="c1"># list of primary fields followed by secondary field(s)</span>
            <span class="n">primary_done</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># process column by column</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">name</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">primary_done</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;.id&#39;</span><span class="p">:</span>
                    <span class="n">current</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
                    <span class="n">current</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">__export_xml_id</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

                    <span class="c1"># this part could be simpler, but it has to be done this way</span>
                    <span class="c1"># in order to reproduce the former behavior</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
                        <span class="n">current</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_export</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">primary_done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                        <span class="c1"># This is a special case, its strange behavior is intended!</span>
                        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
                            <span class="n">xml_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">__export_xml_id</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
                            <span class="n">current</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xml_ids</span><span class="p">)</span> <span class="ow">or</span> <span class="kc">False</span>
                            <span class="k">continue</span>

                        <span class="c1"># recursively export the fields that follow name</span>
                        <span class="n">fields2</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span> <span class="k">else</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
                        <span class="n">lines2</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">_export_rows</span><span class="p">(</span><span class="n">fields2</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">lines2</span><span class="p">:</span>
                            <span class="c1"># merge first line with record&#39;s main line</span>
                            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines2</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                <span class="k">if</span> <span class="n">val</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                                    <span class="n">current</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                            <span class="c1"># check value of current field</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">current</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">bool</span><span class="p">):</span>
                                <span class="c1"># assign xml_ids, and forget about remaining lines</span>
                                <span class="n">xml_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">name_get</span><span class="p">()]</span>
                                <span class="n">current</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">xml_ids</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># append the other lines at the end</span>
                                <span class="n">lines</span> <span class="o">+=</span> <span class="n">lines2</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">current</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">lines</span>

    <span class="c1"># backward compatibility</span>
    <span class="n">__export_rows</span> <span class="o">=</span> <span class="n">_export_rows</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">export_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields_to_export</span><span class="p">,</span> <span class="n">raw_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Export fields for selected objects</span>

<span class="sd">            :param fields_to_export: list of fields</span>
<span class="sd">            :param raw_data: True to return value in native Python type</span>
<span class="sd">            :rtype: dictionary with a *datas* matrix</span>

<span class="sd">            This method is used when exporting data via client menu</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields_to_export</span> <span class="o">=</span> <span class="p">[</span><span class="n">fix_import_export_id_paths</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields_to_export</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">raw_data</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">export_raw_data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;datas&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_export_rows</span><span class="p">(</span><span class="n">fields_to_export</span><span class="p">)}</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempts to load the data matrix, and returns a list of ids (or</span>
<span class="sd">        ``False`` if there was an error and no id could be generated) and a</span>
<span class="sd">        list of messages.</span>

<span class="sd">        The ids are those of the records created and saved (in database), in</span>
<span class="sd">        the same order they were extracted from the file. They can be passed</span>
<span class="sd">        directly to :meth:`~read`</span>

<span class="sd">        :param fields: list of fields to import, at the same index as the corresponding data</span>
<span class="sd">        :type fields: list(str)</span>
<span class="sd">        :param data: row-major matrix of data to import</span>
<span class="sd">        :type data: list(list(str))</span>
<span class="sd">        :returns: {ids: list(int)|False, messages: [Message]}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># determine values of mode, current_module and noupdate</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;init&#39;</span><span class="p">)</span>
        <span class="n">current_module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">noupdate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;noupdate&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># add current module in context for the conversion of xml ids</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">_import_current_module</span><span class="o">=</span><span class="n">current_module</span><span class="p">)</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SAVEPOINT model_load&#39;</span><span class="p">)</span>

        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">fix_import_export_id_paths</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span>
        <span class="n">fg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_get</span><span class="p">()</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ModelData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span>
        <span class="n">ModelData</span><span class="o">.</span><span class="n">clear_caches</span><span class="p">()</span>
        <span class="n">extracted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_records</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">)</span>
        <span class="n">converted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_records</span><span class="p">(</span><span class="n">extracted</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">converted</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SAVEPOINT model_load_save&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">InternalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># broken transaction, exit and hope the source error was</span>
                <span class="c1"># already logged</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">):</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span><span class="n">message</span><span class="o">=</span><span class="sa">u</span><span class="s2">&quot;Unknown database error: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
                <span class="k">break</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ModelData</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">current_module</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                                             <span class="n">xml_id</span><span class="o">=</span><span class="n">xid</span><span class="p">,</span> <span class="n">noupdate</span><span class="o">=</span><span class="n">noupdate</span><span class="p">,</span> <span class="n">res_id</span><span class="o">=</span><span class="nb">id</span><span class="p">))</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;RELEASE SAVEPOINT model_load_save&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">Warning</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;warning&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;ROLLBACK TO SAVEPOINT model_load_save&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">PGERROR_TO_OE</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">pgcode</span><span class="p">](</span><span class="bp">self</span><span class="p">,</span> <span class="n">fg</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">e</span><span class="p">)))</span>
                <span class="c1"># Failed to write, log to messages, rollback savepoint (to</span>
                <span class="c1"># avoid broken transaction) and keep going</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;ROLLBACK TO SAVEPOINT model_load_save&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Unknown error during import:&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">u</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
                <span class="n">moreinfo</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Resolve other errors first&#39;</span><span class="p">)</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">moreinfo</span><span class="o">=</span><span class="n">moreinfo</span><span class="p">))</span>
                <span class="c1"># Failed for some reason, perhaps due to invalid data supplied,</span>
                <span class="c1"># rollback savepoint and keep going</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;ROLLBACK TO SAVEPOINT model_load_save&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span> <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">):</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;ROLLBACK TO SAVEPOINT model_load&#39;</span><span class="p">)</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">ids</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;defer_parent_store_computation&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store_compute</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;ids&#39;</span><span class="p">:</span> <span class="n">ids</span><span class="p">,</span> <span class="s1">&#39;messages&#39;</span><span class="p">:</span> <span class="n">messages</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_add_fake_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">gerp.fields</span> <span class="k">import</span> <span class="n">Char</span><span class="p">,</span> <span class="n">Integer</span>
        <span class="n">fields</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">Char</span><span class="p">(</span><span class="s1">&#39;rec_name&#39;</span><span class="p">)</span>
        <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Char</span><span class="p">(</span><span class="s1">&#39;External ID&#39;</span><span class="p">)</span>
        <span class="n">fields</span><span class="p">[</span><span class="s1">&#39;.id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Integer</span><span class="p">(</span><span class="s1">&#39;Database ID&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fields</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_extract_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields_</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates record dicts from the data sequence.</span>

<span class="sd">        The result is a generator of dicts mapping field names to raw</span>
<span class="sd">        (unconverted, unvalidated) values.</span>

<span class="sd">        For relational fields, if sub-fields were provided the value will be</span>
<span class="sd">        a list of sub-records</span>

<span class="sd">        The following sub-fields may be set on the record (by key):</span>
<span class="sd">        * None is the name_get for the record (to use with name_create/name_search)</span>
<span class="sd">        * &quot;id&quot; is the External ID for the record</span>
<span class="sd">        * &quot;.id&quot; is the Database ID for the record</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>
        <span class="c1"># Fake fields to avoid special cases in extractor</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_fake_fields</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="c1"># m2o fields can&#39;t be on multiple lines so exclude them from the</span>
        <span class="c1"># is_relational field rows filter, but special-case it later on to</span>
        <span class="c1"># be handled with relational fields (as it can have subfields)</span>
        <span class="n">is_relational</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">field</span><span class="p">:</span> <span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">relational</span>
        <span class="n">get_o2m_values</span> <span class="o">=</span> <span class="n">itemgetter_tuple</span><span class="p">([</span>
            <span class="n">index</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fnames</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fields</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span>
        <span class="p">])</span>
        <span class="n">get_nono2m_values</span> <span class="o">=</span> <span class="n">itemgetter_tuple</span><span class="p">([</span>
            <span class="n">index</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fnames</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields_</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fields</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;one2many&#39;</span>
        <span class="p">])</span>
        <span class="c1"># Checks if the provided row has any non-empty one2many fields</span>
        <span class="k">def</span> <span class="nf">only_o2m_values</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">get_o2m_values</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">get_nono2m_values</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>

        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

            <span class="c1"># copy non-relational fields to record dict</span>
            <span class="n">record</span> <span class="o">=</span> <span class="p">{</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">value</span>
                      <span class="k">for</span> <span class="n">fnames</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="n">fields_</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
                      <span class="k">if</span> <span class="ow">not</span> <span class="n">is_relational</span><span class="p">(</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">])}</span>

            <span class="c1"># Get all following rows which have relational values attached to</span>
            <span class="c1"># the current record (no non-relational values)</span>
            <span class="n">record_span</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span>
                <span class="n">only_o2m_values</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="c1"># stitch record row back on for relational fields</span>
            <span class="n">record_span</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">([</span><span class="n">row</span><span class="p">],</span> <span class="n">record_span</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">relfield</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">fnames</span> <span class="ow">in</span> <span class="n">fields_</span> <span class="k">if</span> <span class="n">is_relational</span><span class="p">(</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">comodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">fields</span><span class="p">[</span><span class="n">relfield</span><span class="p">]</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span>

                <span class="c1"># get only cells for this sub-field, should be strictly</span>
                <span class="c1"># non-empty, field path [None] is for name_get field</span>
                <span class="n">indices</span><span class="p">,</span> <span class="n">subfields</span> <span class="o">=</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">index</span><span class="p">,</span> <span class="n">fnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">or</span> <span class="p">[</span><span class="kc">None</span><span class="p">])</span>
                                           <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fnames</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields_</span><span class="p">)</span>
                                           <span class="k">if</span> <span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">relfield</span><span class="p">))</span>

                <span class="c1"># return all rows which have at least one value for the</span>
                <span class="c1"># subfields of relfield</span>
                <span class="n">relfield_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">itemgetter_tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="n">record_span</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">it</span><span class="p">)]</span>
                <span class="n">record</span><span class="p">[</span><span class="n">relfield</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">subrecord</span>
                    <span class="k">for</span> <span class="n">subrecord</span><span class="p">,</span> <span class="n">_subinfo</span> <span class="ow">in</span> <span class="n">comodel</span><span class="o">.</span><span class="n">_extract_records</span><span class="p">(</span><span class="n">subfields</span><span class="p">,</span> <span class="n">relfield_data</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
                <span class="p">]</span>

            <span class="k">yield</span> <span class="n">record</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
                <span class="s1">&#39;to&#39;</span><span class="p">:</span> <span class="n">index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">record_span</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">}}</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">record_span</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_convert_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">records</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Converts records from the source iterable (recursive dicts of</span>
<span class="sd">        strings) into forms which can be written to the database (via</span>
<span class="sd">        self.create or (ir.model.data)._update)</span>

<span class="sd">        :returns: a list of triplets of (id, xid, record)</span>
<span class="sd">        :rtype: list((int|None, str|None, dict))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">string</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span><span class="p">:</span>
            <span class="n">field_names</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.translation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_field_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>

        <span class="n">convert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.fields.converter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">for_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_log</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;warning&#39;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;error&#39;</span>
            <span class="c1"># logs the logical (not human-readable) field name for automated</span>
            <span class="c1"># processing of response, but injects human readable in message</span>
            <span class="n">exc_vals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">record</span><span class="o">=</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field_names</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
            <span class="n">record</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">record</span><span class="o">=</span><span class="n">record</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                          <span class="n">message</span><span class="o">=</span><span class="n">pycompat</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">%</span> <span class="n">exc_vals</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">record</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">log</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>

        <span class="n">stream</span> <span class="o">=</span> <span class="n">CountingStream</span><span class="p">(</span><span class="n">records</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">extras</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="c1"># xid</span>
            <span class="n">xid</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="c1"># dbid</span>
            <span class="n">dbid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;.id&#39;</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dbid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;.id&#39;</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># in case of overridden id column</span>
                    <span class="n">dbid</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s1">&#39;.id&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">dbid</span><span class="p">)]):</span>
                    <span class="n">log</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">extras</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
                        <span class="n">record</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                        <span class="n">field</span><span class="o">=</span><span class="s1">&#39;.id&#39;</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;Unknown database identifier &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">dbid</span><span class="p">))</span>
                    <span class="n">dbid</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">converted</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_log</span><span class="p">,</span> <span class="n">extras</span><span class="p">,</span> <span class="n">stream</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>

            <span class="k">yield</span> <span class="n">dbid</span><span class="p">,</span> <span class="n">xid</span><span class="p">,</span> <span class="n">converted</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extras</span><span class="p">,</span> <span class="n">record</span><span class="o">=</span><span class="n">stream</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">_validate_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_names</span><span class="p">):</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">field_names</span><span class="p">)</span>

        <span class="c1"># old-style constraint methods</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.translation&#39;</span><span class="p">]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">func</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># validation must be context-independent; call ``func`` without context</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">names</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">field_names</span><span class="p">)</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">valid</span> <span class="ow">or</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">extra_error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exception while validating constraint&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">extra_error</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                    <span class="n">res_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res_msg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="n">template</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">res_msg</span>
                        <span class="n">res_msg</span> <span class="o">=</span> <span class="n">template</span> <span class="o">%</span> <span class="n">params</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res_msg</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">_get_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s1">&#39;constraint&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">extra_error</span><span class="p">:</span>
                    <span class="n">res_msg</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Error details:&#39;</span><span class="p">),</span> <span class="n">extra_error</span><span class="p">)</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res_msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>

        <span class="c1"># new-style constraint methods</span>
        <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraint_methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">check</span><span class="o">.</span><span class="n">_constrains</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">field_names</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">check</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Error while validating constraint&quot;</span><span class="p">),</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">default_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; default_get(fields) -&gt; default_values</span>

<span class="sd">        Return default values for the fields in ``fields_list``. Default</span>
<span class="sd">        values are determined by the context, user defaults, and the model</span>
<span class="sd">        itself.</span>

<span class="sd">        :param fields_list: a list of field names</span>
<span class="sd">        :return: a dictionary mapping each field name to its corresponding</span>
<span class="sd">            default value, if it has one.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># trigger view init hook</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">fields_list</span><span class="p">)</span>

        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">parent_fields</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">ir_defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.default&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_model_defaults</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fields_list</span><span class="p">:</span>
            <span class="c1"># 1. look up context</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;default_&#39;</span> <span class="o">+</span> <span class="n">name</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="c1"># 2. look up ir.default</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">ir_defaults</span><span class="p">:</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ir_defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">continue</span>

            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># 3. look up field.default</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># 4. delegate to parent model</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">related_field</span>
                <span class="n">parent_fields</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># convert default values to the right format</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_write</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>

        <span class="c1"># add default values for inherited fields</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">names</span> <span class="ow">in</span> <span class="n">parent_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">model</span><span class="p">]</span><span class="o">.</span><span class="n">default_get</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">defaults</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">fields_get_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_rec_name_fallback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># if self._rec_name is set, it belongs to self._fields</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span> <span class="ow">or</span> <span class="s1">&#39;id&#39;</span>

    <span class="c1">#</span>
    <span class="c1"># Override this method if you need a window title that depends on the context</span>
    <span class="c1">#</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">view_header_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">user_has_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return true if the user is member of at least one of the groups in</span>
<span class="sd">        ``groups``, and is not a member of any of the groups in ``groups``</span>
<span class="sd">        preceded by ``!``. Typically used to resolve ``groups`` attribute in</span>
<span class="sd">        view and model definitions.</span>

<span class="sd">        :param str groups: comma-separated list of fully-qualified group</span>
<span class="sd">            external IDs, e.g., ``base.group_user,base.group_system``,</span>
<span class="sd">            optionally preceded by ``!``</span>
<span class="sd">        :return: True if the current user is a member of one of the given groups</span>
<span class="sd">            not preceded by ``!`` and is not member of any of the groups</span>
<span class="sd">            preceded by ``!``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">gerp.http</span> <span class="k">import</span> <span class="n">request</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user</span>

        <span class="n">has_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">not_has_groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">group_ext_id</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">group_ext_id</span> <span class="o">=</span> <span class="n">group_ext_id</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">group_ext_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;!&#39;</span><span class="p">:</span>
                <span class="n">not_has_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_ext_id</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">has_groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_ext_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">group_ext_id</span> <span class="ow">in</span> <span class="n">not_has_groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">group_ext_id</span> <span class="o">==</span> <span class="s1">&#39;base.group_no_one&#39;</span><span class="p">:</span>
                <span class="c1"># check: the group_no_one is effective in debug mode only</span>
                <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="n">group_ext_id</span><span class="p">)</span> <span class="ow">and</span> <span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="n">group_ext_id</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">group_ext_id</span> <span class="ow">in</span> <span class="n">has_groups</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">group_ext_id</span> <span class="o">==</span> <span class="s1">&#39;base.group_no_one&#39;</span><span class="p">:</span>
                <span class="c1"># check: the group_no_one is effective in debug mode only</span>
                <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="n">group_ext_id</span><span class="p">)</span> <span class="ow">and</span> <span class="n">request</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_group</span><span class="p">(</span><span class="n">group_ext_id</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="ow">not</span> <span class="n">has_groups</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_form_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates a default single-line form view using all fields</span>
<span class="sd">        of the current model.</span>

<span class="sd">        :returns: a form view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s2">&quot;4&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">automatic</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;one2many&#39;</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">):</span>
                <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">newline</span><span class="p">())</span>
                <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">colspan</span><span class="o">=</span><span class="s2">&quot;4&quot;</span><span class="p">))</span>
                <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">newline</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fname</span><span class="p">))</span>
        <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">separator</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">form</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">sheet</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_search_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates a single-field search view, based on _rec_name.</span>

<span class="sd">        :returns: a tree view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name_fallback</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_tree_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates a single-field tree view, based on _rec_name.</span>

<span class="sd">        :returns: a tree view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name_fallback</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">tree</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_pivot_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates an empty pivot view.</span>

<span class="sd">        :returns: a pivot view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_kanban_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates a single-field kanban view, based on _rec_name.</span>

<span class="sd">        :returns: a kanban view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">field</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name_fallback</span><span class="p">())</span>
        <span class="n">content_div</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s2">&quot;o_kanban_card_content&quot;</span><span class="p">})</span>
        <span class="n">card_div</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">content_div</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;t-attf-class&#39;</span><span class="p">:</span> <span class="s2">&quot;oe_kanban_card oe_kanban_global_click&quot;</span><span class="p">})</span>
        <span class="n">kanban_box</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">card_div</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;t-name&#39;</span><span class="p">:</span> <span class="s2">&quot;kanban-box&quot;</span><span class="p">})</span>
        <span class="n">templates</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">templates</span><span class="p">(</span><span class="n">kanban_box</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">kanban</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_graph_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates a single-field graph view, based on _rec_name.</span>

<span class="sd">        :returns: a graph view as an lxml document</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name_fallback</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">E</span><span class="o">.</span><span class="n">graph</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_get_default_calendar_view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates a default calendar view by trying to infer</span>
<span class="sd">        calendar fields from a number of pre-set attribute names</span>

<span class="sd">        :returns: a calendar view</span>
<span class="sd">        :rtype: etree._Element</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">set_first_of</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">in_</span><span class="p">,</span> <span class="n">to</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Sets the first value of ``seq`` also found in ``in_`` to</span>
<span class="sd">            the ``to`` attribute of the ``view`` being closed over.</span>

<span class="sd">            Returns whether it&#39;s found a suitable value (and set it on</span>
<span class="sd">            the attribute) or not</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">in_</span><span class="p">:</span>
                    <span class="n">view</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">view</span> <span class="o">=</span> <span class="n">E</span><span class="o">.</span><span class="n">calendar</span><span class="p">(</span><span class="n">string</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>
        <span class="n">view</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name_fallback</span><span class="p">()))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_date_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">date_found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;date_start&#39;</span><span class="p">,</span> <span class="s1">&#39;x_date&#39;</span><span class="p">,</span> <span class="s1">&#39;x_date_start&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_date_name</span> <span class="o">=</span> <span class="n">dt</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Insufficient fields for Calendar View!&quot;</span><span class="p">))</span>
        <span class="n">view</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;date_start&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_date_name</span><span class="p">)</span>

        <span class="n">set_first_of</span><span class="p">([</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;partner_id&quot;</span><span class="p">,</span> <span class="s2">&quot;x_user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;x_partner_id&quot;</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">set_first_of</span><span class="p">([</span><span class="s2">&quot;date_stop&quot;</span><span class="p">,</span> <span class="s2">&quot;date_end&quot;</span><span class="p">,</span> <span class="s2">&quot;x_date_stop&quot;</span><span class="p">,</span> <span class="s2">&quot;x_date_end&quot;</span><span class="p">],</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="s1">&#39;date_stop&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">set_first_of</span><span class="p">([</span><span class="s2">&quot;date_delay&quot;</span><span class="p">,</span> <span class="s2">&quot;planned_hours&quot;</span><span class="p">,</span> <span class="s2">&quot;x_date_delay&quot;</span><span class="p">,</span> <span class="s2">&quot;x_planned_hours&quot;</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="s1">&#39;date_delay&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Insufficient fields to generate a Calendar View for </span><span class="si">%s</span><span class="s2">, missing a date_stop or a date_delay&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">view</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">load_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">views</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns the fields_views of given views, along with the fields of</span>
<span class="sd">            the current model, and optionally its filters for the given action.</span>

<span class="sd">        :param views: list of [view_id, view_type]</span>
<span class="sd">        :param options[&#39;toolbar&#39;]: True to include contextual actions when loading fields_views</span>
<span class="sd">        :param options[&#39;load_filters&#39;]: True to return the model&#39;s filters</span>
<span class="sd">        :param options[&#39;action_id&#39;]: id of the action to get the filters</span>
<span class="sd">        :return: dictionary with fields_views, fields and optionally filters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">toolbar</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;toolbar&#39;</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fields_views&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">v_type</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_view_get</span><span class="p">(</span><span class="n">v_id</span><span class="p">,</span> <span class="n">v_type</span> <span class="k">if</span> <span class="n">v_type</span> <span class="o">!=</span> <span class="s1">&#39;list&#39;</span> <span class="k">else</span> <span class="s1">&#39;tree&#39;</span><span class="p">,</span>
                                         <span class="n">toolbar</span><span class="o">=</span><span class="n">toolbar</span> <span class="k">if</span> <span class="n">v_type</span> <span class="o">!=</span> <span class="s1">&#39;search&#39;</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">[</span><span class="n">v_id</span><span class="p">,</span> <span class="n">v_type</span><span class="p">]</span> <span class="ow">in</span> <span class="n">views</span>
        <span class="p">}</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_get</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;load_filters&#39;</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;filters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.filters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_filters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action_id&#39;</span><span class="p">))</span>


        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_fields_view_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="n">toolbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">submenu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">View</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
            <span class="s1">&#39;field_parent&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># try to find a view_id if none provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">view_id</span><span class="p">:</span>
            <span class="c1"># &lt;view_type&gt;_view_ref in context can be used to overrride the default view</span>
            <span class="n">view_ref_key</span> <span class="o">=</span> <span class="n">view_type</span> <span class="o">+</span> <span class="s1">&#39;_view_ref&#39;</span>
            <span class="n">view_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">view_ref_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">view_ref</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">view_ref</span><span class="p">:</span>
                    <span class="n">module</span><span class="p">,</span> <span class="n">view_ref</span> <span class="o">=</span> <span class="n">view_ref</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT res_id FROM ir_model_data WHERE model=&#39;ir.ui.view&#39; AND module=</span><span class="si">%s</span><span class="s2"> AND name=</span><span class="si">%s</span><span class="s2">&quot;</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">view_ref</span><span class="p">))</span>
                    <span class="n">view_ref_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">view_ref_res</span><span class="p">:</span>
                        <span class="n">view_id</span> <span class="o">=</span> <span class="n">view_ref_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> requires a fully-qualified external id (got: </span><span class="si">%r</span><span class="s1"> for model </span><span class="si">%s</span><span class="s1">). &#39;</span>
                        <span class="s1">&#39;Please use the complete `module.view_id` form instead.&#39;</span><span class="p">,</span> <span class="n">view_ref_key</span><span class="p">,</span> <span class="n">view_ref</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">view_id</span><span class="p">:</span>
                <span class="c1"># otherwise try to find the lowest priority matching ir.ui.view</span>
                <span class="n">view_id</span> <span class="o">=</span> <span class="n">View</span><span class="o">.</span><span class="n">default_view</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">view_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">view_id</span><span class="p">:</span>
            <span class="c1"># read the view with inherited views applied</span>
            <span class="n">root_view</span> <span class="o">=</span> <span class="n">View</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">view_id</span><span class="p">)</span><span class="o">.</span><span class="n">read_combined</span><span class="p">([</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;field_parent&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;arch&#39;</span><span class="p">])</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;arch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_view</span><span class="p">[</span><span class="s1">&#39;arch&#39;</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_view</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_view</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;view_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_view</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;field_parent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_view</span><span class="p">[</span><span class="s1">&#39;field_parent&#39;</span><span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;base_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">root_view</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># fallback on default views methods if no ir.ui.view could be found</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">arch_etree</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_get_default_</span><span class="si">%s</span><span class="s1">_view&#39;</span> <span class="o">%</span> <span class="n">view_type</span><span class="p">)()</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;arch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">arch_etree</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;unicode&#39;</span><span class="p">)</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">view_type</span>
                <span class="n">result</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;No default view of type &#39;</span><span class="si">%s</span><span class="s2">&#39; could be found !&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">view_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">fields_view_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="s1">&#39;form&#39;</span><span class="p">,</span> <span class="n">toolbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">submenu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; fields_view_get([view_id | view_type=&#39;form&#39;])</span>

<span class="sd">        Get the detailed composition of the requested view like fields, model, view architecture</span>

<span class="sd">        :param view_id: id of the view or None</span>
<span class="sd">        :param view_type: type of the view to return if view_id is None (&#39;form&#39;, &#39;tree&#39;, ...)</span>
<span class="sd">        :param toolbar: true to include contextual actions</span>
<span class="sd">        :param submenu: deprecated</span>
<span class="sd">        :return: dictionary describing the composition of the requested view (including inherited views and extensions)</span>
<span class="sd">        :raise AttributeError:</span>
<span class="sd">                            * if the inherited view has unknown position to work with other than &#39;before&#39;, &#39;after&#39;, &#39;inside&#39;, &#39;replace&#39;</span>
<span class="sd">                            * if some tag other than &#39;position&#39; is found in parent view</span>
<span class="sd">        :raise Invalid ArchitectureError: if there is view type other than form, tree, calendar, search etc defined on the structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">View</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.ui.view&#39;</span><span class="p">]</span>

        <span class="c1"># Get the view arch and all other attributes describing the composition of the view</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields_view_get</span><span class="p">(</span><span class="n">view_id</span><span class="o">=</span><span class="n">view_id</span><span class="p">,</span> <span class="n">view_type</span><span class="o">=</span><span class="n">view_type</span><span class="p">,</span> <span class="n">toolbar</span><span class="o">=</span><span class="n">toolbar</span><span class="p">,</span> <span class="n">submenu</span><span class="o">=</span><span class="n">submenu</span><span class="p">)</span>

        <span class="c1"># Override context for postprocessing</span>
        <span class="k">if</span> <span class="n">view_id</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;base_model&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
            <span class="n">View</span> <span class="o">=</span> <span class="n">View</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">base_model_name</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;base_model&#39;</span><span class="p">])</span>

        <span class="c1"># Apply post processing, groups and modifiers etc...</span>
        <span class="n">xarch</span><span class="p">,</span> <span class="n">xfields</span> <span class="o">=</span> <span class="n">View</span><span class="o">.</span><span class="n">postprocess_and_fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;arch&#39;</span><span class="p">]),</span> <span class="n">view_id</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;arch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xarch</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xfields</span>

        <span class="c1"># Add related action information if aksed</span>
        <span class="k">if</span> <span class="n">toolbar</span><span class="p">:</span>
            <span class="n">bindings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.actions.actions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_bindings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="n">resreport</span> <span class="o">=</span> <span class="p">[</span><span class="n">action</span>
                         <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">bindings</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">]</span>
                         <span class="k">if</span> <span class="n">view_type</span> <span class="o">==</span> <span class="s1">&#39;tree&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi&#39;</span><span class="p">)]</span>
            <span class="n">resaction</span> <span class="o">=</span> <span class="p">[</span><span class="n">action</span>
                         <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">bindings</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span>
                         <span class="k">if</span> <span class="n">view_type</span> <span class="o">==</span> <span class="s1">&#39;tree&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">action</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi&#39;</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">resreport</span><span class="p">,</span> <span class="n">resaction</span><span class="p">):</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;string&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;toolbar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;print&#39;</span><span class="p">:</span> <span class="n">resreport</span><span class="p">,</span>
                <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">resaction</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">get_formview_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return an view id to open the document ``self`` with. This method is</span>
<span class="sd">            meant to be overridden in addons that want to give specific view ids</span>
<span class="sd">            for example.</span>

<span class="sd">            Optional access_uid holds the user that would access the form view</span>
<span class="sd">            id different from the current environment user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">get_formview_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return an action to open the document ``self``. This method is meant</span>
<span class="sd">            to be overridden in addons that want to give specific view ids for</span>
<span class="sd">            example.</span>

<span class="sd">        An optional access_uid holds the user that will access the document</span>
<span class="sd">        that could be different from the current user. &quot;&quot;&quot;</span>
        <span class="n">view_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">get_formview_id</span><span class="p">(</span><span class="n">access_uid</span><span class="o">=</span><span class="n">access_uid</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_model&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
            <span class="s1">&#39;view_type&#39;</span><span class="p">:</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span>
            <span class="s1">&#39;view_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;form&#39;</span><span class="p">,</span>
            <span class="s1">&#39;views&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="n">view_id</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">)],</span>
            <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span>
            <span class="s1">&#39;res_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">get_access_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return an action to open the document. This method is meant to be</span>
<span class="sd">        overridden in addons that want to give specific access to the document.</span>
<span class="sd">        By default it opens the formview of the document.</span>

<span class="sd">        An optional access_uid holds the user that will access the document</span>
<span class="sd">        that could be different from the current user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_formview_action</span><span class="p">(</span><span class="n">access_uid</span><span class="o">=</span><span class="n">access_uid</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">search_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; search_count(args) -&gt; int</span>

<span class="sd">        Returns the number of records in the current model matching :ref:`the</span>
<span class="sd">        provided domain &lt;reference/orm/domains&gt;`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">integer_types</span><span class="p">)</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span>
        <span class="n">upgrade</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">:</span> <span class="n">value</span> <span class="k">if</span> <span class="n">count</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">value</span><span class="p">),</span>
        <span class="n">downgrade</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">:</span> <span class="n">value</span> <span class="k">if</span> <span class="n">count</span> <span class="k">else</span> <span class="n">value</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; search(args[, offset=0][, limit=None][, order=None][, count=False])</span>

<span class="sd">        Searches for records based on the ``args``</span>
<span class="sd">        :ref:`search domain &lt;reference/orm/domains&gt;`.</span>

<span class="sd">        :param args: :ref:`A search domain &lt;reference/orm/domains&gt;`. Use an empty</span>
<span class="sd">                     list to match all records.</span>
<span class="sd">        :param int offset: number of results to ignore (default: none)</span>
<span class="sd">        :param int limit: maximum number of records to return (default: all)</span>
<span class="sd">        :param str order: sort string</span>
<span class="sd">        :param bool count: if True, only counts and returns the number of matching records (default: False)</span>
<span class="sd">        :returns: at most ``limit`` records matching the search criteria</span>

<span class="sd">        :raise AccessError: * if user tries to bypass access rules for read on the requested object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span> <span class="k">if</span> <span class="n">count</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># display_name, name_get, name_create, name_search</span>
    <span class="c1">#</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">depends</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">,)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span> <span class="k">else</span> <span class="p">())</span>
    <span class="k">def</span> <span class="nf">_compute_display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_get</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">record</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">name_get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; name_get() -&gt; [(id, name), ...]</span>

<span class="sd">        Returns a textual representation for the records in ``self``.</span>
<span class="sd">        By default this is the value of the ``display_name`` field.</span>

<span class="sd">        :return: list of pairs ``(id, text_repr)`` for each records</span>
<span class="sd">        :rtype: list(tuple)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">convert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">convert_to_display_name</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">convert</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">record</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">name_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; name_create(name) -&gt; record</span>

<span class="sd">        Create a new record by calling :meth:`~.create` with only one value</span>
<span class="sd">        provided: the display name of the new record.</span>

<span class="sd">        The new record will be initialized with any default values</span>
<span class="sd">        applicable to this model, or provided through the context. The usual</span>
<span class="sd">        behavior of :meth:`~.create` applies.</span>

<span class="sd">        :param name: display name of the record to create</span>
<span class="sd">        :rtype: tuple</span>
<span class="sd">        :return: the :meth:`~.name_get` pair value of the created record</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">:</span> <span class="n">name</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="n">name_get</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot execute name_create, no _rec_name defined on </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">name_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; name_search(name=&#39;&#39;, args=None, operator=&#39;ilike&#39;, limit=100) -&gt; records</span>

<span class="sd">        Search for records that have a display name matching the given</span>
<span class="sd">        ``name`` pattern when compared with the given ``operator``, while also</span>
<span class="sd">        matching the optional search domain (``args``).</span>

<span class="sd">        This is used for example to provide suggestions based on a partial</span>
<span class="sd">        value for a relational field. Sometimes be seen as the inverse</span>
<span class="sd">        function of :meth:`~.name_get`, but it is not guaranteed to be.</span>

<span class="sd">        This method is equivalent to calling :meth:`~.search` with a search</span>
<span class="sd">        domain based on ``display_name`` and then :meth:`~.name_get` on the</span>
<span class="sd">        result of the search.</span>

<span class="sd">        :param str name: the name pattern to match</span>
<span class="sd">        :param list args: optional search domain (see :meth:`~.search` for</span>
<span class="sd">                          syntax), specifying further restrictions</span>
<span class="sd">        :param str operator: domain operator for matching ``name``, such as</span>
<span class="sd">                             ``&#39;like&#39;`` or ``&#39;=&#39;``.</span>
<span class="sd">        :param int limit: optional max number of records to return</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        :return: list of pairs ``(id, text_repr)`` for all matching records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_search</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_name_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;ilike&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">name_get_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># private implementation of name_search, allows passing a dedicated user</span>
        <span class="c1"># for the name_get part to solve some access rights issues</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="c1"># optimize out the default criterion of ``ilike &#39;&#39;`` that matches everything</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot execute name_search, no _rec_name defined on </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;ilike&#39;</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">+=</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">name</span><span class="p">)]</span>
        <span class="n">access_rights_uid</span> <span class="o">=</span> <span class="n">name_get_uid</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">access_rights_uid</span><span class="o">=</span><span class="n">access_rights_uid</span><span class="p">)</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">recs</span><span class="o">.</span><span class="n">sudo</span><span class="p">(</span><span class="n">access_rights_uid</span><span class="p">)</span><span class="o">.</span><span class="n">name_get</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_add_missing_default_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="c1"># avoid overriding inherited values when parent is set</span>
        <span class="n">avoid_models</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">parent_model</span>
            <span class="k">for</span> <span class="n">parent_model</span><span class="p">,</span> <span class="n">parent_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">parent_field</span> <span class="ow">in</span> <span class="n">values</span>
        <span class="p">}</span>

        <span class="c1"># compute missing fields</span>
        <span class="n">missing_defaults</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">values</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MAGIC_COLUMNS</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">inherited</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">related_field</span><span class="o">.</span><span class="n">model_name</span> <span class="ow">in</span> <span class="n">avoid_models</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">missing_defaults</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">values</span>

        <span class="c1"># override defaults with the provided values, never allow the other way around</span>
        <span class="n">defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_get</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">missing_defaults</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">integer_types</span><span class="p">):</span>
                <span class="c1"># convert a list of ids into a list of commands</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="c1"># convert a list of dicts into a list of commands</span>
                <span class="n">defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
        <span class="n">defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">defaults</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">clear_caches</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clear the caches</span>

<span class="sd">        This clears the caches associated to methods decorated with</span>
<span class="sd">        ``tools.ormcache`` or ``tools.ormcache_multi``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_clear_cache</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_group_fill_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">remaining_groupbys</span><span class="p">,</span>
                                 <span class="n">aggregated_fields</span><span class="p">,</span> <span class="n">count_field</span><span class="p">,</span>
                                 <span class="n">read_group_result</span><span class="p">,</span> <span class="n">read_group_order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method for filling in empty groups for all possible values of</span>
<span class="sd">           the field being grouped by&quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">group_expand</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">read_group_result</span>

        <span class="c1"># field.group_expand is the name of a method that returns the groups</span>
        <span class="c1"># that we want to display for this field, in the form of a recordset or</span>
        <span class="c1"># a list of values (depending on the type of the field). This is useful</span>
        <span class="c1"># to implement kanban views for instance, where some columns should be</span>
        <span class="c1"># displayed even if they don&#39;t contain any record.</span>

        <span class="c1"># determine all groups that should be returned</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">read_group_result</span> <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">groupby</span><span class="p">]]</span>

        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span><span class="p">:</span>
            <span class="c1"># groups is a recordset; determine order on groups&#39;s model</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">])</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">_order</span>
            <span class="k">if</span> <span class="n">read_group_order</span> <span class="o">==</span> <span class="n">groupby</span> <span class="o">+</span> <span class="s1">&#39; desc&#39;</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">reverse_order</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">group_expand</span><span class="p">)(</span><span class="n">groups</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">name_get</span><span class="p">()</span>
            <span class="n">value2key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># groups is a list of values</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">group_expand</span><span class="p">)(</span><span class="n">values</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">read_group_order</span> <span class="o">==</span> <span class="n">groupby</span> <span class="o">+</span> <span class="s1">&#39; desc&#39;</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">value2key</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span>

        <span class="c1"># Merge the current results (list of dicts) with all groups. Determine</span>
        <span class="c1"># the global order of results groups, which is supposed to be in the</span>
        <span class="c1"># same order as read_group_result (in the case of a many2one field).</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">value2key</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span>

        <span class="c1"># fill in results from read_group_result</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">read_group_result</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">value2key</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">groupby</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">count_field</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">count_field</span><span class="p">]</span>

        <span class="c1"># fill in missing results from all groups</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">value2key</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">aggregated_fields</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">line</span><span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">line</span><span class="p">[</span><span class="n">groupby</span> <span class="o">+</span> <span class="s1">&#39;_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">line</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="n">groupby</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)]</span> <span class="o">+</span> <span class="n">domain</span>
                <span class="k">if</span> <span class="n">remaining_groupbys</span><span class="p">:</span>
                    <span class="n">line</span><span class="p">[</span><span class="s1">&#39;__context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;group_by&#39;</span><span class="p">:</span> <span class="n">remaining_groupbys</span><span class="p">}</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>

        <span class="c1"># add folding information if present</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">relational</span> <span class="ow">and</span> <span class="n">groups</span><span class="o">.</span><span class="n">_fold_name</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">fold</span> <span class="o">=</span> <span class="p">{</span><span class="n">group</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="n">groups</span><span class="o">.</span><span class="n">_fold_name</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span> <span class="k">if</span> <span class="n">key</span><span class="p">])}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">line</span><span class="p">[</span><span class="s1">&#39;__fold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fold</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_group_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orderby</span><span class="p">,</span> <span class="n">aggregated_fields</span><span class="p">,</span> <span class="n">annotated_groupbys</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the GROUP BY and ORDER BY terms for the read_group method. Adds the missing JOIN clause</span>
<span class="sd">        to the query if order should be computed against m2o field. </span>
<span class="sd">        :param orderby: the orderby definition in the form &quot;%(field)s %(order)s&quot;</span>
<span class="sd">        :param aggregated_fields: list of aggregated fields in the query</span>
<span class="sd">        :param annotated_groupbys: list of dictionaries returned by _read_group_process_groupby</span>
<span class="sd">                These dictionaries contains the qualified name of each groupby</span>
<span class="sd">                (fully qualified SQL name for the corresponding field),</span>
<span class="sd">                and the (non raw) field name.</span>
<span class="sd">        :param osv.Query query: the query under construction</span>
<span class="sd">        :return: (groupby_terms, orderby_terms)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orderby_terms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">groupby_terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">gb</span><span class="p">[</span><span class="s1">&#39;qualified_field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">gb</span> <span class="ow">in</span> <span class="n">annotated_groupbys</span><span class="p">]</span>
        <span class="n">groupby_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">gb</span><span class="p">[</span><span class="s1">&#39;groupby&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">gb</span> <span class="ow">in</span> <span class="n">annotated_groupbys</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">orderby</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">groupby_terms</span><span class="p">,</span> <span class="n">orderby_terms</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_qorder</span><span class="p">(</span><span class="n">orderby</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">order_part</span> <span class="ow">in</span> <span class="n">orderby</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">order_split</span> <span class="o">=</span> <span class="n">order_part</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">order_field</span> <span class="o">=</span> <span class="n">order_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">order_field</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span> <span class="ow">or</span> <span class="n">order_field</span> <span class="ow">in</span> <span class="n">groupby_fields</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">order_field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span><span class="p">:</span>
                    <span class="n">order_clause</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_order_by</span><span class="p">(</span><span class="n">order_part</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;ORDER BY &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">order_clause</span><span class="p">:</span>
                        <span class="n">orderby_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order_clause</span><span class="p">)</span>
                        <span class="n">groupby_terms</span> <span class="o">+=</span> <span class="p">[</span><span class="n">order_term</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">order_term</span> <span class="ow">in</span> <span class="n">order_clause</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">order_field</span><span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">order_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">order_split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">orderby_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">order_field</span> <span class="ow">in</span> <span class="n">aggregated_fields</span><span class="p">:</span>
                <span class="n">orderby_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order_part</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Cannot order by a field that will not appear in the results (needs to be grouped or aggregated)</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: read_group order by `</span><span class="si">%s</span><span class="s1">` ignored, cannot sort on empty columns (not grouped/aggregated)&#39;</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">order_part</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">groupby_terms</span><span class="p">,</span> <span class="n">orderby_terms</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_group_process_groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gb</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Helper method to collect important information about groupbys: raw</span>
<span class="sd">            field name, type, time information, qualified name, ...</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">gb</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="n">field_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">type</span>
        <span class="n">gb_function</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">temporal</span> <span class="o">=</span> <span class="n">field_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">)</span>
        <span class="n">tz_convert</span> <span class="o">=</span> <span class="n">field_type</span> <span class="o">==</span> <span class="s1">&#39;datetime&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tz&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pytz</span><span class="o">.</span><span class="n">all_timezones</span>
        <span class="n">qualified_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_join_calc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temporal</span><span class="p">:</span>
            <span class="n">display_formats</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># Careful with week/year formats:</span>
                <span class="c1">#  - yyyy (lower) must always be used, *except* for week+year formats</span>
                <span class="c1">#  - YYYY (upper) must always be used for week+year format</span>
                <span class="c1">#         e.g. 2006-01-01 is W52 2005 in some locales (de_DE),</span>
                <span class="c1">#                         and W1 2006 for others</span>
                <span class="c1">#</span>
                <span class="c1"># Mixing both formats, e.g. &#39;MMM YYYY&#39; would yield wrong results,</span>
                <span class="c1"># such as 2006-01-01 being formatted as &quot;January 2005&quot; in some locales.</span>
                <span class="c1"># Cfr: http://babel.pocoo.org/docs/dates/#date-fields</span>
                <span class="s1">&#39;day&#39;</span><span class="p">:</span> <span class="s1">&#39;dd MMM yyyy&#39;</span><span class="p">,</span> <span class="c1"># yyyy = normal year</span>
                <span class="s1">&#39;week&#39;</span><span class="p">:</span> <span class="s2">&quot;&#39;W&#39;w YYYY&quot;</span><span class="p">,</span>  <span class="c1"># w YYYY = ISO week-year</span>
                <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="s1">&#39;MMMM yyyy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;quarter&#39;</span><span class="p">:</span> <span class="s1">&#39;QQQ yyyy&#39;</span><span class="p">,</span>
                <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="s1">&#39;yyyy&#39;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">time_intervals</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;day&#39;</span><span class="p">:</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="s1">&#39;week&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
                <span class="s1">&#39;month&#39;</span><span class="p">:</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="s1">&#39;quarter&#39;</span><span class="p">:</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">months</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
                <span class="s1">&#39;year&#39;</span><span class="p">:</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">relativedelta</span><span class="o">.</span><span class="n">relativedelta</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">tz_convert</span><span class="p">:</span>
                <span class="n">qualified_field</span> <span class="o">=</span> <span class="s2">&quot;timezone(&#39;</span><span class="si">%s</span><span class="s2">&#39;, timezone(&#39;UTC&#39;,</span><span class="si">%s</span><span class="s2">))&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tz&#39;</span><span class="p">,</span> <span class="s1">&#39;UTC&#39;</span><span class="p">),</span> <span class="n">qualified_field</span><span class="p">)</span>
            <span class="n">qualified_field</span> <span class="o">=</span> <span class="s2">&quot;date_trunc(&#39;</span><span class="si">%s</span><span class="s2">&#39;, </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gb_function</span> <span class="ow">or</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="n">qualified_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_type</span> <span class="o">==</span> <span class="s1">&#39;boolean&#39;</span><span class="p">:</span>
            <span class="n">qualified_field</span> <span class="o">=</span> <span class="s2">&quot;coalesce(</span><span class="si">%s</span><span class="s2">,false)&quot;</span> <span class="o">%</span> <span class="n">qualified_field</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s1">&#39;groupby&#39;</span><span class="p">:</span> <span class="n">gb</span><span class="p">,</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">field_type</span><span class="p">,</span> 
            <span class="s1">&#39;display_format&#39;</span><span class="p">:</span> <span class="n">display_formats</span><span class="p">[</span><span class="n">gb_function</span> <span class="ow">or</span> <span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">temporal</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;interval&#39;</span><span class="p">:</span> <span class="n">time_intervals</span><span class="p">[</span><span class="n">gb_function</span> <span class="ow">or</span> <span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">temporal</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>                
            <span class="s1">&#39;tz_convert&#39;</span><span class="p">:</span> <span class="n">tz_convert</span><span class="p">,</span>
            <span class="s1">&#39;qualified_field&#39;</span><span class="p">:</span> <span class="n">qualified_field</span>
        <span class="p">}</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_group_prepare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">groupby_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Helper method to sanitize the data received by read_group. The None</span>
<span class="sd">            values are converted to False, and the date/datetime are formatted,</span>
<span class="sd">            and corrected according to the timezones.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">value</span>
        <span class="n">gb</span> <span class="o">=</span> <span class="n">groupby_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gb</span> <span class="ow">and</span> <span class="n">gb</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="n">dt_format</span> <span class="o">=</span> <span class="n">DEFAULT_SERVER_DATETIME_FORMAT</span> <span class="k">if</span> <span class="n">gb</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;datetime&#39;</span> <span class="k">else</span> <span class="n">DEFAULT_SERVER_DATE_FORMAT</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dt_format</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gb</span><span class="p">[</span><span class="s1">&#39;tz_convert&#39;</span><span class="p">]:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;tz&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_group_format_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">annotated_groupbys</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Helper method to format the data contained in the dictionary data by </span>
<span class="sd">            adding the domain corresponding to its values, the groupbys in the </span>
<span class="sd">            context and by properly formatting the date/datetime values.</span>

<span class="sd">        :param data: a single group</span>
<span class="sd">        :param annotated_groupbys: expanded grouping metainformation</span>
<span class="sd">        :param groupby: original grouping metainformation</span>
<span class="sd">        :param domain: original domain for read_group</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gb</span> <span class="ow">in</span> <span class="n">annotated_groupbys</span><span class="p">:</span>
            <span class="n">ftype</span> <span class="o">=</span> <span class="n">gb</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">gb</span><span class="p">[</span><span class="s1">&#39;groupby&#39;</span><span class="p">]]</span>

            <span class="c1"># full domain for this groupby spec</span>
            <span class="n">d</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">ftype</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">):</span>
                    <span class="n">locale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;en_US&#39;</span>
                    <span class="n">fmt</span> <span class="o">=</span> <span class="n">DEFAULT_SERVER_DATETIME_FORMAT</span> <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;datetime&#39;</span> <span class="k">else</span> <span class="n">DEFAULT_SERVER_DATE_FORMAT</span>
                    <span class="n">tzinfo</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">range_start</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="n">range_end</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">gb</span><span class="p">[</span><span class="s1">&#39;interval&#39;</span><span class="p">]</span>
                    <span class="c1"># value from postgres is in local tz (so range is</span>
                    <span class="c1"># considered in local tz e.g. &quot;day&quot; is [00:00, 00:00[</span>
                    <span class="c1"># local rather than UTC which could be [11:00, 11:00]</span>
                    <span class="c1"># local) but domain and raw value should be in UTC</span>
                    <span class="k">if</span> <span class="n">gb</span><span class="p">[</span><span class="s1">&#39;tz_convert&#39;</span><span class="p">]:</span>
                        <span class="n">tzinfo</span> <span class="o">=</span> <span class="n">range_start</span><span class="o">.</span><span class="n">tzinfo</span>
                        <span class="n">range_start</span> <span class="o">=</span> <span class="n">range_start</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                        <span class="n">range_end</span> <span class="o">=</span> <span class="n">range_end</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

                    <span class="n">range_start</span> <span class="o">=</span> <span class="n">range_start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
                    <span class="n">range_end</span> <span class="o">=</span> <span class="n">range_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;datetime&#39;</span><span class="p">:</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">babel</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">format_datetime</span><span class="p">(</span>
                            <span class="n">value</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">gb</span><span class="p">[</span><span class="s1">&#39;display_format&#39;</span><span class="p">],</span>
                            <span class="n">tzinfo</span><span class="o">=</span><span class="n">tzinfo</span><span class="p">,</span> <span class="n">locale</span><span class="o">=</span><span class="n">locale</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">babel</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">format_date</span><span class="p">(</span>
                            <span class="n">value</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">gb</span><span class="p">[</span><span class="s1">&#39;display_format&#39;</span><span class="p">],</span>
                            <span class="n">locale</span><span class="o">=</span><span class="n">locale</span>
                        <span class="p">)</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">gb</span><span class="p">[</span><span class="s1">&#39;groupby&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">range_start</span><span class="p">,</span> <span class="n">range_end</span><span class="p">),</span> <span class="n">label</span><span class="p">)</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s1">&#39;&amp;&#39;</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">gb</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">],</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">range_start</span><span class="p">),</span>
                        <span class="p">(</span><span class="n">gb</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">],</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="n">range_end</span><span class="p">),</span>
                    <span class="p">]</span>

            <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="p">[(</span><span class="n">gb</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">],</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span>
            <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;__domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groupby</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotated_groupbys</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;__context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;group_by&#39;</span><span class="p">:</span> <span class="n">groupby</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">annotated_groupbys</span><span class="p">):]}</span>
        <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">read_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the list of records in list view grouped by the given ``groupby`` fields</span>

<span class="sd">        :param domain: list specifying search criteria [[&#39;field_name&#39;, &#39;operator&#39;, &#39;value&#39;], ...]</span>
<span class="sd">        :param list fields: list of fields present in the list view specified on the object</span>
<span class="sd">        :param list groupby: list of groupby descriptions by which the records will be grouped.  </span>
<span class="sd">                A groupby description is either a field (then it will be grouped by that field)</span>
<span class="sd">                or a string &#39;field:groupby_function&#39;.  Right now, the only functions supported</span>
<span class="sd">                are &#39;day&#39;, &#39;week&#39;, &#39;month&#39;, &#39;quarter&#39; or &#39;year&#39;, and they only make sense for </span>
<span class="sd">                date/datetime fields.</span>
<span class="sd">        :param int offset: optional number of records to skip</span>
<span class="sd">        :param int limit: optional max number of records to return</span>
<span class="sd">        :param list orderby: optional ``order by`` specification, for</span>
<span class="sd">                             overriding the natural sort ordering of the</span>
<span class="sd">                             groups, see also :py:meth:`~osv.osv.osv.search`</span>
<span class="sd">                             (supported only for many2one fields currently)</span>
<span class="sd">        :param bool lazy: if true, the results are only grouped by the first groupby and the </span>
<span class="sd">                remaining groupbys are put in the __context key.  If false, all the groupbys are</span>
<span class="sd">                done in one call.</span>
<span class="sd">        :return: list of dictionaries(one dictionary for each record) containing:</span>

<span class="sd">                    * the values of fields grouped by the fields in ``groupby`` argument</span>
<span class="sd">                    * __domain: list of tuples specifying the search criteria</span>
<span class="sd">                    * __context: dictionary with argument like ``groupby``</span>
<span class="sd">        :rtype: [{&#39;field_name_1&#39;: value, ...]</span>
<span class="sd">        :raise AccessError: * if user has no read rights on the requested object</span>
<span class="sd">                            * if user tries to bypass access rules for read on the requested object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_raw</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="n">orderby</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="n">lazy</span><span class="p">)</span>

        <span class="n">groupby</span> <span class="o">=</span> <span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">OrderedSet</span><span class="p">(</span><span class="n">groupby</span><span class="p">))</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">groupby</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># iterate on all results and replace the &quot;full&quot; date/datetime value</span>
        <span class="c1"># (range, label) by just the formatted label, in-place</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
                <span class="c1"># could group on a date(time) field which is empty in some</span>
                <span class="c1"># records, in which case as with m2o the _raw value will be</span>
                <span class="c1"># `False` instead of a (value, label) pair. In that case,</span>
                <span class="c1"># leave the `False` value alone</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
                    <span class="n">group</span><span class="p">[</span><span class="n">df</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">df</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_read_group_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">orderby</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where_calc</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span> <span class="ow">or</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">store</span><span class="p">]</span>

        <span class="n">groupby</span> <span class="o">=</span> <span class="p">[</span><span class="n">groupby</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groupby</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">string_types</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">OrderedSet</span><span class="p">(</span><span class="n">groupby</span><span class="p">))</span>
        <span class="n">groupby_list</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">lazy</span> <span class="k">else</span> <span class="n">groupby</span>
        <span class="n">annotated_groupbys</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_group_process_groupby</span><span class="p">(</span><span class="n">gb</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span> <span class="k">for</span> <span class="n">gb</span> <span class="ow">in</span> <span class="n">groupby_list</span><span class="p">]</span>
        <span class="n">groupby_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">annotated_groupbys</span><span class="p">]</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">orderby</span> <span class="ow">or</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groupby_list</span><span class="p">])</span>
        <span class="n">groupby_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">gb</span><span class="p">[</span><span class="s1">&#39;groupby&#39;</span><span class="p">]:</span> <span class="n">gb</span> <span class="k">for</span> <span class="n">gb</span> <span class="ow">in</span> <span class="n">annotated_groupbys</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ir_rules</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">gb</span> <span class="ow">in</span> <span class="n">groupby_fields</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">gb</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">,</span> <span class="s2">&quot;Fields in &#39;groupby&#39; must appear in the list of fields to read (perhaps it&#39;s missing in the list view?)&quot;</span>
            <span class="k">assert</span> <span class="n">gb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> <span class="s2">&quot;Unknown field </span><span class="si">%r</span><span class="s2"> in &#39;groupby&#39;&quot;</span> <span class="o">%</span> <span class="n">gb</span>
            <span class="n">gb_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">gb</span><span class="p">]</span><span class="o">.</span><span class="n">base_field</span>
            <span class="k">assert</span> <span class="n">gb_field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">gb_field</span><span class="o">.</span><span class="n">column_type</span><span class="p">,</span> <span class="s2">&quot;Fields in &#39;groupby&#39; must be regular database-persisted fields (no function or related fields), or function fields with store=True&quot;</span>

        <span class="n">aggregated_fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="s1">&#39;sequence&#39;</span>
            <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groupby_fields</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">field</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">group_operator</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">base_field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">base_field</span><span class="o">.</span><span class="n">column_type</span>
        <span class="p">]</span>

        <span class="n">field_formatter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">group_operator</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_join_calc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">query</span><span class="p">),</span>
            <span class="n">f</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">select_terms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">) AS &quot;</span><span class="si">%s</span><span class="s1">&quot; &#39;</span> <span class="o">%</span> <span class="n">field_formatter</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">aggregated_fields</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">gb</span> <span class="ow">in</span> <span class="n">annotated_groupbys</span><span class="p">:</span>
            <span class="n">select_terms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> as &quot;</span><span class="si">%s</span><span class="s1">&quot; &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gb</span><span class="p">[</span><span class="s1">&#39;qualified_field&#39;</span><span class="p">],</span> <span class="n">gb</span><span class="p">[</span><span class="s1">&#39;groupby&#39;</span><span class="p">]))</span>

        <span class="n">groupby_terms</span><span class="p">,</span> <span class="n">orderby_terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_prepare</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">aggregated_fields</span><span class="p">,</span> <span class="n">annotated_groupbys</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">from_clause</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_clause_params</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">get_sql</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lazy</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">groupby_fields</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group_by_no_leaf&#39;</span><span class="p">)):</span>
            <span class="n">count_field</span> <span class="o">=</span> <span class="n">groupby_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groupby_fields</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;_&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">count_field</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span>
        <span class="n">count_field</span> <span class="o">+=</span> <span class="s1">&#39;_count&#39;</span>

        <span class="n">prefix_terms</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">terms</span><span class="p">))</span> <span class="k">if</span> <span class="n">terms</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">prefix_term</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">term</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">term</span><span class="p">))</span> <span class="k">if</span> <span class="n">term</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT min(&quot;</span><span class="si">%(table)s</span><span class="s2">&quot;.id) AS id, count(&quot;</span><span class="si">%(table)s</span><span class="s2">&quot;.id) AS &quot;</span><span class="si">%(count_field)s</span><span class="s2">&quot; </span><span class="si">%(extra_fields)s</span><span class="s2"></span>
<span class="s2">            FROM </span><span class="si">%(from)s</span><span class="s2"></span>
<span class="s2">            </span><span class="si">%(where)s</span><span class="s2"></span>
<span class="s2">            </span><span class="si">%(groupby)s</span><span class="s2"></span>
<span class="s2">            </span><span class="si">%(orderby)s</span><span class="s2"></span>
<span class="s2">            </span><span class="si">%(limit)s</span><span class="s2"></span>
<span class="s2">            </span><span class="si">%(offset)s</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span>
            <span class="s1">&#39;table&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span>
            <span class="s1">&#39;count_field&#39;</span><span class="p">:</span> <span class="n">count_field</span><span class="p">,</span>
            <span class="s1">&#39;extra_fields&#39;</span><span class="p">:</span> <span class="n">prefix_terms</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">select_terms</span><span class="p">),</span>
            <span class="s1">&#39;from&#39;</span><span class="p">:</span> <span class="n">from_clause</span><span class="p">,</span>
            <span class="s1">&#39;where&#39;</span><span class="p">:</span> <span class="n">prefix_term</span><span class="p">(</span><span class="s1">&#39;WHERE&#39;</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">),</span>
            <span class="s1">&#39;groupby&#39;</span><span class="p">:</span> <span class="n">prefix_terms</span><span class="p">(</span><span class="s1">&#39;GROUP BY&#39;</span><span class="p">,</span> <span class="n">groupby_terms</span><span class="p">),</span>
            <span class="s1">&#39;orderby&#39;</span><span class="p">:</span> <span class="n">prefix_terms</span><span class="p">(</span><span class="s1">&#39;ORDER BY&#39;</span><span class="p">,</span> <span class="n">orderby_terms</span><span class="p">),</span>
            <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="n">prefix_term</span><span class="p">(</span><span class="s1">&#39;LIMIT&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;offset&#39;</span><span class="p">:</span> <span class="n">prefix_term</span><span class="p">(</span><span class="s1">&#39;OFFSET&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="k">if</span> <span class="n">limit</span> <span class="k">else</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">where_clause_params</span><span class="p">)</span>
        <span class="n">fetched_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">groupby_fields</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fetched_data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_resolve_many2one_fields</span><span class="p">(</span><span class="n">fetched_data</span><span class="p">,</span> <span class="n">annotated_groupbys</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_prepare_data</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">,</span> <span class="n">groupby_dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">fetched_data</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_read_group_format_result</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">annotated_groupbys</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">lazy</span><span class="p">:</span>
            <span class="c1"># Right now, read_group only fill results in lazy mode (by default).</span>
            <span class="c1"># If you need to have the empty groups in &#39;eager&#39; mode, then the</span>
            <span class="c1"># method _read_group_fill_results need to be completely reimplemented</span>
            <span class="c1"># in a sane way </span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_group_fill_results</span><span class="p">(</span>
                <span class="n">domain</span><span class="p">,</span> <span class="n">groupby_fields</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">groupby</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">annotated_groupbys</span><span class="p">):],</span>
                <span class="n">aggregated_fields</span><span class="p">,</span> <span class="n">count_field</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">read_group_order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_read_group_resolve_many2one_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="n">many2onefields</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">many2onefields</span><span class="p">:</span>
            <span class="n">ids_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">d</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">field</span><span class="p">]}</span>
            <span class="n">m2o_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids_set</span><span class="p">)</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">m2o_records</span><span class="o">.</span><span class="n">name_get</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="n">field</span><span class="p">]])</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_inherits_join_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_model</span><span class="p">,</span> <span class="n">parent_model_name</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add missing table SELECT and JOIN clause to ``query`` for reaching the parent table (no duplicates)</span>
<span class="sd">        :param current_model: current model object</span>
<span class="sd">        :param parent_model_name: name of the parent model for which the clauses should be added</span>
<span class="sd">        :param query: query object on which the JOIN should be added</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inherits_field</span> <span class="o">=</span> <span class="n">current_model</span><span class="o">.</span><span class="n">_inherits</span><span class="p">[</span><span class="n">parent_model_name</span><span class="p">]</span>
        <span class="n">parent_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent_model_name</span><span class="p">]</span>
        <span class="n">parent_alias</span><span class="p">,</span> <span class="n">parent_alias_statement</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">add_join</span><span class="p">((</span><span class="n">current_model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">inherits_field</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">inherits_field</span><span class="p">),</span> <span class="n">implicit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parent_alias</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_inherits_join_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">implicit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds missing table select and join clause(s) to ``query`` for reaching</span>
<span class="sd">        the field coming from an &#39;_inherits&#39; parent table (no duplicates).</span>

<span class="sd">        :param alias: name of the initial SQL alias</span>
<span class="sd">        :param fname: name of inherited field to reach</span>
<span class="sd">        :param query: query object on which the JOIN should be added</span>
<span class="sd">        :return: qualified name of field, to be used in SELECT clause</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># INVARIANT: alias is the SQL alias of model._table in query</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
            <span class="c1"># retrieve the parent model where field is inherited from</span>
            <span class="n">parent_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">related_field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span>
            <span class="n">parent_fname</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># JOIN parent_model._table AS parent_alias ON alias.parent_fname = parent_alias.id</span>
            <span class="n">parent_alias</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">add_join</span><span class="p">(</span>
                <span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">parent_model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">parent_fname</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">parent_fname</span><span class="p">),</span>
                <span class="n">implicit</span><span class="o">=</span><span class="n">implicit</span><span class="p">,</span> <span class="n">outer</span><span class="o">=</span><span class="n">outer</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">parent_model</span><span class="p">,</span> <span class="n">parent_alias</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">related_field</span>
        <span class="c1"># handle the case where the field is translated</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_generate_translated_field</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;.&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model_cr</span>
    <span class="k">def</span> <span class="nf">_parent_store_compute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing parent left and right for table </span><span class="si">%s</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">select</span> <span class="o">=</span> <span class="s2">&quot;SELECT id FROM </span><span class="si">%s</span><span class="s2"> WHERE </span><span class="si">%s</span><span class="s2">=</span><span class="si">%%</span><span class="s2">s ORDER BY </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_order</span><span class="p">)</span>
        <span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;UPDATE </span><span class="si">%s</span><span class="s2"> SET parent_left=</span><span class="si">%%</span><span class="s2">s, parent_right=</span><span class="si">%%</span><span class="s2">s WHERE id=</span><span class="si">%%</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>

        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">left</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Set root.parent_left to ``left``, and return root.parent_right + 1 &quot;&quot;&quot;</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">,</span> <span class="p">(</span><span class="n">root</span><span class="p">,))</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="p">(</span><span class="nb">id</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">root</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">right</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">select0</span> <span class="o">=</span> <span class="s2">&quot;SELECT id FROM </span><span class="si">%s</span><span class="s2"> WHERE </span><span class="si">%s</span><span class="s2"> IS NULL ORDER BY </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_order</span><span class="p">)</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select0</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="p">(</span><span class="nb">id</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">([</span><span class="s1">&#39;parent_left&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_right&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_check_selection_field_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check whether value is among the valid values for the given</span>
<span class="sd">            selection/reference field, and raise an exception if not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
        <span class="n">field</span><span class="o">.</span><span class="n">convert_to_cache</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model_cr</span>
    <span class="k">def</span> <span class="nf">_check_removed_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># iterate on the database columns to drop the NOT NULL constraints of</span>
        <span class="c1"># fields which were required but have been removed (or will be added by</span>
        <span class="c1"># another module)</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                     <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span><span class="p">]</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT a.attname, a.attnotnull&quot;</span>
                   <span class="s2">&quot;  FROM pg_class c, pg_attribute a&quot;</span>
                   <span class="s2">&quot; WHERE c.relname=</span><span class="si">%s</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;   AND c.oid=a.attrelid&quot;</span>
                   <span class="s2">&quot;   AND a.attisdropped=</span><span class="si">%s</span><span class="s2">&quot;</span>
                   <span class="s2">&quot;   AND pg_catalog.format_type(a.atttypid, a.atttypmod) NOT IN (&#39;cid&#39;, &#39;tid&#39;, &#39;oid&#39;, &#39;xid&#39;)&quot;</span>
                   <span class="s2">&quot;   AND a.attname NOT IN </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">cols</span><span class="p">))),</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;column </span><span class="si">%s</span><span class="s2"> is in the table </span><span class="si">%s</span><span class="s2"> but not in the corresponding object </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                              <span class="n">row</span><span class="p">[</span><span class="s1">&#39;attname&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;attnotnull&#39;</span><span class="p">]:</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">drop_not_null</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;attname&#39;</span><span class="p">])</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model_cr_context</span>
    <span class="k">def</span> <span class="nf">_init_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize the value of the given column for existing rows. &quot;&quot;&quot;</span>
        <span class="c1"># get the default value; ideally, we should use default_get(), but it</span>
        <span class="c1"># fails due to ir.default not being ready</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_cache</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_record</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_column</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Write value if non-NULL, except for booleans for which False means</span>
        <span class="c1"># the same as NULL - this saves us an expensive query on large tables.</span>
        <span class="n">necessary</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s1">&#39;boolean&#39;</span> <span class="k">else</span> <span class="n">value</span>
        <span class="k">if</span> <span class="n">necessary</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Table &#39;</span><span class="si">%s</span><span class="s2">&#39;: setting default value of new column </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE &quot;</span><span class="si">%s</span><span class="s1">&quot; SET &quot;</span><span class="si">%s</span><span class="s1">&quot;=</span><span class="si">%s</span><span class="s1"> WHERE &quot;</span><span class="si">%s</span><span class="s1">&quot; IS NULL&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">column_format</span><span class="p">,</span> <span class="n">column_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span><span class="p">,))</span>

    <span class="nd">@ormcache</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_table_has_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return whether the model&#39;s table has rows. This method should only</span>
<span class="sd">            be used when updating the database schema (:meth:`~._auto_init`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT 1 FROM &quot;</span><span class="si">%s</span><span class="s1">&quot; LIMIT 1&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model_cr_context</span>
    <span class="k">def</span> <span class="nf">_auto_init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialize the database schema of ``self``:</span>
<span class="sd">            - create the corresponding table,</span>
<span class="sd">            - create/update the necessary columns/tables for fields,</span>
<span class="sd">            - initialize new columns on existing rows,</span>
<span class="sd">            - add the SQL constraints given on the model,</span>
<span class="sd">            - add the indexes on indexed fields,</span>

<span class="sd">            Also prepare post-init stuff to:</span>
<span class="sd">            - add foreign key constraints,</span>
<span class="sd">            - reflect models, fields, relations and constraints,</span>
<span class="sd">            - mark fields to recompute on existing records.</span>

<span class="sd">            Note: you should not override this method. Instead, you can modify</span>
<span class="sd">            the model&#39;s database schema by overriding method :meth:`~.init`,</span>
<span class="sd">            which is called right after this one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">raise_on_invalid_object_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="c1"># This prevents anything called by this method (in particular default</span>
        <span class="c1"># values) from prefetching a field for which the corresponding column</span>
        <span class="c1"># has not been added in database yet!</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">prefetch_fields</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">post_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reflect</span><span class="p">)</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">parent_store_compute</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">update_custom_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;update_custom_fields&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">must_create_table</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">tools</span><span class="o">.</span><span class="n">table_exists</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">must_create_table</span><span class="p">:</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">create_model_table</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">tools</span><span class="o">.</span><span class="n">column_exists</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s1">&#39;parent_left&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_create_parent_columns</span><span class="p">()</span>
                    <span class="n">parent_store_compute</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_check_removed_columns</span><span class="p">(</span><span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># update the database schema for fields</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">table_columns</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">recompute</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Storing computed values of </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">active_test</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">search</span><span class="p">([])</span>
                <span class="n">recs</span><span class="o">.</span><span class="n">_recompute_todo</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">manual</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">update_custom_fields</span><span class="p">:</span>
                    <span class="k">continue</span>            <span class="c1"># don&#39;t update custom fields</span>

                <span class="n">new</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">update_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">new</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">compute</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">post_init</span><span class="p">(</span><span class="n">recompute</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_auto</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_sql_constraints</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">must_create_table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_execute_sql</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">parent_store_compute</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store_compute</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model_cr</span>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; This method is called after :meth:`~._auto_init`, and may be</span>
<span class="sd">            overridden to create or modify a model&#39;s database schema.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model_cr</span>
    <span class="k">def</span> <span class="nf">_create_parent_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">create_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s1">&#39;parent_left&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">)</span>
        <span class="n">tools</span><span class="o">.</span><span class="n">create_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s1">&#39;parent_right&#39;</span><span class="p">,</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;parent_left&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;add a field parent_left on model </span><span class="si">%s</span><span class="s2">: parent_left = fields.Integer(&#39;Left Parent&#39;, index=True)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;parent_left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;parent_left field on model </span><span class="si">%s</span><span class="s1"> must be indexed! Add index=True to the field definition)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;parent_right&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;add a field parent_right on model </span><span class="si">%s</span><span class="s2">: parent_right = fields.Integer(&#39;Left Parent&#39;, index=True)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;parent_right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;parent_right field on model </span><span class="si">%s</span><span class="s2"> must be indexed! Add index=True to the field definition)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">]</span><span class="o">.</span><span class="n">ondelete</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;cascade&#39;</span><span class="p">,</span> <span class="s1">&#39;restrict&#39;</span><span class="p">):</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;The field </span><span class="si">%s</span><span class="s2"> on model </span><span class="si">%s</span><span class="s2"> must be set as ondelete=&#39;cascade&#39; or &#39;restrict&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model_cr</span>
    <span class="k">def</span> <span class="nf">_add_sql_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Modify this model&#39;s database table constraints so they match the one in</span>
<span class="sd">        _sql_constraints.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">foreign_key_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s*foreign\s+key\b.*&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">cons_text</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">txt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; (&#39;</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">definition</span><span class="p">):</span>
            <span class="n">conname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">has_definition</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">constraint_definition</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">conname</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">has_definition</span><span class="p">:</span>
                <span class="c1"># constraint does not exists</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">conname</span><span class="p">,</span> <span class="n">definition</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">cons_text</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cons_text</span><span class="p">(</span><span class="n">has_definition</span><span class="p">):</span>
                <span class="c1"># constraint exists but its definition may have changed</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">drop_constraint</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">conname</span><span class="p">)</span>
                <span class="n">tools</span><span class="o">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">conname</span><span class="p">,</span> <span class="n">definition</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sql_constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">foreign_key_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">definition</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">post_init</span><span class="p">(</span><span class="n">process</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">definition</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">process</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">definition</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model_cr</span>
    <span class="k">def</span> <span class="nf">_execute_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Execute the SQL code from the _sql attribute (if any).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_sql&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sql</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Update objects that uses this one to update their _inherits fields</span>
    <span class="c1">#</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_add_inherited_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determine inherited fields. &quot;&quot;&quot;</span>
        <span class="c1"># determine candidate inherited fields</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">parent_model</span><span class="p">,</span> <span class="n">parent_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent_model</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># inherited fields are implemented as related fields, with the</span>
                <span class="c1"># following specific properties:</span>
                <span class="c1">#  - reading inherited fields should not bypass access rights</span>
                <span class="c1">#  - copy inherited fields iff their original field is copied</span>
                <span class="n">fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
                    <span class="n">inherited</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">related</span><span class="o">=</span><span class="p">(</span><span class="n">parent_field</span><span class="p">,</span> <span class="n">name</span><span class="p">),</span>
                    <span class="n">related_sudo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">copy</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># add inherited fields that are not redefined locally</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_inherits_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">table</span><span class="p">,</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Missing many2one field definition for _inherits reference &quot;</span><span class="si">%s</span><span class="s1">&quot; in &quot;</span><span class="si">%s</span><span class="s1">&quot;, using default one.&#39;</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">.fields</span> <span class="k">import</span> <span class="n">Many2one</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">Many2one</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s2">&quot;Automatically created field to link to parent </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">table</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s2">&quot;cascade&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">required</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">ondelete</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cascade&quot;</span><span class="p">,</span> <span class="s2">&quot;restrict&quot;</span><span class="p">):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Field definition for _inherits reference &quot;</span><span class="si">%s</span><span class="s1">&quot; in &quot;</span><span class="si">%s</span><span class="s1">&quot; must be marked as &quot;required&quot; with ondelete=&quot;cascade&quot; or &quot;restrict&quot;, forcing it to required + cascade.&#39;</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="n">field</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">field</span><span class="o">.</span><span class="n">ondelete</span> <span class="o">=</span> <span class="s2">&quot;cascade&quot;</span>

        <span class="c1"># reflect fields with delegate=True in dictionary self._inherits</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">delegate</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">required</span><span class="p">:</span>
                    <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Field </span><span class="si">%s</span><span class="s2"> with delegate=True must be required.&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">ondelete</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;cascade&#39;</span><span class="p">,</span> <span class="s1">&#39;restrict&#39;</span><span class="p">):</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">ondelete</span> <span class="o">=</span> <span class="s1">&#39;cascade&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_prepare_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Prepare the setup of the model. &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_setup_done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># a model&#39;s base structure depends on its mro (without registry classes)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_model_cache_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">mro</span><span class="p">()</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;pool&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_setup_base</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determine the inherited and custom fields of the model. &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_setup_done</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># 1. determine the proper fields of the model: the fields defined on the</span>
        <span class="c1"># class and magic fields, not the inherited or custom ones</span>
        <span class="n">cls0</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">model_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_model_cache_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cls0</span> <span class="ow">and</span> <span class="n">cls0</span><span class="o">.</span><span class="n">_model_cache_key</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_model_cache_key</span><span class="p">:</span>
            <span class="c1"># cls0 is either a model class from another registry, or cls itself.</span>
            <span class="c1"># The point is that it has the same base classes. We retrieve stuff</span>
            <span class="c1"># from cls0 to optimize the setup of cls. cls0 is guaranteed to be</span>
            <span class="c1"># properly set up: registries are loaded under a global lock,</span>
            <span class="c1"># therefore two registries are never set up at the same time.</span>

            <span class="c1"># remove fields that are not proper to cls</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">OrderedSet</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">-</span> <span class="n">cls0</span><span class="o">.</span><span class="n">_proper_fields</span><span class="p">:</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># collect proper fields on cls0, and add them on cls</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cls0</span><span class="o">.</span><span class="n">_proper_fields</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">cls0</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="c1"># regular fields are shared, while related fields are setup from scratch</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">**</span><span class="n">field</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_proper_fields</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># retrieve fields from parent classes, and duplicate them on cls to</span>
            <span class="c1"># avoid clashes with inheritance between different models</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">Field</span><span class="o">.</span><span class="fm">__instancecheck__</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_sequence</span><span class="p">):</span>
                <span class="c1"># do not retrieve magic, custom and inherited fields</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;automatic&#39;</span><span class="p">,</span> <span class="s1">&#39;manual&#39;</span><span class="p">,</span> <span class="s1">&#39;inherited&#39;</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_field</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">new</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_magic_fields</span><span class="p">()</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_proper_fields</span> <span class="o">=</span> <span class="n">OrderedSet</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">model_cache</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_model_cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>

        <span class="c1"># 2. add manual fields</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_init_modules</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_add_manual_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># 3. make sure that parent models determine their own fields, then add</span>
        <span class="c1"># inherited fields to cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_check</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span><span class="o">.</span><span class="n">_setup_base</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_inherited_fields</span><span class="p">()</span>

        <span class="c1"># 4. initialize more field metadata</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_field_computed</span> <span class="o">=</span> <span class="p">{}</span>            <span class="c1"># fields computed with the same method</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_field_inverses</span> <span class="o">=</span> <span class="n">Collector</span><span class="p">()</span>   <span class="c1"># inverse fields for related fields</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_field_triggers</span> <span class="o">=</span> <span class="n">Collector</span><span class="p">()</span>   <span class="c1"># list of (field, path) to invalidate</span>

        <span class="bp">cls</span><span class="o">.</span><span class="n">_setup_done</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_setup_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Setup the fields, except for recomputation triggers. &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># set up fields</span>
        <span class="n">bad_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">setup_full</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">loaded</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">manual</span><span class="p">:</span>
                    <span class="c1"># Something goes wrong when setup a manual field.</span>
                    <span class="c1"># This can happen with related fields using another manual many2one field</span>
                    <span class="c1"># that hasn&#39;t been loaded because the comodel does not exist yet.</span>
                    <span class="c1"># This can also be a manual function field depending on not loaded fields yet.</span>
                    <span class="n">bad_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">raise</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">bad_fields</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># map each field to the fields computed with the same method</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">compute</span><span class="p">:</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">_field_computed</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">compute</span><span class="p">]</span>
                <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">compute_sudo</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compute_sudo</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">compute_sudo</span> <span class="o">==</span> <span class="n">compute_sudo</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: inconsistent &#39;compute_sudo&#39; for computed fields: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_setup_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Setup recomputation triggers, and complete the model setup. &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
            <span class="c1"># set up field triggers (on database-persisted models only)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="c1"># dependencies of custom fields may not exist; ignore that case</span>
                <span class="n">exceptions</span> <span class="o">=</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,)</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">manual</span> <span class="k">else</span> <span class="p">()</span>
                <span class="k">with</span> <span class="n">tools</span><span class="o">.</span><span class="n">ignore</span><span class="p">(</span><span class="o">*</span><span class="n">exceptions</span><span class="p">):</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">setup_triggers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># register constraints and onchange methods</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_init_constraints_onchanges</span><span class="p">()</span>

        <span class="c1"># validate rec_name</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_rec_name</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">,</span> \
                <span class="s2">&quot;Invalid rec_name </span><span class="si">%s</span><span class="s2"> for model </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_rec_name</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;name&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_rec_name</span> <span class="o">=</span> <span class="s1">&#39;name&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;x_name&#39;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_rec_name</span> <span class="o">=</span> <span class="s1">&#39;x_name&#39;</span>

        <span class="c1"># make sure parent_order is set when necessary</span>
        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parent_store</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_parent_order</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_parent_order</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_order</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">fields_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allfields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; fields_get([fields][, attributes])</span>

<span class="sd">        Return the definition of each field.</span>

<span class="sd">        The returned value is a dictionary (indiced by field name) of</span>
<span class="sd">        dictionaries. The _inherits&#39;d fields are included. The string, help,</span>
<span class="sd">        and selection (if present) attributes are translated.</span>

<span class="sd">        :param allfields: list of fields to document, all if empty or not provided</span>
<span class="sd">        :param attributes: list of description attributes to return for each field, all if empty or not provided</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">has_access</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">readonly</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="n">has_access</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">has_access</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">allfields</span> <span class="ow">and</span> <span class="n">fname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allfields</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">groups</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">description</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_description</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">readonly</span><span class="p">:</span>
                <span class="n">description</span><span class="p">[</span><span class="s1">&#39;readonly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">description</span><span class="p">[</span><span class="s1">&#39;states&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">attributes</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span>
                               <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">description</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                               <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">}</span>
            <span class="n">res</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">get_empty_list_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">help</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generic method giving the help message displayed when having</span>
<span class="sd">            no result to display in a list or kanban view. By default it returns</span>
<span class="sd">            the help given in parameter that is generally the help message</span>
<span class="sd">            defined in the action.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">help</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">check_field_access_rights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the user access rights on the given fields. This raises Access</span>
<span class="sd">        Denied if the user does not have the rights. Otherwise it returns the</span>
<span class="sd">        fields (as is if the fields is not falsy, or the readable/writable</span>
<span class="sd">        fields if fields is falsy).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span> <span class="o">==</span> <span class="n">SUPERUSER_ID</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fields</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">valid</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; determine whether user has access to field ``fname`` &quot;&quot;&quot;</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="k">if</span> <span class="n">valid</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">invalid_fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">(</span><span class="n">name</span><span class="p">)}</span>
            <span class="k">if</span> <span class="n">invalid_fields</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Access Denied by ACLs for operation: </span><span class="si">%s</span><span class="s1">, uid: </span><span class="si">%s</span><span class="s1">, model: </span><span class="si">%s</span><span class="s1">, fields: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">operation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">invalid_fields</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The requested operation cannot be completed due to security restrictions. &#39;</span>
                                    <span class="s1">&#39;Please contact your system administrator.</span><span class="se">\n\n</span><span class="s1">(Document type: </span><span class="si">%s</span><span class="s1">, Operation: </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">)</span> <span class="o">%</span> \
                                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">,</span> <span class="n">operation</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">fields</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="s1">&#39;_classic_read&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; read([fields])</span>

<span class="sd">        Reads the requested fields for the records in ``self``, low-level/RPC</span>
<span class="sd">        method. In Python code, prefer :meth:`~.browse`.</span>

<span class="sd">        :param fields: list of field names to return (default is all fields)</span>
<span class="sd">        :return: a list of dictionaries mapping field names to their values,</span>
<span class="sd">                 with one dictionary per record</span>
<span class="sd">        :raise AccessError: if user has no read rights on some of the given</span>
<span class="sd">                records</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check access rights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_field_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

        <span class="c1"># split fields into stored and computed fields</span>
        <span class="n">stored</span><span class="p">,</span> <span class="n">inherited</span><span class="p">,</span> <span class="n">computed</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                    <span class="n">stored</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">base_field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                    <span class="n">inherited</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">computed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.read() with unknown field &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># fetch stored fields from the database to the cache; this should feed</span>
        <span class="c1"># the prefetching of secondary records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_from_database</span><span class="p">(</span><span class="n">stored</span><span class="p">,</span> <span class="n">inherited</span><span class="p">)</span>

        <span class="c1"># retrieve results from records; this takes values from the cache and</span>
        <span class="c1"># computes remaining fields</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">name_fields</span> <span class="o">=</span> <span class="p">[(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">stored</span> <span class="o">+</span> <span class="n">inherited</span> <span class="o">+</span> <span class="n">computed</span><span class="p">)]</span>
        <span class="n">use_name_get</span> <span class="o">=</span> <span class="p">(</span><span class="n">load</span> <span class="o">==</span> <span class="s1">&#39;_classic_read&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">name_fields</span><span class="p">:</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_read</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">record</span><span class="p">,</span> <span class="n">use_name_get</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">MissingError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">_prefetch_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read from the database in order to fetch ``field`` (:class:`Field`</span>
<span class="sd">            instance) for ``self`` in cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># fetch the records of this model without field_name in their cache</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_cache_without</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="c1"># determine which fields can be prefetched</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prefetch_fields&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">prefetch</span><span class="p">:</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">f</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="c1"># select fields that can be prefetched</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">prefetch</span>
                <span class="c1"># discard fields with groups that the user may not access</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">groups</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_has_groups</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">groups</span><span class="p">))</span>
                <span class="c1"># discard fields that must be recomputed</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">compute</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">field_todo</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="p">)</span>

        <span class="c1"># special case: discard records to recompute for field</span>
        <span class="n">records</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">field_todo</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="c1"># in onchange mode, discard computed fields and fields in cache</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">in_onchange</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">compute</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                    <span class="n">fs</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">records</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_cache_without</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># fetch records with read()</span>
        <span class="k">assert</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">records</span> <span class="ow">and</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fs</span>
        <span class="n">records</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">with_prefetch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_prefetch</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">],</span> <span class="n">load</span><span class="o">=</span><span class="s1">&#39;_classic_write&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">AccessError</span><span class="p">:</span>
            <span class="c1"># not all records may be accessible, try with only current record</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">],</span> <span class="n">load</span><span class="o">=</span><span class="s1">&#39;_classic_write&#39;</span><span class="p">)</span>

        <span class="c1"># check the cache, and update it if necessary</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">contains_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch</span><span class="p">)</span>
                <span class="n">record</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">_convert_to_cache</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="n">AccessError</span><span class="p">(</span><span class="s2">&quot;No value found for </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">_read_from_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">inherited_field_names</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&quot;&quot;&quot; Read the given fields of the records in ``self`` from the database,</span>
<span class="sd">            and store them in cache. Access errors are also stored in cache.</span>

<span class="sd">            :param field_names: list of column names of model ``self``; all those</span>
<span class="sd">                fields are guaranteed to be read</span>
<span class="sd">            :param inherited_field_names: list of column names from parent</span>
<span class="sd">                models; some of those fields may not be read</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
        <span class="n">cr</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">args</span>

        <span class="c1"># make a query object for selecting ids, and apply security rules to it</span>
        <span class="n">param_ids</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Query</span><span class="p">([</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;.id IN </span><span class="si">%%</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">],</span> <span class="p">[</span><span class="n">param_ids</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ir_rules</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">)</span>

        <span class="c1"># determine the fields that are stored as columns in tables; ignore &#39;id&#39;</span>
        <span class="n">fields_pre</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">field</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">field_names</span> <span class="o">+</span> <span class="n">inherited_field_names</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;id&#39;</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">base_field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">base_field</span><span class="o">.</span><span class="n">column_type</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">inherited</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">base_field</span><span class="o">.</span><span class="n">translate</span><span class="p">))</span>
        <span class="p">]</span>

        <span class="c1"># the query may involve several tables: we need fully-qualified names</span>
        <span class="k">def</span> <span class="nf">qualify</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_join_calc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;binary&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bin_size&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bin_size_&#39;</span> <span class="o">+</span> <span class="n">col</span><span class="p">)):</span>
                <span class="c1"># PG 9.2 introduces conflicting pg_size_pretty(numeric) -&gt; need ::cast</span>
                <span class="n">res</span> <span class="o">=</span> <span class="s1">&#39;pg_size_pretty(length(</span><span class="si">%s</span><span class="s1">)::bigint)&#39;</span> <span class="o">%</span> <span class="n">res</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> as &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>

        <span class="n">qual_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">qualify</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">fields_pre</span><span class="p">]</span>

        <span class="c1"># determine the actual query to execute</span>
        <span class="n">from_clause</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">get_sql</span><span class="p">()</span>
        <span class="n">query_str</span> <span class="o">=</span> <span class="s2">&quot;SELECT </span><span class="si">%s</span><span class="s2"> FROM </span><span class="si">%s</span><span class="s2"> WHERE </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qual_names</span><span class="p">),</span> <span class="n">from_clause</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">param_pos</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">param_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">sub_ids</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">):</span>
            <span class="n">params</span><span class="p">[</span><span class="n">param_pos</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sub_ids</span><span class="p">)</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_str</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">())</span>

        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">result</span><span class="p">]</span>
        <span class="n">fetched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ids</span><span class="p">:</span>
            <span class="c1"># translate the fields if necessary</span>
            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lang&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_pre</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>
                        <span class="n">translate</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">get_trans_func</span><span class="p">(</span><span class="n">fetched</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                            <span class="n">vals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">translate</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">vals</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

            <span class="c1"># store result in cache</span>
            <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch</span><span class="p">)</span>
                <span class="n">record</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">_convert_to_cache</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

            <span class="c1"># determine the fields that must be processed now;</span>
            <span class="c1"># for the sake of simplicity, we ignore inherited fields</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span><span class="p">:</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fetched</span><span class="p">)</span>

        <span class="c1"># Warn about deprecated fields now that fields_pre and fields_post are computed</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">deprecated</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Field </span><span class="si">%s</span><span class="s1"> is deprecated: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">deprecated</span><span class="p">)</span>

        <span class="c1"># store failed values in cache for the records that could not be read</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="bp">self</span> <span class="o">-</span> <span class="n">fetched</span>
        <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
            <span class="n">extras</span> <span class="o">=</span> <span class="n">fetched</span> <span class="o">-</span> <span class="bp">self</span>
            <span class="k">if</span> <span class="n">extras</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Database fetch misses ids (</span><span class="si">{}</span><span class="s2">) and has extra ids (</span><span class="si">{}</span><span class="s2">), may be caused by a type incoherence in a previous request&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">missing</span><span class="o">.</span><span class="n">_ids</span><span class="p">,</span> <span class="n">extras</span><span class="o">.</span><span class="n">_ids</span><span class="p">,</span>
                    <span class="p">))</span>
            <span class="c1"># mark non-existing records in missing</span>
            <span class="n">forbidden</span> <span class="o">=</span> <span class="n">missing</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">forbidden</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;The requested operation cannot be completed due to record rules: Document type: </span><span class="si">%s</span><span class="s1">, Operation: </span><span class="si">%s</span><span class="s1">, Records: </span><span class="si">%s</span><span class="s1">, User: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">][:</span><span class="mi">6</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">))</span>
                <span class="c1"># store an access error exception in existing records</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="n">AccessError</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;The requested operation cannot be completed due to security restrictions. Please contact your system administrator.</span><span class="se">\n\n</span><span class="s1">(Document type: </span><span class="si">%s</span><span class="s1">, Operation: </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">)</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set_failed</span><span class="p">(</span><span class="n">forbidden</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">exc</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns some metadata about the given records.</span>

<span class="sd">        :return: list of ownership dictionaries for each requested record</span>
<span class="sd">        :rtype: list of dictionaries with the following keys:</span>

<span class="sd">                    * id: object id</span>
<span class="sd">                    * create_uid: user who created the record</span>
<span class="sd">                    * create_date: date when the record was created</span>
<span class="sd">                    * write_uid: last user who changed the record</span>
<span class="sd">                    * write_date: date of the last change to the record</span>
<span class="sd">                    * xmlid: XML ID to use to refer to this record (if there is one), in format ``module.name``</span>
<span class="sd">                    * noupdate: A boolean telling if the record will be updated or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">+=</span> <span class="n">LOG_ACCESS_COLUMNS</span>
        <span class="n">quoted_table</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>
        <span class="n">fields_str</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">quoted_table</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;SELECT </span><span class="si">%s</span><span class="s1">, __imd.noupdate, __imd.module, __imd.name</span>
<span class="s1">                   FROM </span><span class="si">%s</span><span class="s1"> LEFT JOIN ir_model_data __imd</span>
<span class="s1">                       ON (__imd.model = </span><span class="si">%%</span><span class="s1">s and __imd.res_id = </span><span class="si">%s</span><span class="s1">.id)</span>
<span class="s1">                   WHERE </span><span class="si">%s</span><span class="s1">.id IN </span><span class="si">%%</span><span class="s1">s&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fields_str</span><span class="p">,</span> <span class="n">quoted_table</span><span class="p">,</span> <span class="n">quoted_table</span><span class="p">,</span> <span class="n">quoted_table</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">dictfetchall</span><span class="p">()</span>

        <span class="n">uids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;write_uid&#39;</span><span class="p">,</span> <span class="s1">&#39;create_uid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">uids</span><span class="p">)</span><span class="o">.</span><span class="n">name_get</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">or</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;write_uid&#39;</span><span class="p">,</span> <span class="s1">&#39;create_uid&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">value</span><span class="p">])</span>
            <span class="n">r</span><span class="p">[</span><span class="s1">&#39;xmlid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%(module)s</span><span class="s2">.</span><span class="si">%(name)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">r</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="k">del</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">_check_concurrency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CONCURRENCY_CHECK_FIELD</span><span class="p">)):</span>
            <span class="k">return</span>
        <span class="n">check_clause</span> <span class="o">=</span> <span class="s2">&quot;(id = </span><span class="si">%s</span><span class="s2"> AND </span><span class="si">%s</span><span class="s2"> &lt; COALESCE(write_date, create_date, (now() at time zone &#39;UTC&#39;))::timestamp)&quot;</span>
        <span class="k">for</span> <span class="n">sub_ids</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">):</span>
            <span class="n">nclauses</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">sub_ids</span><span class="p">:</span>
                <span class="n">id_ref</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                <span class="n">update_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CONCURRENCY_CHECK_FIELD</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">id_ref</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">update_date</span><span class="p">:</span>
                    <span class="n">nclauses</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="nb">id</span><span class="p">,</span> <span class="n">update_date</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">nclauses</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT id FROM </span><span class="si">%s</span><span class="s2"> WHERE </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s2">&quot; OR &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">check_clause</span><span class="p">]</span> <span class="o">*</span> <span class="n">nclauses</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                <span class="c1"># mention the first one only to keep the error message readable</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;A document was modified since you last viewed it (</span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">)&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">_check_record_rules_result_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result_ids</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Verify the returned rows after applying record rules matches the</span>
<span class="sd">            length of ``self``, and raise an appropriate exception if it does not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids</span><span class="p">,</span> <span class="n">result_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">result_ids</span><span class="p">)</span>
        <span class="n">missing_ids</span> <span class="o">=</span> <span class="n">ids</span> <span class="o">-</span> <span class="n">result_ids</span>
        <span class="k">if</span> <span class="n">missing_ids</span><span class="p">:</span>
            <span class="c1"># Attempt to distinguish record rule restriction vs deleted records,</span>
            <span class="c1"># to provide a more specific error message</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id FROM </span><span class="si">%s</span><span class="s1"> WHERE id IN </span><span class="si">%%</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">missing_ids</span><span class="p">),))</span>
            <span class="n">forbidden_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">forbidden_ids</span><span class="p">:</span>
                <span class="c1"># the missing ids are (at least partially) hidden by access rules</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span> <span class="o">==</span> <span class="n">SUPERUSER_ID</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Access Denied by record rules for operation: </span><span class="si">%s</span><span class="s1"> on record ids: </span><span class="si">%r</span><span class="s1">, uid: </span><span class="si">%s</span><span class="s1">, model: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">forbidden_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;The requested operation cannot be completed due to security restrictions. Please contact your system administrator.</span><span class="se">\n\n</span><span class="s1">(Document type: </span><span class="si">%s</span><span class="s1">, Operation: </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">)</span> <span class="o">%</span> \
                                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">,</span> <span class="n">operation</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If we get here, the missing_ids are not in the database</span>
                <span class="k">if</span> <span class="n">operation</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span><span class="s1">&#39;unlink&#39;</span><span class="p">):</span>
                    <span class="c1"># No need to warn about deleting an already deleted record.</span>
                    <span class="c1"># And no error when reading a record that was deleted, to prevent spurious</span>
                    <span class="c1"># errors for non-transactional search/read sequences coming from clients</span>
                    <span class="k">return</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Failed operation on deleted record(s): </span><span class="si">%s</span><span class="s1">, uid: </span><span class="si">%s</span><span class="s1">, model: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">MissingError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Missing document(s)&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;One of the documents you are trying to access has been deleted, please try again after refreshing.&#39;</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">check_access_rights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">raise_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Verifies that the operation given by ``operation`` is allowed for</span>
<span class="sd">            the current user according to the access rights.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.access&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">raise_exception</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">check_access_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Verifies that the operation given by ``operation`` is allowed for</span>
<span class="sd">            the current user according to ir.rules.</span>

<span class="sd">           :param operation: one of ``write``, ``unlink``</span>
<span class="sd">           :raise UserError: * if current ir.rules do not permit this operation.</span>
<span class="sd">           :return: None if the operation is allowed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span> <span class="o">==</span> <span class="n">SUPERUSER_ID</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_transient</span><span class="p">():</span>
            <span class="c1"># Only one single implicit access rule for transient models: owner only!</span>
            <span class="c1"># This is ok to hardcode because we assert that TransientModels always</span>
            <span class="c1"># have log_access enabled so that the create_uid column is always there.</span>
            <span class="c1"># And even with _inherits, these fields are always present in the local</span>
            <span class="c1"># table too, so no need for JOINs.</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT DISTINCT create_uid FROM </span><span class="si">%s</span><span class="s2"> WHERE id IN </span><span class="si">%%</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">),))</span>
            <span class="n">uids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uids</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">uids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AccessError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;For this kind of document, you may only access records you created yourself.</span><span class="se">\n\n</span><span class="s1">(Document type: </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">,))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_params</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">domain_get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">where_clause</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT </span><span class="si">%s</span><span class="s2">.id FROM </span><span class="si">%s</span><span class="s2"> WHERE </span><span class="si">%s</span><span class="s2">.id IN </span><span class="si">%%</span><span class="s2">s AND &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tables</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query</span> <span class="o">+</span> <span class="s2">&quot; AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">where_clause</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">sub_ids</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">sub_ids</span><span class="p">]</span> <span class="o">+</span> <span class="n">where_params</span><span class="p">)</span>
                    <span class="n">returned_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">sub_ids</span><span class="p">)</span><span class="o">.</span><span class="n">_check_record_rules_result_count</span><span class="p">(</span><span class="n">returned_ids</span><span class="p">,</span> <span class="n">operation</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; unlink()</span>

<span class="sd">        Deletes the records of the current set</span>

<span class="sd">        :raise AccessError: * if user has no unlink rights on the requested object</span>
<span class="sd">                            * if user tries to bypass access rules for unlink on the requested object</span>
<span class="sd">        :raise UserError: if the record is default property for other records</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="c1"># for recomputing fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_concurrency</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;unlink&#39;</span><span class="p">)</span>

        <span class="c1"># Check if the records are used as default properties.</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.property&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;value_reference&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">refs</span><span class="p">)]):</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Unable to delete this document because it is used as a default property&#39;</span><span class="p">))</span>

        <span class="c1"># Delete the records&#39; properties.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.property&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">refs</span><span class="p">)])</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="s1">&#39;unlink&#39;</span><span class="p">)</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">Data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">with_context</span><span class="p">({})</span>
        <span class="n">Defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.default&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
        <span class="n">Attachment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.attachment&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">sub_ids</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">):</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;DELETE FROM </span><span class="si">%s</span><span class="s2"> WHERE id IN </span><span class="si">%%</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">sub_ids</span><span class="p">,))</span>

            <span class="c1"># Removing the ir_model_data reference if the record being deleted</span>
            <span class="c1"># is a record created by xml/csv file, as these are not connected</span>
            <span class="c1"># with real database foreign keys, and would be dangling references.</span>
            <span class="c1">#</span>
            <span class="c1"># Note: the following steps are performed as superuser to avoid</span>
            <span class="c1"># access rights restrictions, and with no context to avoid possible</span>
            <span class="c1"># side-effects during admin calls.</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">Data</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="n">sub_ids</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

            <span class="c1"># For the same reason, remove the defaults having some of the</span>
            <span class="c1"># records as value</span>
            <span class="n">Defaults</span><span class="o">.</span><span class="n">discard_records</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">sub_ids</span><span class="p">))</span>

            <span class="c1"># For the same reason, remove the relevant records in ir_attachment</span>
            <span class="c1"># (the search is performed with sql as the search method of</span>
            <span class="c1"># ir_attachment is overridden to hide attachments of deleted</span>
            <span class="c1"># records)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT id FROM ir_attachment WHERE res_model=</span><span class="si">%s</span><span class="s1"> AND res_id IN </span><span class="si">%s</span><span class="s1">&#39;</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">sub_ids</span><span class="p">))</span>
            <span class="n">attachments</span> <span class="o">=</span> <span class="n">Attachment</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()])</span>
            <span class="k">if</span> <span class="n">attachments</span><span class="p">:</span>
                <span class="n">attachments</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

        <span class="c1"># invalidate the *whole* cache, since the orm does not handle all</span>
        <span class="c1"># changes made in the database, like cascading delete!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">()</span>

        <span class="c1"># recompute new-style fields</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">recompute</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;recompute&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recompute</span><span class="p">()</span>

        <span class="c1"># auditing: deletions are infrequent and leave no trace in the database</span>
        <span class="n">_unlink</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;User #</span><span class="si">%s</span><span class="s1"> deleted </span><span class="si">%s</span><span class="s1"> records with IDs: </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1">#</span>
    <span class="c1"># TODO: Validate</span>
    <span class="c1">#</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; write(vals)</span>

<span class="sd">        Updates all records in the current set with the provided values.</span>

<span class="sd">        :param dict vals: fields to update and the value to set on them e.g::</span>

<span class="sd">                {&#39;foo&#39;: 1, &#39;bar&#39;: &quot;Qux&quot;}</span>

<span class="sd">            will set the field ``foo`` to ``1`` and the field ``bar`` to</span>
<span class="sd">            ``&quot;Qux&quot;`` if those are valid (otherwise it will trigger an error).</span>

<span class="sd">        :raise AccessError: * if user has no write rights on the requested object</span>
<span class="sd">                            * if user tries to bypass access rules for write on the requested object</span>
<span class="sd">        :raise ValidateError: if user tries to enter invalid value for a field that is not in selection</span>
<span class="sd">        :raise UserError: if a loop would be created in a hierarchy of objects a result of the operation (such as setting an object as its own parent)</span>

<span class="sd">        * For numeric fields (:class:`~gerp.fields.Integer`,</span>
<span class="sd">          :class:`~gerp.fields.Float`) the value should be of the</span>
<span class="sd">          corresponding type</span>
<span class="sd">        * For :class:`~gerp.fields.Boolean`, the value should be a</span>
<span class="sd">          :class:`python:bool`</span>
<span class="sd">        * For :class:`~gerp.fields.Selection`, the value should match the</span>
<span class="sd">          selection values (generally :class:`python:str`, sometimes</span>
<span class="sd">          :class:`python:int`)</span>
<span class="sd">        * For :class:`~gerp.fields.Many2one`, the value should be the</span>
<span class="sd">          database identifier of the record to set</span>
<span class="sd">        * Other non-relational fields use a string for value</span>

<span class="sd">          .. danger::</span>

<span class="sd">              for historical and compatibility reasons,</span>
<span class="sd">              :class:`~gerp.fields.Date` and</span>
<span class="sd">              :class:`~gerp.fields.Datetime` fields use strings as values</span>
<span class="sd">              (written and read) rather than :class:`~python:datetime.date` or</span>
<span class="sd">              :class:`~python:datetime.datetime`. These date strings are</span>
<span class="sd">              UTC-only and formatted according to</span>
<span class="sd">              :const:`gerp.tools.misc.DEFAULT_SERVER_DATE_FORMAT` and</span>
<span class="sd">              :const:`gerp.tools.misc.DEFAULT_SERVER_DATETIME_FORMAT`</span>
<span class="sd">        * .. _openerp/models/relationals/format:</span>

<span class="sd">          :class:`~gerp.fields.One2many` and</span>
<span class="sd">          :class:`~gerp.fields.Many2many` use a special &quot;commands&quot; format to</span>
<span class="sd">          manipulate the set of records stored in/associated with the field.</span>

<span class="sd">          This format is a list of triplets executed sequentially, where each</span>
<span class="sd">          triplet is a command to execute on the set of records. Not all</span>
<span class="sd">          commands apply in all situations. Possible commands are:</span>

<span class="sd">          ``(0, _, values)``</span>
<span class="sd">              adds a new record created from the provided ``value`` dict.</span>
<span class="sd">          ``(1, id, values)``</span>
<span class="sd">              updates an existing record of id ``id`` with the values in</span>
<span class="sd">              ``values``. Can not be used in :meth:`~.create`.</span>
<span class="sd">          ``(2, id, _)``</span>
<span class="sd">              removes the record of id ``id`` from the set, then deletes it</span>
<span class="sd">              (from the database). Can not be used in :meth:`~.create`.</span>
<span class="sd">          ``(3, id, _)``</span>
<span class="sd">              removes the record of id ``id`` from the set, but does not</span>
<span class="sd">              delete it. Can not be used on</span>
<span class="sd">              :class:`~gerp.fields.One2many`. Can not be used in</span>
<span class="sd">              :meth:`~.create`.</span>
<span class="sd">          ``(4, id, _)``</span>
<span class="sd">              adds an existing record of id ``id`` to the set. Can not be</span>
<span class="sd">              used on :class:`~gerp.fields.One2many`.</span>
<span class="sd">          ``(5, _, _)``</span>
<span class="sd">              removes all records from the set, equivalent to using the</span>
<span class="sd">              command ``3`` on every record explicitly. Can not be used on</span>
<span class="sd">              :class:`~gerp.fields.One2many`. Can not be used in</span>
<span class="sd">              :meth:`~.create`.</span>
<span class="sd">          ``(6, _, ids)``</span>
<span class="sd">              replaces all existing records in the set by the ``ids`` list,</span>
<span class="sd">              equivalent to using the command ``5`` followed by a command</span>
<span class="sd">              ``4`` for each ``id`` in ``ids``.</span>

<span class="sd">          .. note:: Values marked as ``_`` in the list above are ignored and</span>
<span class="sd">                    can be anything, generally ``0`` or ``False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_concurrency</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>

        <span class="c1"># No user-driven update of these columns</span>
        <span class="n">pop_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;parent_left&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_right&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="n">pop_fields</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">MAGIC_COLUMNS</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">pop_fields</span><span class="p">:</span>
            <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># split up fields into old-style and pure new-style ones</span>
        <span class="n">old_vals</span><span class="p">,</span> <span class="n">new_vals</span><span class="p">,</span> <span class="n">unknown</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
                    <span class="n">old_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">inverse</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
                    <span class="n">new_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unknown</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unknown</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.write() with unknown fields: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unknown</span><span class="p">)))</span>

        <span class="n">protected_fields</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">protecting</span><span class="p">(</span><span class="n">protected_fields</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
            <span class="c1"># write old-style fields with (low-level) method _write</span>
            <span class="k">if</span> <span class="n">old_vals</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">old_vals</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">new_vals</span><span class="p">:</span>
                <span class="c1"># put the values of pure new-style fields into cache, and inverse them</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_vals</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_vals</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">record</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">_convert_to_cache</span><span class="p">(</span><span class="n">new_vals</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">determine_inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_vals</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_vals</span><span class="p">))</span>
                <span class="c1"># check Python constraints for inversed fields</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fields</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_vals</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_vals</span><span class="p">))</span>
                <span class="c1"># recompute new-style fields</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">recompute</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;recompute&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">recompute</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="c1"># low-level implementation of write()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_field_access_rights</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>

        <span class="c1"># for recomputing new-style fields</span>
        <span class="n">extra_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;write_date&#39;</span><span class="p">,</span> <span class="s1">&#39;write_uid&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">+</span> <span class="n">extra_fields</span><span class="p">)</span>

        <span class="c1"># for updating parent_left, parent_right</span>
        <span class="n">parents_changed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;defer_parent_store_computation&#39;</span><span class="p">):</span>
            <span class="c1"># The parent_left/right computation may take up to 5 seconds. No</span>
            <span class="c1"># need to recompute the values if the parent is the same.</span>
            <span class="c1">#</span>
            <span class="c1"># Note: to respect parent_order, nodes must be processed in</span>
            <span class="c1"># order, so ``parents_changed`` must be ordered properly.</span>
            <span class="n">parent_val</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">parent_val</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT id FROM </span><span class="si">%s</span><span class="s2"> WHERE id IN </span><span class="si">%%</span><span class="s2">s AND (</span><span class="si">%s</span><span class="s2"> != </span><span class="si">%%</span><span class="s2">s OR </span><span class="si">%s</span><span class="s2"> IS NULL) ORDER BY </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_order</span><span class="p">)</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="n">parent_val</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT id FROM </span><span class="si">%s</span><span class="s2"> WHERE id IN </span><span class="si">%%</span><span class="s2">s AND (</span><span class="si">%s</span><span class="s2"> IS NOT NULL) ORDER BY </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_order</span><span class="p">)</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">),))</span>
            <span class="n">parents_changed</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>

        <span class="n">updates</span> <span class="o">=</span> <span class="p">[]</span>            <span class="c1"># list of (column, expr) or (column, pattern, value)</span>
        <span class="n">upd_todo</span> <span class="o">=</span> <span class="p">[]</span>           <span class="c1"># list of column names to set explicitly</span>
        <span class="n">updend</span> <span class="o">=</span> <span class="p">[]</span>             <span class="c1"># list of possibly inherited field names</span>
        <span class="n">direct</span> <span class="o">=</span> <span class="p">[]</span>             <span class="c1"># list of direcly updated columns</span>
        <span class="n">has_trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;en_US&#39;</span>
        <span class="n">single_lang</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;res.lang&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_installed</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">deprecated</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Field </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> is deprecated: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">deprecated</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;selection&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_check_selection_field_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">single_lang</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="n">has_trans</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">):</span>
                        <span class="c1"># val is not a translation: update the table</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_column</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
                        <span class="n">updates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">column_format</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span>
                    <span class="n">direct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">upd_todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">updend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="n">updates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;write_uid&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">))</span>
            <span class="n">updates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;write_date&#39;</span><span class="p">,</span> <span class="s2">&quot;(now() at time zone &#39;UTC&#39;)&quot;</span><span class="p">))</span>
            <span class="n">direct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;write_uid&#39;</span><span class="p">)</span>
            <span class="n">direct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;write_date&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">updates</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">)</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;UPDATE &quot;</span><span class="si">%s</span><span class="s1">&quot; SET </span><span class="si">%s</span><span class="s1"> WHERE id IN </span><span class="si">%%</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">updates</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">updates</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sub_ids</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)):</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span> <span class="o">+</span> <span class="p">(</span><span class="n">sub_ids</span><span class="p">,))</span>
                <span class="k">if</span> <span class="n">cr</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_ids</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">MissingError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;One of the records you are trying to modify has already been deleted (Document type: </span><span class="si">%s</span><span class="s1">).&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_description</span><span class="p">)</span>

            <span class="c1"># TODO: optimize</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">direct</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">):</span>
                    <span class="c1"># The source value of a field has been modified,</span>
                    <span class="c1"># synchronize translated terms when possible.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.translation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_sync_terms_translations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="bp">self</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">has_trans</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">:</span>
                    <span class="c1"># The translated value of a field has been modified.</span>
                    <span class="n">src_trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">([</span><span class="n">name</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">src_trans</span><span class="p">:</span>
                        <span class="c1"># Insert value to DB</span>
                        <span class="n">src_trans</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">({</span><span class="n">name</span><span class="p">:</span> <span class="n">src_trans</span><span class="p">})</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_column</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
                    <span class="n">tname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.translation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_set_ids</span><span class="p">(</span>
                        <span class="n">tname</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">src_trans</span><span class="p">)</span>

        <span class="c1"># invalidate and mark new-style fields to recompute; do this before</span>
        <span class="c1"># setting other fields, because it can require the value of computed</span>
        <span class="c1"># fields, e.g., a one2many checking constraints on records</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="n">direct</span><span class="p">)</span>

        <span class="c1"># defaults in context must be removed when call a one2many or many2many</span>
        <span class="n">rel_context</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span>
                       <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                       <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;default_&#39;</span><span class="p">)}</span>

        <span class="c1"># call the &#39;write&#39; method of fields which are not columns</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">upd_todo</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">field</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">rel_context</span><span class="p">),</span> <span class="n">vals</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>

        <span class="c1"># for recomputing new-style fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="n">upd_todo</span><span class="p">)</span>

        <span class="c1"># write inherited fields on the corresponding parent records</span>
        <span class="n">unknown_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">updend</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parent_model</span><span class="p">,</span> <span class="n">parent_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parent_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sub_ids</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">split_for_in_conditions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">):</span>
                <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;SELECT DISTINCT </span><span class="si">%s</span><span class="s2"> FROM </span><span class="si">%s</span><span class="s2"> WHERE id IN </span><span class="si">%%</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">sub_ids</span><span class="p">,))</span>
                <span class="n">parent_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()])</span>

            <span class="n">parent_vals</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">updend</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">parent_field</span><span class="p">:</span>
                    <span class="n">parent_vals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">unknown_fields</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">parent_vals</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent_model</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">parent_ids</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">parent_vals</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unknown_fields</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No such field(s) in model </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unknown_fields</span><span class="p">))</span>

        <span class="c1"># check Python constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fields</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

        <span class="c1"># TODO: use _order to set dest at the right position and not first node of parent</span>
        <span class="c1"># We can&#39;t defer parent_store computation because the stored function</span>
        <span class="c1"># fields that are computer may refer (directly or indirectly) to</span>
        <span class="c1"># parent_left/right (via a child_of domain)</span>
        <span class="k">if</span> <span class="n">parents_changed</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_init</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_init_parent</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parent_val</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">parent_val</span><span class="p">:</span>
                    <span class="n">clause</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%%</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,</span> <span class="p">(</span><span class="n">parent_val</span><span class="p">,)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">clause</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> IS NULL&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,</span> <span class="p">()</span>

                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">parents_changed</span><span class="p">:</span>
                    <span class="c1"># determine old parent_left, parent_right of current record</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT parent_left, parent_right FROM </span><span class="si">%s</span><span class="s1"> WHERE id=</span><span class="si">%%</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="p">(</span><span class="nb">id</span><span class="p">,))</span>
                    <span class="n">pleft0</span><span class="p">,</span> <span class="n">pright0</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">pright0</span> <span class="o">-</span> <span class="n">pleft0</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c1"># determine new parent_left of current record; it comes</span>
                    <span class="c1"># right after the parent_right of its closest left sibling</span>
                    <span class="c1"># (this CANNOT be fetched outside the loop, as it needs to</span>
                    <span class="c1"># be refreshed after each update, in case several nodes are</span>
                    <span class="c1"># sequentially inserted one next to the other)</span>
                    <span class="n">pleft1</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT id, parent_right FROM </span><span class="si">%s</span><span class="s1"> WHERE </span><span class="si">%s</span><span class="s1"> ORDER BY </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">clause</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_order</span><span class="p">),</span> <span class="n">params</span><span class="p">)</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">sibling_id</span><span class="p">,</span> <span class="n">sibling_parent_right</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">sibling_id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">pleft1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sibling_parent_right</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pleft1</span><span class="p">:</span>
                        <span class="c1"># the current record is the first node of the parent</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_val</span><span class="p">:</span>
                            <span class="n">pleft1</span> <span class="o">=</span> <span class="mi">0</span>          <span class="c1"># the first node starts at 0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;SELECT parent_left FROM </span><span class="si">%s</span><span class="s1"> WHERE id=</span><span class="si">%%</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="p">(</span><span class="n">parent_val</span><span class="p">,))</span>
                            <span class="n">pleft1</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">pleft0</span> <span class="o">&lt;</span> <span class="n">pleft1</span> <span class="o">&lt;=</span> <span class="n">pright0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Recursivity Detected.&#39;</span><span class="p">))</span>

                    <span class="c1"># make some room for parent_left and parent_right at the new position</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;UPDATE </span><span class="si">%s</span><span class="s1"> SET parent_left=parent_left+</span><span class="si">%%</span><span class="s1">s WHERE </span><span class="si">%%</span><span class="s1">s&lt;=parent_left&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">pleft1</span><span class="p">))</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;UPDATE </span><span class="si">%s</span><span class="s1"> SET parent_right=parent_right+</span><span class="si">%%</span><span class="s1">s WHERE </span><span class="si">%%</span><span class="s1">s&lt;=parent_right&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">pleft1</span><span class="p">))</span>
                    <span class="c1"># slide the subtree of the current record to its new position</span>
                    <span class="k">if</span> <span class="n">pleft0</span> <span class="o">&lt;</span> <span class="n">pleft1</span><span class="p">:</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;UPDATE </span><span class="si">%s</span><span class="s1"> SET parent_left=parent_left+</span><span class="si">%%</span><span class="s1">s, parent_right=parent_right+</span><span class="si">%%</span><span class="s1">s</span>
<span class="s1">                                      WHERE </span><span class="si">%%</span><span class="s1">s&lt;=parent_left AND parent_left&lt;</span><span class="si">%%</span><span class="s1">s&#39;&#39;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">pleft1</span> <span class="o">-</span> <span class="n">pleft0</span><span class="p">,</span> <span class="n">pleft1</span> <span class="o">-</span> <span class="n">pleft0</span><span class="p">,</span> <span class="n">pleft0</span><span class="p">,</span> <span class="n">pright0</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;UPDATE </span><span class="si">%s</span><span class="s1"> SET parent_left=parent_left-</span><span class="si">%%</span><span class="s1">s, parent_right=parent_right-</span><span class="si">%%</span><span class="s1">s</span>
<span class="s1">                                      WHERE </span><span class="si">%%</span><span class="s1">s&lt;=parent_left AND parent_left&lt;</span><span class="si">%%</span><span class="s1">s&#39;&#39;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">pleft0</span> <span class="o">-</span> <span class="n">pleft1</span> <span class="o">+</span> <span class="n">width</span><span class="p">,</span> <span class="n">pleft0</span> <span class="o">-</span> <span class="n">pleft1</span> <span class="o">+</span> <span class="n">width</span><span class="p">,</span> <span class="n">pleft0</span> <span class="o">+</span> <span class="n">width</span><span class="p">,</span> <span class="n">pright0</span> <span class="o">+</span> <span class="n">width</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">([</span><span class="s1">&#39;parent_left&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_right&#39;</span><span class="p">])</span>

        <span class="c1"># recompute new-style fields</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">recompute</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;recompute&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recompute</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1">#</span>
    <span class="c1"># TODO: Should set perm to user.xxx</span>
    <span class="c1">#</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; create(vals) -&gt; record</span>

<span class="sd">        Creates a new record for the model.</span>

<span class="sd">        The new record is initialized using the values from ``vals`` and</span>
<span class="sd">        if necessary those from :meth:`~.default_get`.</span>

<span class="sd">        :param dict vals:</span>
<span class="sd">            values for the model&#39;s fields, as a dictionary::</span>

<span class="sd">                {&#39;field_name&#39;: field_value, ...}</span>

<span class="sd">            see :meth:`~.write` for details</span>
<span class="sd">        :return: new record created</span>
<span class="sd">        :raise AccessError: * if user has no create rights on the requested object</span>
<span class="sd">                            * if user tries to bypass access rules for create on the requested object</span>
<span class="sd">        :raise ValidateError: if user tries to enter invalid value for a field that is not in selection</span>
<span class="sd">        :raise UserError: if a loop would be created in a hierarchy of objects a result of the operation (such as setting an object as its own parent)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>

        <span class="c1"># add missing defaults, and drop fields that may not be set by user</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_missing_default_values</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="n">pop_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;parent_left&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_right&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="n">pop_fields</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">MAGIC_COLUMNS</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">pop_fields</span><span class="p">:</span>
            <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># split up fields into old-style and pure new-style ones</span>
        <span class="n">old_vals</span><span class="p">,</span> <span class="n">new_vals</span><span class="p">,</span> <span class="n">unknown</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{},</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">or</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
                    <span class="n">old_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">inverse</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
                    <span class="n">new_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unknown</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unknown</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.create() includes unknown fields: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unknown</span><span class="p">)))</span>

        <span class="c1"># create record with old-style fields</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span><span class="n">old_vals</span><span class="p">))</span>

        <span class="n">protected_fields</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">protecting</span><span class="p">(</span><span class="n">protected_fields</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
            <span class="c1"># put the values of pure new-style fields into cache, and inverse them</span>
            <span class="n">record</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_vals</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_vals</span><span class="p">))</span>
            <span class="n">record</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">_convert_to_cache</span><span class="p">(</span><span class="n">new_vals</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_vals</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">determine_inverse</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            <span class="n">record</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_vals</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_vals</span><span class="p">))</span>
            <span class="c1"># check Python constraints for inversed fields</span>
            <span class="n">record</span><span class="o">.</span><span class="n">_validate_fields</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_vals</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">old_vals</span><span class="p">))</span>
            <span class="c1"># recompute new-style fields</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">recompute</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;recompute&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recompute</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">record</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="c1"># data of parent records to create or update, by model</span>
        <span class="n">tocreate</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">parent_model</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">parent_field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)}</span>
            <span class="k">for</span> <span class="n">parent_model</span><span class="p">,</span> <span class="n">parent_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># list of column assignments defined as tuples like:</span>
        <span class="c1">#   (column_name, format_string, column_value)</span>
        <span class="c1">#   (column_name, sql_formula)</span>
        <span class="c1"># Those tuples will be used by the string formatting for the INSERT</span>
        <span class="c1"># statement below.</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s2">&quot;nextval(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="n">upd_todo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unknown_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">protected_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
                <span class="n">unknown_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">vals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
                <span class="n">tocreate</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">related_field</span><span class="o">.</span><span class="n">model_name</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">del</span> <span class="n">vals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">vals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">inverse</span><span class="p">:</span>
                <span class="n">protected_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unknown_fields</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No such field(s) in model </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unknown_fields</span><span class="p">))</span>

        <span class="c1"># create or update parent records</span>
        <span class="k">for</span> <span class="n">parent_model</span><span class="p">,</span> <span class="n">parent_vals</span> <span class="ow">in</span> <span class="n">tocreate</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parent_id</span> <span class="o">=</span> <span class="n">parent_vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_id</span><span class="p">:</span>
                <span class="n">parent_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent_model</span><span class="p">]</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">parent_vals</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent_model</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">parent_id</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">parent_vals</span><span class="p">)</span>
            <span class="n">vals</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">[</span><span class="n">parent_model</span><span class="p">]]</span> <span class="o">=</span> <span class="n">parent_id</span>

        <span class="c1"># set boolean fields to False by default (to make search more powerful)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;boolean&#39;</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
                <span class="n">vals</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># determine SQL values</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span><span class="p">:</span>
                <span class="n">column_val</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_column</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
                <span class="n">updates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">column_format</span><span class="p">,</span> <span class="n">column_val</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">upd_todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;selection&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_check_selection_field_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span><span class="p">:</span>
            <span class="n">updates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;create_uid&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">))</span>
            <span class="n">updates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;write_uid&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">))</span>
            <span class="n">updates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;create_date&#39;</span><span class="p">,</span> <span class="s2">&quot;(now() at time zone &#39;UTC&#39;)&quot;</span><span class="p">))</span>
            <span class="n">updates</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;write_date&#39;</span><span class="p">,</span> <span class="s2">&quot;(now() at time zone &#39;UTC&#39;)&quot;</span><span class="p">))</span>

        <span class="c1"># insert a row for this record</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;INSERT INTO &quot;</span><span class="si">%s</span><span class="s2">&quot; (</span><span class="si">%s</span><span class="s2">) VALUES(</span><span class="si">%s</span><span class="s2">) RETURNING id&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span>
                <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">updates</span><span class="p">),</span>
                <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">updates</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">updates</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span>

        <span class="c1"># from now on, self is the new record</span>
        <span class="n">id_new</span><span class="p">,</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">id_new</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_store</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;defer_parent_store_computation&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_init</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_init_parent</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parent_val</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parent_val</span><span class="p">:</span>
                    <span class="c1"># determine parent_left: it comes right after the</span>
                    <span class="c1"># parent_right of its closest left sibling</span>
                    <span class="n">pleft</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT parent_right FROM </span><span class="si">%s</span><span class="s2"> WHERE </span><span class="si">%s</span><span class="s2">=</span><span class="si">%%</span><span class="s2">s ORDER BY </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> \
                                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_order</span><span class="p">),</span>
                               <span class="p">(</span><span class="n">parent_val</span><span class="p">,))</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">pright</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">pright</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">pleft</span> <span class="o">=</span> <span class="n">pright</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pleft</span><span class="p">:</span>
                        <span class="c1"># this is the leftmost child of its parent</span>
                        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT parent_left FROM </span><span class="si">%s</span><span class="s2"> WHERE id=</span><span class="si">%%</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="p">(</span><span class="n">parent_val</span><span class="p">,))</span>
                        <span class="n">pleft</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># determine parent_left: it comes after all top-level parent_right</span>
                    <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT MAX(parent_right) FROM </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
                    <span class="n">pleft</span> <span class="o">=</span> <span class="p">(</span><span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="c1"># make some room for the new node, and insert it in the MPTT</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE </span><span class="si">%s</span><span class="s2"> SET parent_left=parent_left+2 WHERE parent_left&gt;=</span><span class="si">%%</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span>
                           <span class="p">(</span><span class="n">pleft</span><span class="p">,))</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE </span><span class="si">%s</span><span class="s2"> SET parent_right=parent_right+2 WHERE parent_right&gt;=</span><span class="si">%%</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span>
                           <span class="p">(</span><span class="n">pleft</span><span class="p">,))</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE </span><span class="si">%s</span><span class="s2"> SET parent_left=</span><span class="si">%%</span><span class="s2">s, parent_right=</span><span class="si">%%</span><span class="s2">s WHERE id=</span><span class="si">%%</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span>
                           <span class="p">(</span><span class="n">pleft</span><span class="p">,</span> <span class="n">pleft</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">id_new</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">([</span><span class="s1">&#39;parent_left&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_right&#39;</span><span class="p">])</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">protecting</span><span class="p">(</span><span class="n">protected_fields</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
            <span class="c1"># invalidate and mark new-style fields to recompute; do this before</span>
            <span class="c1"># setting other fields, because it can require the value of computed</span>
            <span class="c1"># fields, e.g., a one2many checking constraints on records</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span>

            <span class="c1"># defaults in context must be removed when call a one2many or many2many</span>
            <span class="n">rel_context</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span>
                           <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                           <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;default_&#39;</span><span class="p">)}</span>

            <span class="c1"># call the &#39;write&#39; method of fields which are not columns</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">upd_todo</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">_sequence</span><span class="p">):</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">field</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">rel_context</span><span class="p">),</span> <span class="n">vals</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># for recomputing new-style fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modified</span><span class="p">(</span><span class="n">upd_todo</span><span class="p">)</span>

            <span class="c1"># check Python constraints</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_fields</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">recompute</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;recompute&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                <span class="c1"># recompute new-style fields</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">recompute</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_access_rule</span><span class="p">(</span><span class="s1">&#39;create&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span> <span class="o">!=</span> <span class="s1">&#39;en_US&#39;</span><span class="p">:</span>
            <span class="c1"># add translations for self.env.lang</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">tname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.translation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_set_ids</span><span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">id_new</span>

    <span class="c1"># TODO: ameliorer avec NULL</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_where_calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">active_test</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the WHERE clause needed to implement an OpenERP domain.</span>
<span class="sd">        :param domain: the domain to compute</span>
<span class="sd">        :type domain: list</span>
<span class="sd">        :param active_test: whether the default filtering of records with ``active``</span>
<span class="sd">                            field set to ``False`` should be applied.</span>
<span class="sd">        :return: the query expressing the given domain as provided in domain</span>
<span class="sd">        :rtype: osv.query.Query</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if the object has a field named &#39;active&#39;, filter out all inactive</span>
        <span class="c1"># records unless they were explicitely asked for</span>
        <span class="k">if</span> <span class="s1">&#39;active&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="ow">and</span> <span class="n">active_test</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;active_test&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="c1"># the item[0] trick below works for domain items and &#39;&amp;&#39;/&#39;|&#39;/&#39;!&#39;</span>
            <span class="c1"># operators too</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;active&#39;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">domain</span><span class="p">):</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="n">domain</span>

        <span class="k">if</span> <span class="n">domain</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">get_tables</span><span class="p">()</span>
            <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_params</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">to_sql</span><span class="p">()</span>
            <span class="n">where_clause</span> <span class="o">=</span> <span class="p">[</span><span class="n">where_clause</span><span class="p">]</span> <span class="k">if</span> <span class="n">where_clause</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_params</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">Query</span><span class="p">(</span><span class="n">tables</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_qorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">regex_order</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UserError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Invalid &quot;order&quot; specified. A valid &quot;order&quot; specification is a comma-separated list of valid field names (optionally followed by asc/desc for the direction)&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_apply_ir_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;read&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add what&#39;s missing in ``query`` to implement all appropriate ir.rules</span>
<span class="sd">          (using the ``model_name``&#39;s rules or the current model&#39;s rules if ``model_name`` is None)</span>

<span class="sd">           :param query: the current query object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span> <span class="o">==</span> <span class="n">SUPERUSER_ID</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">apply_rule</span><span class="p">(</span><span class="n">clauses</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">parent_model</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; :param parent_model: name of the parent model, if the added</span>
<span class="sd">                    clause comes from a parent model</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">clauses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">parent_model</span><span class="p">:</span>
                    <span class="c1"># as inherited rules are being applied, we need to add the</span>
                    <span class="c1"># missing JOIN to reach the parent table (if not JOINed yet)</span>
                    <span class="n">parent_table</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent_model</span><span class="p">]</span><span class="o">.</span><span class="n">_table</span>
                    <span class="n">parent_alias</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_join_add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_model</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
                    <span class="c1"># inherited rules are applied on the external table, replace</span>
                    <span class="c1"># parent_table by parent_alias</span>
                    <span class="n">clauses</span> <span class="o">=</span> <span class="p">[</span><span class="n">clause</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">parent_table</span><span class="p">,</span> <span class="n">parent_alias</span><span class="p">)</span> <span class="k">for</span> <span class="n">clause</span> <span class="ow">in</span> <span class="n">clauses</span><span class="p">]</span>
                    <span class="c1"># replace parent_table by parent_alias, and introduce</span>
                    <span class="c1"># parent_alias if needed</span>
                    <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">(</span><span class="n">parent_table</span> <span class="o">+</span> <span class="s1">&#39; as &#39;</span> <span class="o">+</span> <span class="n">parent_alias</span><span class="p">)</span> <span class="k">if</span> <span class="n">table</span> <span class="o">==</span> <span class="n">parent_table</span> \
                            <span class="k">else</span> <span class="n">table</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">parent_table</span><span class="p">,</span> <span class="n">parent_alias</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span>
                    <span class="p">]</span>
                <span class="n">query</span><span class="o">.</span><span class="n">where_clause</span> <span class="o">+=</span> <span class="n">clauses</span>
                <span class="n">query</span><span class="o">.</span><span class="n">where_clause_params</span> <span class="o">+=</span> <span class="n">params</span>
                <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
                        <span class="n">query</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

        <span class="c1"># apply main rules on the object</span>
        <span class="n">Rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.rule&#39;</span><span class="p">]</span>
        <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_params</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="n">Rule</span><span class="o">.</span><span class="n">domain_get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="n">apply_rule</span><span class="p">(</span><span class="n">where_clause</span><span class="p">,</span> <span class="n">where_params</span><span class="p">,</span> <span class="n">tables</span><span class="p">)</span>

        <span class="c1"># apply ir.rules from the parents (through _inherits)</span>
        <span class="k">for</span> <span class="n">parent_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits</span><span class="p">:</span>
            <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_params</span><span class="p">,</span> <span class="n">tables</span> <span class="o">=</span> <span class="n">Rule</span><span class="o">.</span><span class="n">domain_get</span><span class="p">(</span><span class="n">parent_model</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
            <span class="n">apply_rule</span><span class="p">(</span><span class="n">where_clause</span><span class="p">,</span> <span class="n">where_params</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">parent_model</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_generate_translated_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_alias</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add possibly missing JOIN with translations table to ``query`` and</span>
<span class="sd">        generate the expression for the translated field.</span>

<span class="sd">        :return: the qualified field name (or expression) to use for ``field``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span><span class="p">:</span>
            <span class="c1"># Sub-select to return at most one translation per record.</span>
            <span class="c1"># Even if it shoud probably not be the case,</span>
            <span class="c1"># this is possible to have multiple translations for a same record in the same language.</span>
            <span class="c1"># The parenthesis surrounding the select are important, as this is a sub-select.</span>
            <span class="c1"># The quotes surrounding `ir_translation` are important as well.</span>
            <span class="n">unique_translation_subselect</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                (SELECT DISTINCT ON (res_id) res_id, value</span>
<span class="s2">                 FROM &quot;ir_translation&quot;</span>
<span class="s2">                 WHERE name=</span><span class="si">%s</span><span class="s2"> AND lang=</span><span class="si">%s</span><span class="s2"> AND value!=</span><span class="si">%s</span><span class="s2"></span>
<span class="s2">                 ORDER BY res_id, id DESC)</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">alias_statement</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">add_join</span><span class="p">(</span>
                <span class="p">(</span><span class="n">table_alias</span><span class="p">,</span> <span class="n">unique_translation_subselect</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="n">field</span><span class="p">),</span>
                <span class="n">implicit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">outer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">extra_params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">field</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;COALESCE(&quot;</span><span class="si">%s</span><span class="s1">&quot;.&quot;</span><span class="si">%s</span><span class="s1">&quot;, &quot;</span><span class="si">%s</span><span class="s1">&quot;.&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">table_alias</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;.&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table_alias</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_generate_m2o_order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">order_field</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">reverse_direction</span><span class="p">,</span> <span class="n">seen</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add possibly missing JOIN to ``query`` and generate the ORDER BY clause for m2o fields,</span>
<span class="sd">        either native m2o fields or function/related fields that are stored, including</span>
<span class="sd">        intermediate JOINs for inheritance if required.</span>

<span class="sd">        :return: the qualified field name to use in an ORDER BY clause to sort by ``order_field``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">order_field</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
            <span class="c1"># also add missing joins for reaching the table containing the m2o field</span>
            <span class="n">qualified_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_join_calc</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">order_field</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="n">alias</span><span class="p">,</span> <span class="n">order_field</span> <span class="o">=</span> <span class="n">qualified_field</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">base_field</span>

        <span class="k">assert</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span><span class="p">,</span> <span class="s1">&#39;Invalid field passed to _generate_m2o_order_by()&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Many2one function/related fields must be stored &quot;</span>
                          <span class="s2">&quot;to be used as ordering fields! Ignoring sorting for </span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="n">order_field</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># figure out the applicable order_by for the m2o</span>
        <span class="n">dest_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span>
        <span class="n">m2o_order</span> <span class="o">=</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_order</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">regex_order</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">m2o_order</span><span class="p">):</span>
            <span class="c1"># _order is complex, can&#39;t use it here, so we default to _rec_name</span>
            <span class="n">m2o_order</span> <span class="o">=</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_rec_name</span>

        <span class="c1"># Join the dest m2o table if it&#39;s not joined yet. We use [LEFT] OUTER join here</span>
        <span class="c1"># as we don&#39;t want to exclude results that have NULL values for the m2o</span>
        <span class="n">join</span> <span class="o">=</span> <span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">order_field</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">order_field</span><span class="p">)</span>
        <span class="n">dest_alias</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">add_join</span><span class="p">(</span><span class="n">join</span><span class="p">,</span> <span class="n">implicit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dest_model</span><span class="o">.</span><span class="n">_generate_order_by_inner</span><span class="p">(</span><span class="n">dest_alias</span><span class="p">,</span> <span class="n">m2o_order</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span>
                                                   <span class="n">reverse_direction</span><span class="p">,</span> <span class="n">seen</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_generate_order_by_inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alias</span><span class="p">,</span> <span class="n">order_spec</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">reverse_direction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seen</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">seen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_qorder</span><span class="p">(</span><span class="n">order_spec</span><span class="p">)</span>

        <span class="n">order_by_elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">order_part</span> <span class="ow">in</span> <span class="n">order_spec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">order_split</span> <span class="o">=</span> <span class="n">order_part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="n">order_field</span> <span class="o">=</span> <span class="n">order_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">order_direction</span> <span class="o">=</span> <span class="n">order_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">order_split</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">reverse_direction</span><span class="p">:</span>
                <span class="n">order_direction</span> <span class="o">=</span> <span class="s1">&#39;ASC&#39;</span> <span class="k">if</span> <span class="n">order_direction</span> <span class="o">==</span> <span class="s1">&#39;DESC&#39;</span> <span class="k">else</span> <span class="s1">&#39;DESC&#39;</span>
            <span class="n">do_reverse</span> <span class="o">=</span> <span class="n">order_direction</span> <span class="o">==</span> <span class="s1">&#39;DESC&#39;</span>

            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">order_field</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Sorting field </span><span class="si">%s</span><span class="s2"> not found on model </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">order_field</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">order_field</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
                <span class="n">order_by_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;.&quot;</span><span class="si">%s</span><span class="s1">&quot; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">order_field</span><span class="p">,</span> <span class="n">order_direction</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">base_field</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">,</span> <span class="n">order_field</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                        <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="n">order_by_elements</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_m2o_order_by</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">order_field</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">do_reverse</span><span class="p">,</span> <span class="n">seen</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">column_type</span><span class="p">:</span>
                    <span class="n">qualifield_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inherits_join_calc</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="n">order_field</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">implicit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;boolean&#39;</span><span class="p">:</span>
                        <span class="n">qualifield_name</span> <span class="o">=</span> <span class="s2">&quot;COALESCE(</span><span class="si">%s</span><span class="s2">, false)&quot;</span> <span class="o">%</span> <span class="n">qualifield_name</span>
                    <span class="n">order_by_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qualifield_name</span><span class="p">,</span> <span class="n">order_direction</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>  <span class="c1"># ignore non-readable or &quot;non-joinable&quot; fields</span>

        <span class="k">return</span> <span class="n">order_by_elements</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_generate_order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_spec</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attempt to construct an appropriate ORDER BY clause based on order_spec, which must be</span>
<span class="sd">        a comma-separated list of valid field names, optionally followed by an ASC or DESC direction.</span>

<span class="sd">        :raise ValueError in case order_spec is malformed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">order_by_clause</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">order_spec</span> <span class="o">=</span> <span class="n">order_spec</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span>
        <span class="k">if</span> <span class="n">order_spec</span><span class="p">:</span>
            <span class="n">order_by_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_order_by_inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">order_spec</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">order_by_elements</span><span class="p">:</span>
                <span class="n">order_by_clause</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">order_by_elements</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">order_by_clause</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39; ORDER BY </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">order_by_clause</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">access_rights_uid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private implementation of search() method, allowing specifying the uid to use for the access right check.</span>
<span class="sd">        This is useful for example when filling in the selection list for a drop-down and avoiding access rights errors,</span>
<span class="sd">        by specifying ``access_rights_uid=1`` to bypass access rights check, but not ir.rules!</span>
<span class="sd">        This is ok at the security level because this method is private and not callable through XML-RPC.</span>

<span class="sd">        :param access_rights_uid: optional user ID to use when checking access rights</span>
<span class="sd">                                  (not for ir.rules, this is only for ir.model.access)</span>
<span class="sd">        :return: a list of record ids or an integer (if count is True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">(</span><span class="n">access_rights_uid</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">)</span><span class="o">.</span><span class="n">check_access_rights</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">)</span>

        <span class="c1"># For transient models, restrict access to the current user, except for the super-user</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_transient</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_access</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span> <span class="o">!=</span> <span class="n">SUPERUSER_ID</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">AND</span><span class="p">(([(</span><span class="s1">&#39;create_uid&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">)],</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">[]))</span>

        <span class="k">if</span> <span class="n">expression</span><span class="o">.</span><span class="n">is_false</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
            <span class="c1"># optimization: no need to query, as no record satisfies the domain</span>
            <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">count</span> <span class="k">else</span> <span class="p">[]</span>

        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_where_calc</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_ir_rules</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">)</span>
        <span class="n">order_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_order_by</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">from_clause</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">where_clause_params</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">get_sql</span><span class="p">()</span>

        <span class="n">where_str</span> <span class="o">=</span> <span class="n">where_clause</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot; WHERE </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">where_clause</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
            <span class="c1"># Ignore order, limit and offset when just counting, they don&#39;t make sense and could</span>
            <span class="c1"># hurt performance</span>
            <span class="n">query_str</span> <span class="o">=</span> <span class="s1">&#39;SELECT count(1) FROM &#39;</span> <span class="o">+</span> <span class="n">from_clause</span> <span class="o">+</span> <span class="n">where_str</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_str</span><span class="p">,</span> <span class="n">where_clause_params</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">limit_str</span> <span class="o">=</span> <span class="n">limit</span> <span class="ow">and</span> <span class="s1">&#39; limit </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">limit</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">offset_str</span> <span class="o">=</span> <span class="n">offset</span> <span class="ow">and</span> <span class="s1">&#39; offset </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">offset</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="n">query_str</span> <span class="o">=</span> <span class="s1">&#39;SELECT &quot;</span><span class="si">%s</span><span class="s1">&quot;.id FROM &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="n">from_clause</span> <span class="o">+</span> <span class="n">where_str</span> <span class="o">+</span> <span class="n">order_by</span> <span class="o">+</span> <span class="n">limit_str</span> <span class="o">+</span> <span class="n">offset_str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query_str</span><span class="p">,</span> <span class="n">where_clause_params</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

        <span class="c1"># TDE note: with auto_join, we could have several lines about the same result</span>
        <span class="c1"># i.e. a lead with several unread messages; we uniquify the result using</span>
        <span class="c1"># a fast way to do it while preserving order (http://www.peterbe.com/plog/uniqifiers-benchmark)</span>
        <span class="k">def</span> <span class="nf">_uniquify_list</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
            <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seq</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">_uniquify_list</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span><span class="p">])</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">copy_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copy given record&#39;s data with all its fields values</span>

<span class="sd">        :param default: field values to override in the original values of the copied record</span>
<span class="sd">        :return: list with a dictionary containing all the field values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># In the old API, this method took a single id and return a dict. When</span>
        <span class="c1"># invoked with the new API, it returned a list of dicts.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>

        <span class="c1"># avoid recursion through already copied records in case of circular relationship</span>
        <span class="k">if</span> <span class="s1">&#39;__copy_data_seen&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
            <span class="bp">self</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">__copy_data_seen</span><span class="o">=</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">))</span>
        <span class="n">seen_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;__copy_data_seen&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">seen_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="n">seen_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="s1">&#39;state&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default</span> <span class="ow">and</span> <span class="s1">&#39;state&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_cache</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_record</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="n">default</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># build a black list of fields that should not be copied</span>
        <span class="n">blacklist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">MAGIC_COLUMNS</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;parent_left&#39;</span><span class="p">,</span> <span class="s1">&#39;parent_right&#39;</span><span class="p">])</span>
        <span class="n">whitelist</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">blacklist_given_fields</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="c1"># blacklist the fields that are given by inheritance</span>
            <span class="k">for</span> <span class="n">parent_model</span><span class="p">,</span> <span class="n">parent_field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_inherits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">blacklist</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">parent_field</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parent_field</span> <span class="ow">in</span> <span class="n">default</span><span class="p">:</span>
                    <span class="c1"># all the fields of &#39;parent_model&#39; are given by the record:</span>
                    <span class="c1"># default[parent_field], except the ones redefined in self</span>
                    <span class="n">blacklist</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent_model</span><span class="p">]</span><span class="o">.</span><span class="n">_fields</span><span class="p">)</span> <span class="o">-</span> <span class="n">whitelist</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">blacklist_given_fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">parent_model</span><span class="p">])</span>
            <span class="c1"># blacklist deprecated fields</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">deprecated</span><span class="p">:</span>
                    <span class="n">blacklist</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">blacklist_given_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">fields_to_copy</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">field</span>
                          <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                          <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">copy</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">default</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_to_copy</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span><span class="p">:</span>
                <span class="c1"># duplicate following the order of the ids because we&#39;ll rely on</span>
                <span class="c1"># it later for copying translations in copy_translation()!</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">copy_data</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)]</span>
                <span class="c1"># the lines are duplicated using the wrong (old) parent, but then</span>
                <span class="c1"># are reassigned to the correct one thanks to the (0, 0, ...)</span>
                <span class="n">default</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span><span class="p">:</span>
                <span class="n">default</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">ids</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">default</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">default</span><span class="p">]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">copy_translations</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
        <span class="c1"># avoid recursion through already copied records in case of circular relationship</span>
        <span class="k">if</span> <span class="s1">&#39;__copy_translations_seen&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">old</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">__copy_translations_seen</span><span class="o">=</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">))</span>
        <span class="n">seen_map</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;__copy_translations_seen&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">old</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">seen_map</span><span class="p">[</span><span class="n">old</span><span class="o">.</span><span class="n">_name</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="n">seen_map</span><span class="p">[</span><span class="n">old</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">old</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_trans</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Return the &#39;name&#39; of the translations to search for, together</span>
<span class="sd">                with the record ids corresponding to ``old`` and ``new``.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">inherited</span><span class="p">:</span>
                <span class="n">pname</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">related</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">get_trans</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">related_field</span><span class="p">,</span> <span class="n">old</span><span class="p">[</span><span class="n">pname</span><span class="p">],</span> <span class="n">new</span><span class="p">[</span><span class="n">pname</span><span class="p">])</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">old</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">new</span><span class="o">.</span><span class="n">id</span>

        <span class="c1"># removing the lang to compare untranslated values</span>
        <span class="n">old_wo_lang</span><span class="p">,</span> <span class="n">new_wo_lang</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span> <span class="o">+</span> <span class="n">new</span><span class="p">)</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">Translation</span> <span class="o">=</span> <span class="n">old</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.translation&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">old</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">copy</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;one2many&#39;</span><span class="p">:</span>
                <span class="c1"># we must recursively copy the translations for o2m; here we</span>
                <span class="c1"># rely on the order of the ids to match the translations as</span>
                <span class="c1"># foreseen in copy_data()</span>
                <span class="n">old_lines</span> <span class="o">=</span> <span class="n">old</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
                <span class="n">new_lines</span> <span class="o">=</span> <span class="n">new</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">sorted</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">old_line</span><span class="p">,</span> <span class="n">new_line</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="n">old_lines</span><span class="p">,</span> <span class="n">new_lines</span><span class="p">):</span>
                    <span class="n">old_line</span><span class="o">.</span><span class="n">copy_translations</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">:</span>
                <span class="c1"># for translatable fields we copy their translations</span>
                <span class="n">trans_name</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">target_id</span> <span class="o">=</span> <span class="n">get_trans</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">trans_name</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)]</span>
                <span class="n">new_val</span> <span class="o">=</span> <span class="n">new_wo_lang</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">old</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">translate</span><span class="p">):</span>
                    <span class="c1"># the new value *without lang* must be the old value without lang</span>
                    <span class="n">new_wo_lang</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_wo_lang</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">Translation</span><span class="o">.</span><span class="n">search_read</span><span class="p">(</span><span class="n">domain</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>      <span class="c1"># remove source to avoid triggering _set_src</span>
                    <span class="k">del</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]</span>      <span class="c1"># duplicated vals is not linked to any module</span>
                    <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;res_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_id</span>
                    <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">old</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">lang</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">translate</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_wo_lang</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                        <span class="c1"># the value should be the new value (given by copy())</span>
                        <span class="n">vals</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
                    <span class="n">Translation</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; copy(default=None)</span>

<span class="sd">        Duplicate record ``self`` updating it with default values</span>

<span class="sd">        :param dict default: dictionary of field values to override in the</span>
<span class="sd">               original values of the copied record, e.g: ``{&#39;field_name&#39;: overridden_value, ...}``</span>
<span class="sd">        :returns: new record</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ensure_one</span><span class="p">()</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_data</span><span class="p">(</span><span class="n">default</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># To avoid to create a translation in the lang of the user, copy_translation will do it</span>
        <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">lang</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_translations</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="nd">@api</span><span class="o">.</span><span class="n">returns</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  exists() -&gt; records</span>

<span class="sd">        Returns the subset of records in ``self`` that exist, and marks deleted</span>
<span class="sd">        records as such in cache. It can be used as a test on records::</span>

<span class="sd">            if record.exists():</span>
<span class="sd">                ...</span>

<span class="sd">        By convention, new records are returned as existing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids</span><span class="p">,</span> <span class="n">new_ids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
            <span class="p">(</span><span class="n">ids</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">integer_types</span><span class="p">)</span> <span class="k">else</span> <span class="n">new_ids</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT id FROM &quot;</span><span class="si">%s</span><span class="s2">&quot; WHERE id IN </span><span class="si">%%</span><span class="s2">s&quot;&quot;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">)])</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span> <span class="o">+</span> <span class="n">new_ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># mark missing records in cache with a failed value</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">MissingError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Record does not exist or has been deleted.&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set_failed</span><span class="p">(</span><span class="bp">self</span> <span class="o">-</span> <span class="n">existing</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">exc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">existing</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">_check_recursion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that there is no loop in a hierarchical structure of records,</span>
<span class="sd">        by following the parent relationship using the **parent** field until a</span>
<span class="sd">        loop is detected or until a top-level record is found.</span>

<span class="sd">        :param parent: optional parent field name (default: ``self._parent_name``)</span>
<span class="sd">        :return: **True** if no loop was found, **False** otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_name</span>

        <span class="c1"># must ignore &#39;active&#39; flag, ir.rules, etc. =&gt; direct SQL query</span>
        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT &quot;</span><span class="si">%s</span><span class="s1">&quot; FROM &quot;</span><span class="si">%s</span><span class="s1">&quot; WHERE id = </span><span class="si">%%</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">:</span>
            <span class="n">current_id</span> <span class="o">=</span> <span class="nb">id</span>
            <span class="k">while</span> <span class="n">current_id</span><span class="p">:</span>
                <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="n">current_id</span><span class="p">,))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                <span class="n">current_id</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">result</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">current_id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">_check_m2m_recursion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies that there is no loop in a directed graph of records, by</span>
<span class="sd">        following a many2many relationship with the given field name.</span>

<span class="sd">        :param field_name: field to check</span>
<span class="sd">        :return: **True** if no loop was found, **False** otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">field</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2many&#39;</span> <span class="ow">and</span>
                <span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">):</span>
            <span class="c1"># field must be a many2many on itself</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid field_name: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field_name</span><span class="p">,))</span>

        <span class="n">cr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT &quot;</span><span class="si">%s</span><span class="s1">&quot;, &quot;</span><span class="si">%s</span><span class="s1">&quot; FROM &quot;</span><span class="si">%s</span><span class="s1">&quot; WHERE &quot;</span><span class="si">%s</span><span class="s1">&quot; IN </span><span class="si">%%</span><span class="s1">s AND &quot;</span><span class="si">%s</span><span class="s1">&quot; IS NOT NULL&#39;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">column1</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">column2</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">relation</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">column1</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">column2</span><span class="p">)</span>

        <span class="n">succs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>        <span class="c1"># transitive closure of successors</span>
        <span class="n">preds</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>        <span class="c1"># transitive closure of predecessors</span>
        <span class="n">todo</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">),</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
            <span class="c1"># retrieve the respective successors of the nodes in &#39;todo&#39;</span>
            <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">todo</span><span class="p">)])</span>
            <span class="n">done</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">todo</span><span class="p">)</span>
            <span class="n">todo</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span> <span class="ow">in</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                <span class="c1"># connect id1 and its predecessors to id2 and its successors</span>
                <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">([</span><span class="n">id1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">preds</span><span class="p">[</span><span class="n">id1</span><span class="p">]),</span>
                                              <span class="p">[</span><span class="n">id2</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">succs</span><span class="p">[</span><span class="n">id2</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>    <span class="c1"># we found a cycle here!</span>
                    <span class="n">succs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                    <span class="n">preds</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">id2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                    <span class="n">todo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">id2</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">_get_external_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the External ID(s) of any database record.</span>

<span class="sd">        **Synopsis**: ``_get_xml_ids() -&gt; { &#39;id&#39;: [&#39;module.xml_id&#39;] }``</span>

<span class="sd">        :return: map of ids to the list of their fully qualified External IDs</span>
<span class="sd">                 in the form ``module.key``, or an empty list when there&#39;s no External</span>
<span class="sd">                 ID for a record, e.g.::</span>

<span class="sd">                     { &#39;id&#39;: [&#39;module.ext_id&#39;, &#39;module.ext_id_bis&#39;],</span>
<span class="sd">                       &#39;id2&#39;: [] }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">}</span>
        <span class="n">domain</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;res_id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="s1">&#39;ir.model.data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">search_read</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;res_id&#39;</span><span class="p">]):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;res_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(module)s</span><span class="s1">.</span><span class="si">%(name)s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">get_external_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the External ID of any database record, if there</span>
<span class="sd">        is one. This method works as a possible implementation</span>
<span class="sd">        for a function field, to be able to add it to any</span>
<span class="sd">        model object easily, referencing it as ``Model.get_external_id``.</span>

<span class="sd">        When multiple External IDs exist for a record, only one</span>
<span class="sd">        of them is returned (randomly).</span>

<span class="sd">        :return: map of ids to their fully qualified XML ID,</span>
<span class="sd">                 defaulting to an empty string when there&#39;s none</span>
<span class="sd">                 (to be usable as a function field),</span>
<span class="sd">                 e.g.::</span>

<span class="sd">                     { &#39;id&#39;: &#39;module.ext_id&#39;,</span>
<span class="sd">                       &#39;id2&#39;: &#39;&#39; }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_external_ids</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">val</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="c1"># backwards compatibility</span>
    <span class="n">get_xml_id</span> <span class="o">=</span> <span class="n">get_external_id</span>
    <span class="n">_get_xml_ids</span> <span class="o">=</span> <span class="n">_get_external_ids</span>

    <span class="c1"># Transience</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">is_transient</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return whether the model is transient.</span>

<span class="sd">        See :class:`TransientModel`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_transient</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model_cr</span>
    <span class="k">def</span> <span class="nf">_transient_clean_rows_older_than</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transient</span><span class="p">,</span> <span class="s2">&quot;Model </span><span class="si">%s</span><span class="s2"> is not transient, it cannot be vacuumed!&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
        <span class="c1"># Never delete rows used in last 5 minutes</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">seconds</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SELECT id FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">+</span> <span class="s2">&quot; WHERE&quot;</span>
            <span class="s2">&quot; COALESCE(write_date, create_date, (now() at time zone &#39;UTC&#39;))::timestamp&quot;</span>
            <span class="s2">&quot; &lt; ((now() at time zone &#39;UTC&#39;) - interval </span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> seconds&quot;</span> <span class="o">%</span> <span class="n">seconds</span><span class="p">,))</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model_cr</span>
    <span class="k">def</span> <span class="nf">_transient_clean_old_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_count</span><span class="p">):</span>
        <span class="c1"># Check how many rows we have in the table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT count(*) AS row_count FROM &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cr</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_count</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># max not reached, nothing to do</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transient_clean_rows_older_than</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_transient_vacuum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clean the transient records.</span>

<span class="sd">        This unlinks old records from the transient model tables whenever the</span>
<span class="sd">        &quot;_transient_max_count&quot; or &quot;_max_age&quot; conditions (if any) are reached.</span>
<span class="sd">        Actual cleaning will happen only once every &quot;_transient_check_time&quot; calls.</span>
<span class="sd">        This means this method can be called frequently called (e.g. whenever</span>
<span class="sd">        a new record is created).</span>
<span class="sd">        Example with both max_hours and max_count active:</span>
<span class="sd">        Suppose max_hours = 0.2 (e.g. 12 minutes), max_count = 20, there are 55 rows in the</span>
<span class="sd">        table, 10 created/changed in the last 5 minutes, an additional 12 created/changed between</span>
<span class="sd">        5 and 10 minutes ago, the rest created/changed more then 12 minutes ago.</span>
<span class="sd">        - age based vacuum will leave the 22 rows created/changed in the last 12 minutes</span>
<span class="sd">        - count based vacuum will wipe out another 12 rows. Not just 2, otherwise each addition</span>
<span class="sd">          would immediately cause the maximum to be reached again.</span>
<span class="sd">        - the 10 rows that have been created/changed the last 5 minutes will NOT be deleted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transient</span><span class="p">,</span> <span class="s2">&quot;Model </span><span class="si">%s</span><span class="s2"> is not transient, it cannot be vacuumed!&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
        <span class="n">_transient_check_time</span> <span class="o">=</span> <span class="mi">20</span>          <span class="c1"># arbitrary limit on vacuum executions</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_transient_check_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_transient_check_count</span> <span class="o">&lt;</span> <span class="n">_transient_check_time</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># no vacuum cleaning this time</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_transient_check_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Age-based expiration</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transient_max_hours</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transient_clean_rows_older_than</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transient_max_hours</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

        <span class="c1"># Count-based expiration</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transient_max_count</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_transient_clean_old_rows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transient_max_count</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">resolve_2many_commands</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">commands</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Serializes one2many and many2many commands into record dictionaries</span>
<span class="sd">            (as if all the records came from the database via a read()).  This</span>
<span class="sd">            method is aimed at onchange methods on one2many and many2many fields.</span>

<span class="sd">            Because commands might be creation commands, not all record dicts</span>
<span class="sd">            will contain an ``id`` field.  Commands matching an existing record</span>
<span class="sd">            will have an ``id``.</span>

<span class="sd">            :param field_name: name of the one2many or many2many field matching the commands</span>
<span class="sd">            :type field_name: str</span>
<span class="sd">            :param commands: one2many or many2many commands to execute on ``field_name``</span>
<span class="sd">            :type commands: list((int|False, int|False, dict|False))</span>
<span class="sd">            :param fields: list of fields to read from the database, when applicable</span>
<span class="sd">            :type fields: list(str)</span>
<span class="sd">            :returns: records in a shape similar to that returned by ``read()``</span>
<span class="sd">                (except records may be missing the ``id`` field if they don&#39;t exist in db)</span>
<span class="sd">            :rtype: list(dict)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>                     <span class="c1"># result (list of dict)</span>
        <span class="n">record_ids</span> <span class="o">=</span> <span class="p">[]</span>                 <span class="c1"># ids of records to read</span>
        <span class="n">updates</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>     <span class="c1"># {id: vals} of updates on records</span>

        <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span> <span class="ow">or</span> <span class="p">[]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">record_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">record_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">updates</span><span class="p">[</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">record_ids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">record_ids</span> <span class="k">if</span> <span class="nb">id</span> <span class="o">!=</span> <span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">record_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">record_ids</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">record_ids</span> <span class="o">=</span> <span class="p">[],</span> <span class="nb">list</span><span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># read the records and apply the updates</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">comodel_name</span><span class="p">]</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">record_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">records</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="p">{}))</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># for backward compatibility</span>
    <span class="n">resolve_o2m_commands_to_record_dicts</span> <span class="o">=</span> <span class="n">resolve_2many_commands</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">search_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a ``search()`` followed by a ``read()``.</span>

<span class="sd">        :param domain: Search domain, see ``args`` parameter in ``search()``. Defaults to an empty domain that will match all records.</span>
<span class="sd">        :param fields: List of fields to read, see ``fields`` parameter in ``read()``. Defaults to all fields.</span>
<span class="sd">        :param offset: Number of records to skip, see ``offset`` parameter in ``search()``. Defaults to 0.</span>
<span class="sd">        :param limit: Maximum number of records to return, see ``limit`` parameter in ``search()``. Defaults to no limit.</span>
<span class="sd">        :param order: Columns to sort result, see ``order`` parameter in ``search()``. Defaults to no sort.</span>
<span class="sd">        :return: List of dictionaries containing the asked fields.</span>
<span class="sd">        :rtype: List of dictionaries.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">domain</span> <span class="ow">or</span> <span class="p">[],</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">fields</span> <span class="ow">and</span> <span class="n">fields</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span>
            <span class="c1"># shortcut read if we only want the ids</span>
            <span class="k">return</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">}</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span>

        <span class="c1"># read() ignores active_test, but it would forward it to any downstream search call</span>
        <span class="c1"># (e.g. for x2m or function fields), and this is not the desired behavior, the flag</span>
        <span class="c1"># was presumably only meant for the main search().</span>
        <span class="c1"># TODO: Move this to read() directly?</span>
        <span class="k">if</span> <span class="s1">&#39;active_test&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;active_test&#39;</span><span class="p">]</span>
            <span class="n">records</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">records</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># reorder read</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">{</span><span class="n">vals</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]:</span> <span class="n">vals</span> <span class="k">for</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">result</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">record</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span> <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">index</span><span class="p">]</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">toggle_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Inverse the value of the field ``active`` on the records in ``self``. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">record</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">record</span><span class="o">.</span><span class="n">active</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model_cr</span>
    <span class="k">def</span> <span class="nf">_register_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; stuff to do right after the registry is built &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_patch_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Monkey-patch a method for all instances of this model. This replaces</span>
<span class="sd">            the method called ``name`` by ``method`` in the given class.</span>
<span class="sd">            The original method is then accessible via ``method.origin``, and it</span>
<span class="sd">            can be restored with :meth:`~._revert_method`.</span>

<span class="sd">            Example::</span>

<span class="sd">                @api.multi</span>
<span class="sd">                def do_write(self, values):</span>
<span class="sd">                    # do stuff, and call the original method</span>
<span class="sd">                    return do_write.origin(self, values)</span>

<span class="sd">                # patch method write of model</span>
<span class="sd">                model._patch_method(&#39;write&#39;, do_write)</span>

<span class="sd">                # this will call do_write</span>
<span class="sd">                records = model.search([...])</span>
<span class="sd">                records.write(...)</span>

<span class="sd">                # restore the original method</span>
<span class="sd">                model._revert_method(&#39;write&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">method</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="c1"># propagate decorators from origin to method, and apply api decorator</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">guess</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">method</span><span class="p">))</span>
        <span class="n">wrapped</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_revert_method</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Revert the original method called ``name`` in the given class.</span>
<span class="sd">            See :meth:`~._patch_method`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">method</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Instance creation</span>
    <span class="c1">#</span>
    <span class="c1"># An instance represents an ordered collection of records in a given</span>
    <span class="c1"># execution environment. The instance object refers to the environment, and</span>
    <span class="c1"># the records themselves are represented by their cache dictionary. The &#39;id&#39;</span>
    <span class="c1"># of each record is found in its corresponding cache dictionary.</span>
    <span class="c1">#</span>
    <span class="c1"># This design has the following advantages:</span>
    <span class="c1">#  - cache access is direct and thus fast;</span>
    <span class="c1">#  - one can consider records without an &#39;id&#39; (see new records);</span>
    <span class="c1">#  - the global cache is only an index to &quot;resolve&quot; a record &#39;id&#39;.</span>
    <span class="c1">#</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_browse</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">prefetch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create a recordset instance.</span>

<span class="sd">        :param ids: a tuple of record ids</span>
<span class="sd">        :param env: an environment</span>
<span class="sd">        :param prefetch: an optional prefetch object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">records</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="n">records</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="n">records</span><span class="o">.</span><span class="n">_ids</span> <span class="o">=</span> <span class="n">ids</span>
        <span class="k">if</span> <span class="n">prefetch</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prefetch</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>         <span class="c1"># {model_name: set(ids)}</span>
        <span class="n">records</span><span class="o">.</span><span class="n">_prefetch</span> <span class="o">=</span> <span class="n">prefetch</span>
        <span class="n">prefetch</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">records</span>

    <span class="k">def</span> <span class="nf">browse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">prefetch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; browse([ids]) -&gt; records</span>

<span class="sd">        Returns a recordset for the ids provided as parameter in the current</span>
<span class="sd">        environment.</span>

<span class="sd">        Can take no ids, a single id or a sequence of ids.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">_normalize_ids</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="c1">#assert all(isinstance(id, IdType) for id in ids), &quot;Browsing invalid ids: %s&quot; % ids</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browse</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">prefetch</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Internal properties, for manipulating the instance&#39;s implementation</span>
    <span class="c1">#</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; List of actual record ids in this recordset (ignores placeholder</span>
<span class="sd">        ids for records to create)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span> <span class="k">if</span> <span class="n">it</span><span class="p">]</span>

    <span class="c1"># backward-compatibility with former browse records</span>
    <span class="n">_cr</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cr</span><span class="p">)</span>
    <span class="n">_uid</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>
    <span class="n">_context</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Conversion methods</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">ensure_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Verifies that the current recorset holds a single record. Raises</span>
<span class="sd">        an exception otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expected singleton: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">with_env</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns a new version of this recordset attached to the provided</span>
<span class="sd">        environment</span>

<span class="sd">        .. warning::</span>
<span class="sd">            The new environment will not benefit from the current</span>
<span class="sd">            environment&#39;s data cache, so later data access may incur extra</span>
<span class="sd">            delays while re-fetching from the database.</span>
<span class="sd">            The returned recordset has the same prefetch object as ``self``.</span>

<span class="sd">        :type env: :class:`~gerp.api.Environment`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sudo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">SUPERUSER_ID</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; sudo([user=SUPERUSER])</span>

<span class="sd">        Returns a new version of this recordset attached to the provided</span>
<span class="sd">        user.</span>

<span class="sd">        By default this returns a ``SUPERUSER`` recordset, where access</span>
<span class="sd">        control and record rules are bypassed.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Using ``sudo`` could cause data access to cross the</span>
<span class="sd">            boundaries of record rules, possibly mixing records that</span>
<span class="sd">            are meant to be isolated (e.g. records from different</span>
<span class="sd">            companies in multi-company environments).</span>

<span class="sd">            It may lead to un-intuitive results in methods which select one</span>
<span class="sd">            record among many - for example getting the default company, or</span>
<span class="sd">            selecting a Bill of Materials.</span>

<span class="sd">        .. note::</span>

<span class="sd">            Because the record rules and access control will have to be</span>
<span class="sd">            re-evaluated, the new recordset will not benefit from the current</span>
<span class="sd">            environment&#39;s data cache, so later data access may incur extra</span>
<span class="sd">            delays while re-fetching from the database.</span>
<span class="sd">            The returned recordset has the same prefetch object as ``self``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_env</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">with_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; with_context([context][, **overrides]) -&gt; records</span>

<span class="sd">        Returns a new version of this recordset attached to an extended</span>
<span class="sd">        context.</span>

<span class="sd">        The extended context is either the provided ``context`` in which</span>
<span class="sd">        ``overrides`` are merged or the *current* context in which</span>
<span class="sd">        ``overrides`` are merged e.g.::</span>

<span class="sd">            # current context is {&#39;key1&#39;: True}</span>
<span class="sd">            r2 = records.with_context({}, key2=True)</span>
<span class="sd">            # -&gt; r2._context is {&#39;key2&#39;: True}</span>
<span class="sd">            r2 = records.with_context(key2=True)</span>
<span class="sd">            # -&gt; r2._context is {&#39;key1&#39;: True, &#39;key2&#39;: True}</span>

<span class="sd">        .. note:</span>

<span class="sd">            The returned recordset has the same prefetch object as ``self``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_env</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">with_prefetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefetch</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; with_prefetch([prefetch]) -&gt; records</span>

<span class="sd">        Return a new version of this recordset that uses the given prefetch</span>
<span class="sd">        object, or a new prefetch object if not given.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">prefetch</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_convert_to_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convert the ``values`` dictionary into cached values.</span>

<span class="sd">            :param update: whether the conversion is made for updating ``self``;</span>
<span class="sd">                this is necessary for interpreting the commands of *2many fields</span>
<span class="sd">            :param validate: whether values must be checked</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">update</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">([],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="n">fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">convert_to_cache</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fields</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_convert_to_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convert the ``values`` dictionary from the cache format to the</span>
<span class="sd">        record format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">convert_to_record</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_convert_to_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convert the ``values`` dictionary into the format of :meth:`write`. &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_cache</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_record</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">NewId</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c1">#</span>
    <span class="c1"># Record traversal and update</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_mapped_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Apply function ``func`` on all records in ``self``, and return the</span>
<span class="sd">            result as a list or a recordset (if ``func`` returns recordsets).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">BaseModel</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">vals</span><span class="p">)</span>         <span class="c1"># union of all recordsets</span>
            <span class="k">return</span> <span class="n">vals</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">vals</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">mapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Apply ``func`` on all records in ``self``, and return the result as a</span>
<span class="sd">            list or a recordset (if ``func`` return recordsets). In the latter</span>
<span class="sd">            case, the order of the returned recordset is arbitrary.</span>

<span class="sd">            :param func: a function or a dot-separated sequence of field names</span>
<span class="sd">                (string); any falsy value simply returns the recordset ``self``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>                 <span class="c1"># support for an empty path of fields</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">recs</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">_mapped_func</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">recs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mapped_func</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mapped_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_seq</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Same as `~.mapped`, but ``name_seq`` is a dot-separated sequence of</span>
<span class="sd">            field names, and only cached values are used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">name_seq</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">null</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_cache</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">recs</span><span class="p">:</span>
                <span class="n">recs</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rec</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_record</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">null</span><span class="p">),</span> <span class="n">rec</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">recs</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_record</span><span class="p">(</span><span class="n">null</span><span class="p">,</span> <span class="n">recs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">recs</span>

    <span class="k">def</span> <span class="nf">filtered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Select the records in ``self`` such that ``func(rec)`` is true, and</span>
<span class="sd">            return them as a recordset.</span>

<span class="sd">            :param func: a function or a dot-separated sequence of field names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">func</span>
            <span class="n">func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rec</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="n">rec</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">func</span><span class="p">(</span><span class="n">rec</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the recordset ``self`` ordered by ``key``.</span>

<span class="sd">            :param key: either a function of one argument that returns a</span>
<span class="sd">                comparison key for each record, or a field name, or ``None``, in</span>
<span class="sd">                which case records are ordered according the default model&#39;s order</span>

<span class="sd">            :param reverse: if ``True``, return the result in reverse order</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">recs</span><span class="o">.</span><span class="n">_ids</span><span class="p">))</span> <span class="k">if</span> <span class="n">reverse</span> <span class="k">else</span> <span class="n">recs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">itemgetter</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update the records in ``self`` with ``values``. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1">#</span>
    <span class="c1"># New records - represent records that do not exist in the database yet;</span>
    <span class="c1"># they are used to perform onchanges.</span>
    <span class="c1">#</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="p">{},</span> <span class="n">ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; new([values]) -&gt; record</span>

<span class="sd">        Return a new record instance attached to the current environment and</span>
<span class="sd">        initialized with the provided ``value``. The record is *not* created</span>
<span class="sd">        in database, it only exists in memory.</span>

<span class="sd">        One can pass a reference value to identify the record among other new</span>
<span class="sd">        records. The reference is encapsulated in the ``id`` of the record.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="n">NewId</span><span class="p">(</span><span class="n">ref</span><span class="p">)])</span>
        <span class="n">record</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">_convert_to_cache</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">in_onchange</span><span class="p">:</span>
            <span class="c1"># The cache update does not set inverse fields, so do it manually.</span>
            <span class="c1"># This is useful for computing a function field on secondary</span>
            <span class="c1"># records, if that field depends on the main record.</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">invf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_inverses</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                        <span class="n">invf</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">record</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">record</span>

    <span class="c1">#</span>
    <span class="c1"># Dirty flags, to mark record fields modified (in draft mode)</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_is_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return whether any record in ``self`` is dirty. &quot;&quot;&quot;</span>
        <span class="n">dirty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">dirty</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">record</span> <span class="ow">in</span> <span class="n">dirty</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the list of field names for which ``self`` is dirty. &quot;&quot;&quot;</span>
        <span class="n">dirty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">dirty</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">dirty</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">()))</span>

    <span class="k">def</span> <span class="nf">_set_dirty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Mark the records in ``self`` as dirty for the given ``field_name``. &quot;&quot;&quot;</span>
        <span class="n">dirty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">dirty</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">dirty</span><span class="p">[</span><span class="n">record</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># &quot;Dunder&quot; methods</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Test whether ``self`` is nonempty. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_ids&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
    <span class="n">__nonzero__</span> <span class="o">=</span> <span class="fm">__bool__</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the size of ``self``. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return an iterator over ``self``. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browse</span><span class="p">((</span><span class="nb">id</span><span class="p">,),</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Test whether ``item`` (record or field name) is an element of ``self``.</span>
<span class="sd">            In the first case, the test is fully equivalent to::</span>

<span class="sd">                any(item == record for record in self)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Mixing apples and oranges: </span><span class="si">%s</span><span class="s2"> in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the concatenation of two recordsets. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the concatenation of ``self`` with all the arguments (in</span>
<span class="sd">            linear time complexity).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Mixing apples and oranges: </span><span class="si">%s</span><span class="s2">.concat(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
            <span class="n">ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the recordset of all the records in ``self`` that are not in</span>
<span class="sd">            ``other``. Note that recordset order is preserved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Mixing apples and oranges: </span><span class="si">%s</span><span class="s2"> - </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>
        <span class="n">other_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other_ids</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__and__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the intersection of two recordsets.</span>
<span class="sd">            Note that first occurrence order is preserved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Mixing apples and oranges: </span><span class="si">%s</span><span class="s2"> &amp; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>
        <span class="n">other_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">OrderedSet</span><span class="p">(</span><span class="nb">id</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span> <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">other_ids</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__or__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the union of two recordsets.</span>
<span class="sd">            Note that first occurrence order is preserved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">union</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the union of ``self`` with all the arguments (in linear time</span>
<span class="sd">            complexity, with first occurrence order preserved).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Mixing apples and oranges: </span><span class="si">%s</span><span class="s2">.union(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
            <span class="n">ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">OrderedSet</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Test whether two recordsets are equivalent (up to reordering). &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">other</span><span class="p">:</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span> <span class="o">=</span> <span class="n">frame_codeinfo</span><span class="p">(</span><span class="n">currentframe</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Comparing apples and oranges: </span><span class="si">%r</span><span class="s2"> == </span><span class="si">%r</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span>
                                <span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span> <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span> <span class="o">==</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Mixing apples and oranges: </span><span class="si">%s</span><span class="s2"> &lt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__le__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Mixing apples and oranges: </span><span class="si">%s</span><span class="s2"> &lt;= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Mixing apples and oranges: </span><span class="si">%s</span><span class="s2"> &gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ge__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Mixing apples and oranges: </span><span class="si">%s</span><span class="s2"> &gt;= </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__int__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_ids&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_ids&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span> <span class="nb">frozenset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If ``key`` is an integer or a slice, return the corresponding record</span>
<span class="sd">            selection as an instance (attached to ``self.env``).</span>
<span class="sd">            Otherwise read the field ``key`` of the first record in ``self``.</span>

<span class="sd">            Examples::</span>

<span class="sd">                inst = model.search(dom)    # inst is a recordset</span>
<span class="sd">                r4 = inst[3]                # fourth record in inst</span>
<span class="sd">                rs = inst[10:20]            # subset of inst</span>
<span class="sd">                nm = rs[&#39;name&#39;]             # name of first record in inst</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">pycompat</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="c1"># important: one must call the field&#39;s getter</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_browse</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">[</span><span class="n">key</span><span class="p">],),</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Assign the field ``key`` to ``value`` in record ``self``. &quot;&quot;&quot;</span>
        <span class="c1"># important: one must call the field&#39;s setter</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Cache and recomputation management</span>
    <span class="c1">#</span>

    <span class="nd">@lazy_property</span>
    <span class="k">def</span> <span class="nf">_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the cache of ``self``, mapping field names to values. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">RecordCache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_in_cache_without</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">PREFETCH_MAX</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return records to prefetch that have no value in cache for ``field``</span>
<span class="sd">            (:class:`Field` instance), including ``self``.</span>
<span class="sd">            Return at most ``limit`` records.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prefetch</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">]</span>
        <span class="n">ids1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span><span class="o">.</span><span class="n">_ids</span><span class="p">)</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">([</span><span class="n">it</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">ids0</span> <span class="k">if</span> <span class="n">it</span> <span class="ow">and</span> <span class="n">it</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ids1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">recs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span> <span class="o">+</span> <span class="p">(</span><span class="n">recs</span> <span class="o">-</span> <span class="bp">self</span><span class="p">)[:(</span><span class="n">limit</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))]</span>
        <span class="k">return</span> <span class="n">recs</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Clear the records cache.</span>

<span class="sd">            .. deprecated:: 8.0</span>
<span class="sd">                The record cache is automatically invalidated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">invalidate_cache</span><span class="p">()</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">invalidate_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Invalidate the record caches after some records have been modified.</span>
<span class="sd">            If both ``fnames`` and ``ids`` are ``None``, the whole cache is cleared.</span>

<span class="sd">            :param fnames: the list of modified fields, or ``None`` for all fields</span>
<span class="sd">            :param ids: the list of modified record ids, or ``None`` for all</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">()</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">]</span>

        <span class="c1"># invalidate fields and inverse fields, too</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="p">[(</span><span class="n">f</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]</span> <span class="o">+</span> \
               <span class="p">[(</span><span class="n">invf</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">for</span> <span class="n">invf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_inverses</span><span class="p">[</span><span class="n">f</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">modified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnames</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Notify that fields have been modified on ``self``. This invalidates</span>
<span class="sd">            the cache, and prepares the recomputation of stored function fields</span>
<span class="sd">            (new-style fields only).</span>

<span class="sd">            :param fnames: iterable of field names that have been modified on</span>
<span class="sd">                records ``self``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># group triggers by (model, path) to minimize the calls to search()</span>
        <span class="n">invalids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">triggers</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">fnames</span><span class="p">:</span>
            <span class="n">mfield</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">fname</span><span class="p">]</span>
            <span class="c1"># invalidate mfield on self, and its inverses fields</span>
            <span class="n">invalids</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">mfield</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ids</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_inverses</span><span class="p">[</span><span class="n">mfield</span><span class="p">]:</span>
                <span class="n">invalids</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="c1"># group triggers by model and path to reduce the number of search()</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_triggers</span><span class="p">[</span><span class="n">mfield</span><span class="p">]:</span>
                <span class="n">triggers</span><span class="p">[(</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">path</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="c1"># process triggers, mark fields to be invalidated/recomputed</span>
        <span class="k">for</span> <span class="n">model_path</span><span class="p">,</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">triggers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">model_name</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">model_path</span>
            <span class="n">stored</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">compute</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">store</span><span class="p">}</span>
            <span class="c1"># process stored fields</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">stored</span><span class="p">:</span>
                <span class="c1"># determine records of model_name linked by path to self</span>
                <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
                    <span class="n">target0</span> <span class="o">=</span> <span class="bp">self</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">SUPERUSER_ID</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;active_test&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
                    <span class="n">target0</span> <span class="o">=</span> <span class="n">env</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">search</span><span class="p">([(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ids</span><span class="p">)])</span>
                    <span class="n">target0</span> <span class="o">=</span> <span class="n">target0</span><span class="o">.</span><span class="n">with_env</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
                <span class="c1"># prepare recomputation for each field on linked records</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">stored</span><span class="p">:</span>
                    <span class="c1"># discard records to not recompute for field</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">target0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">protected</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">invalids</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">_ids</span><span class="p">))</span>
                    <span class="c1"># mark field to be recomputed on target</span>
                    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">compute_sudo</span><span class="p">:</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">sudo</span><span class="p">()</span>
                    <span class="n">target</span><span class="o">.</span><span class="n">_recompute_todo</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="c1"># process non-stored fields</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">(</span><span class="n">fields</span> <span class="o">-</span> <span class="n">stored</span><span class="p">):</span>
                <span class="n">invalids</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p">(</span><span class="n">invalids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recompute_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; If ``field`` must be recomputed on some record in ``self``, return the</span>
<span class="sd">            corresponding records that must be recomputed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">check_todo</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recompute_todo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Mark ``field`` to be recomputed. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">add_todo</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recompute_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Mark ``field`` as recomputed. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">remove_todo</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">recompute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Recompute stored function fields. The fields and records to</span>
<span class="sd">            recompute have been determined by method :meth:`modified`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">has_todo</span><span class="p">():</span>
            <span class="n">field</span><span class="p">,</span> <span class="n">recs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_todo</span><span class="p">()</span>
            <span class="c1"># determine the fields to recompute</span>
            <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">_field_computed</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fs</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">store</span><span class="p">]</span>
            <span class="c1"># evaluate fields, and group record ids by update</span>
            <span class="n">updates</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">recs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="n">rec</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">}</span>
                <span class="k">except</span> <span class="n">MissingError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">rec</span><span class="o">.</span><span class="n">_convert_to_write</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
                <span class="n">updates</span><span class="p">[</span><span class="n">frozendict</span><span class="p">(</span><span class="n">vals</span><span class="p">)]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="c1"># update records in batch when possible</span>
            <span class="k">with</span> <span class="n">recs</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">norecompute</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">vals</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">updates</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">recs</span><span class="o">.</span><span class="n">browse</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">target</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">MissingError</span><span class="p">:</span>
                        <span class="c1"># retry without missing records</span>
                        <span class="n">target</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">vals</span><span class="p">))</span>

            <span class="c1"># mark computed fields as done</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fs</span><span class="p">:</span>
                <span class="n">recs</span><span class="o">.</span><span class="n">_recompute_done</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="c1"># Generic onchange method</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">_has_onchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">other_fields</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return whether ``field`` should trigger an onchange event in the</span>
<span class="sd">            presence of ``other_fields``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># test whether self has an onchange method for field, or field is a</span>
        <span class="c1"># dependency of any field in other_fields</span>
        <span class="k">return</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onchange_methods</span> <span class="ow">or</span> \
            <span class="nb">any</span><span class="p">(</span><span class="n">dep</span> <span class="ow">in</span> <span class="n">other_fields</span> <span class="k">for</span> <span class="n">dep</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_field_triggers</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">model</span>
    <span class="k">def</span> <span class="nf">_onchange_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the onchange spec from a view description; if not given, the</span>
<span class="sd">            result of ``self.fields_view_get()`` is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># for traversing the XML arch and populating result</span>
        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s1">&#39;field&#39;</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">prefix</span> <span class="k">else</span> <span class="n">name</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">names</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;on_change&#39;</span><span class="p">)</span>
                <span class="c1"># traverse the subviews included in relational fields</span>
                <span class="k">for</span> <span class="n">subinfo</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">process</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">subinfo</span><span class="p">[</span><span class="s1">&#39;arch&#39;</span><span class="p">]),</span> <span class="n">subinfo</span><span class="p">,</span> <span class="n">names</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                    <span class="n">process</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">view_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">view_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_view_get</span><span class="p">()</span>
        <span class="n">process</span><span class="p">(</span><span class="n">etree</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">view_info</span><span class="p">[</span><span class="s1">&#39;arch&#39;</span><span class="p">]),</span> <span class="n">view_info</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_onchange_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">onchange</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Apply onchange method(s) for field ``field_name`` with spec ``onchange``</span>
<span class="sd">            on record ``self``. Value assignments are applied on ``self``, while</span>
<span class="sd">            domain and warning messages are put in dictionary ``result``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">onchange</span> <span class="o">=</span> <span class="n">onchange</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">):</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;domain&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;warning&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;warning&#39;</span><span class="p">):</span>
                    <span class="c1"># Concatenate multiple warnings</span>
                    <span class="n">warning</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;warning&#39;</span><span class="p">]</span>
                    <span class="n">warning</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">[</span>
                        <span class="n">warning</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">),</span>
                        <span class="n">warning</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">),</span>
                        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;warning&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">),</span>
                        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;warning&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">),</span>
                    <span class="p">]</span> <span class="k">if</span> <span class="n">s</span><span class="p">)</span>
                    <span class="n">warning</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Warnings&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;warning&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;warning&#39;</span><span class="p">]</span>

        <span class="c1"># onchange V8</span>
        <span class="k">if</span> <span class="n">onchange</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_onchange_methods</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="p">()):</span>
                <span class="n">method_res</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">process</span><span class="p">(</span><span class="n">method_res</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># onchange V7</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">onchange_v7</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">onchange</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">method</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>

            <span class="k">class</span> <span class="nc">RawRecord</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_record</span> <span class="o">=</span> <span class="n">record</span>
                <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                    <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">field</span><span class="o">.</span><span class="n">convert_to_write</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">record</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="c1"># evaluate params -&gt; tuple</span>
            <span class="n">global_vars</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uid</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;field_parent&#39;</span><span class="p">):</span>
                <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;field_parent&#39;</span><span class="p">]]</span>
                <span class="n">global_vars</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RawRecord</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
            <span class="n">field_vars</span> <span class="o">=</span> <span class="n">RawRecord</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">safe_eval</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">params</span><span class="p">,</span> <span class="n">global_vars</span><span class="p">,</span> <span class="n">field_vars</span><span class="p">,</span> <span class="n">nocopy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># invoke onchange method</span>
            <span class="n">method_res</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">method</span><span class="p">)(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
            <span class="n">process</span><span class="p">(</span><span class="n">method_res</span><span class="p">)</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">multi</span>
    <span class="k">def</span> <span class="nf">onchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_onchange</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Perform an onchange on the given field.</span>

<span class="sd">            :param values: dictionary mapping field names to values, giving the</span>
<span class="sd">                current state of modification</span>
<span class="sd">            :param field_name: name of the modified field, or list of field</span>
<span class="sd">                names (in view order), or False</span>
<span class="sd">            :param field_onchange: dictionary mapping field names to their</span>
<span class="sd">                on_change attribute</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">field_name</span>
        <span class="k">elif</span> <span class="n">field_name</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="c1"># filter out keys in field_onchange that do not refer to actual fields</span>
        <span class="n">dotnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dotname</span> <span class="ow">in</span> <span class="n">field_onchange</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">browse</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dotname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">dotnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dotname</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># create a new record with values, and attach ``self`` to it</span>
        <span class="k">with</span> <span class="n">env</span><span class="o">.</span><span class="n">do_in_onchange</span><span class="p">():</span>
            <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">_cache</span><span class="p">}</span>
            <span class="c1"># attach ``self`` with a different context (for cache consistency)</span>
            <span class="n">record</span><span class="o">.</span><span class="n">_origin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="n">__onchange</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># load fields on secondary records, to avoid false changes</span>
        <span class="k">with</span> <span class="n">env</span><span class="o">.</span><span class="n">do_in_onchange</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">dotname</span> <span class="ow">in</span> <span class="n">dotnames</span><span class="p">:</span>
                <span class="n">record</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="n">dotname</span><span class="p">)</span>

        <span class="c1"># determine which field(s) should be triggered an onchange</span>
        <span class="n">todo</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># dummy assignment: trigger invalidations on the record</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">todo</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;many2one&#39;</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">delegate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="c1"># do not nullify all fields of parent record for new records</span>
                <span class="k">continue</span>
            <span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dirty</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># process names in order (or the keys of values if no name given)</span>
        <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">env</span><span class="o">.</span><span class="n">do_in_onchange</span><span class="p">():</span>
                <span class="c1"># apply field-specific onchange methods</span>
                <span class="k">if</span> <span class="n">field_onchange</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                    <span class="n">record</span><span class="o">.</span><span class="n">_onchange_eval</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">field_onchange</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">result</span><span class="p">)</span>

                <span class="c1"># force re-evaluation of function fields on secondary records</span>
                <span class="k">for</span> <span class="n">dotname</span> <span class="ow">in</span> <span class="n">dotnames</span><span class="p">:</span>
                    <span class="n">record</span><span class="o">.</span><span class="n">mapped</span><span class="p">(</span><span class="n">dotname</span><span class="p">)</span>

                <span class="c1"># determine which fields have been modified</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">oldval</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">newval</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">newval</span> <span class="o">!=</span> <span class="n">oldval</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;one2many&#39;</span><span class="p">,</span> <span class="s1">&#39;many2many&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">newval</span><span class="o">.</span><span class="n">_is_dirty</span><span class="p">()</span>
                    <span class="p">):</span>
                        <span class="n">todo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">dirty</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># determine subfields for field.convert_to_onchange() below</span>
        <span class="n">Tree</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">Tree</span><span class="p">)</span>
        <span class="n">subnames</span> <span class="o">=</span> <span class="n">Tree</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dotname</span> <span class="ow">in</span> <span class="n">dotnames</span><span class="p">:</span>
            <span class="n">subtree</span> <span class="o">=</span> <span class="n">subnames</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dotname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">subtree</span> <span class="o">=</span> <span class="n">subtree</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

        <span class="c1"># collect values from dirty fields</span>
        <span class="n">result</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">convert_to_onchange</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">record</span><span class="p">,</span> <span class="n">subnames</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">dirty</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">result</span>

<span class="n">collections</span><span class="o">.</span><span class="n">Set</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">)</span>
<span class="c1"># not exactly true as BaseModel doesn&#39;t have __reversed__, index or count</span>
<span class="n">collections</span><span class="o">.</span><span class="n">Sequence</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">RecordCache</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A mapping from field names to values, to read and update the cache of a record. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Unexpected RecordCache(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">record</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record</span> <span class="o">=</span> <span class="n">record</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return whether `record` has a cached value for field ``name``. &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the cached value of field ``name`` for `record`. &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Assign the cached value of field ``name`` for ``record``. &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Remove the cached value of field ``name`` for ``record``. &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate over the field names with a cached value. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the number of fields with a cached value. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">has_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return whether `record` has a cached, regular value for field ``name``. &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">contains_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the cached, regular value of field ``name`` for `record`, or ``default``. &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_special</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">getter</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Use the given getter to get the cached value of field ``name``. &quot;&quot;&quot;</span>
        <span class="n">field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set_special</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">getter</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Mark the given fields with the given exception. &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">set_failed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>


<span class="n">AbstractModel</span> <span class="o">=</span> <span class="n">BaseModel</span>

<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../reference/orm.html#gerp.models.Model">[docs]</a><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">AbstractModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Main super-class for regular database-persisted Odoo models.</span>

<span class="sd">    Odoo models are created by inheriting from this class::</span>

<span class="sd">        class user(Model):</span>
<span class="sd">            ...</span>

<span class="sd">    The system will later instantiate the class once per database (on</span>
<span class="sd">    which the class&#39; module is installed).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_auto</span> <span class="o">=</span> <span class="kc">True</span>                <span class="c1"># automatically create database backend</span>
    <span class="n">_register</span> <span class="o">=</span> <span class="kc">False</span>           <span class="c1"># not visible in ORM registry, meant to be python-inherited only</span>
    <span class="n">_abstract</span> <span class="o">=</span> <span class="kc">False</span>           <span class="c1"># not abstract</span>
    <span class="n">_transient</span> <span class="o">=</span> <span class="kc">False</span>          <span class="c1"># not transient</span></div>

<span class="k">class</span> <span class="nc">TransientModel</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Model super-class for transient records, meant to be temporarily</span>
<span class="sd">    persisted, and regularly vacuum-cleaned.</span>

<span class="sd">    A TransientModel has a simplified access rights management, all users can</span>
<span class="sd">    create new records, and may only access the records they created. The super-</span>
<span class="sd">    user has unrestricted access to all TransientModel records.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_auto</span> <span class="o">=</span> <span class="kc">True</span>                <span class="c1"># automatically create database backend</span>
    <span class="n">_register</span> <span class="o">=</span> <span class="kc">False</span>           <span class="c1"># not visible in ORM registry, meant to be python-inherited only</span>
    <span class="n">_abstract</span> <span class="o">=</span> <span class="kc">False</span>           <span class="c1"># not abstract</span>
    <span class="n">_transient</span> <span class="o">=</span> <span class="kc">True</span>           <span class="c1"># transient</span>

<span class="k">def</span> <span class="nf">itemgetter_tuple</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Fixes itemgetter inconsistency (useful in some cases) of not returning</span>
<span class="sd">    a tuple if len(items) == 1: always returns an n-tuple where n = len(items)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">gettable</span><span class="p">:</span> <span class="p">(</span><span class="n">gettable</span><span class="p">[</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]],)</span>
    <span class="k">return</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">*</span><span class="n">items</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">convert_pgerror_not_null</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">table_name</span> <span class="o">!=</span> <span class="n">model</span><span class="o">.</span><span class="n">_table</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="n">field_name</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">column_name</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;Missing required value for the field &#39;</span><span class="si">%s</span><span class="s2">&#39; (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;string&#39;</span><span class="p">],</span> <span class="n">field_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
        <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">convert_pgerror_unique</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
    <span class="c1"># new cursor since we&#39;re probably in an error handler in a blown</span>
    <span class="c1"># transaction which may not have been rollbacked/cleaned yet</span>
    <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cr</span><span class="p">:</span>
        <span class="n">cr</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT</span>
<span class="s2">                conname AS &quot;constraint name&quot;,</span>
<span class="s2">                t.relname AS &quot;table name&quot;,</span>
<span class="s2">                ARRAY(</span>
<span class="s2">                    SELECT attname FROM pg_attribute</span>
<span class="s2">                    WHERE attrelid = conrelid</span>
<span class="s2">                      AND attnum = ANY(conkey)</span>
<span class="s2">                ) as &quot;columns&quot;</span>
<span class="s2">            FROM pg_constraint</span>
<span class="s2">            JOIN pg_class t ON t.oid = conrelid</span>
<span class="s2">            WHERE conname = </span><span class="si">%s</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">diag</span><span class="o">.</span><span class="n">constraint_name</span><span class="p">])</span>
        <span class="n">constraint</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">ufields</span> <span class="o">=</span> <span class="n">cr</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1"># if the unique constraint is on an expression or on an other table</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ufields</span> <span class="ow">or</span> <span class="n">model</span><span class="o">.</span><span class="n">_table</span> <span class="o">!=</span> <span class="n">table</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>

    <span class="c1"># TODO: add stuff from e.diag.message_hint? provides details about the constraint &amp; duplication values but may be localized...</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ufields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="n">ufields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;The value for the field &#39;</span><span class="si">%s</span><span class="s2">&#39; already exists (this is probably &#39;</span><span class="si">%s</span><span class="s2">&#39; in the current model).&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;string&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="n">field_strings</span> <span class="o">=</span> <span class="p">[</span><span class="n">fields</span><span class="p">[</span><span class="n">fname</span><span class="p">][</span><span class="s1">&#39;string&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">ufields</span><span class="p">]</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;The values for the fields &#39;</span><span class="si">%s</span><span class="s2">&#39; already exist (they are probably &#39;</span><span class="si">%s</span><span class="s2">&#39; in the current model).&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ufields</span><span class="p">),</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">field_strings</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
        <span class="c1"># no field, unclear which one we should pick and they could be in any order</span>
    <span class="p">}</span>

<span class="n">PGERROR_TO_OE</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
    <span class="c1"># shape of mapped converters</span>
    <span class="k">lambda</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">model</span><span class="p">,</span> <span class="n">fvg</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">pgerror</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">tools</span><span class="o">.</span><span class="n">ustr</span><span class="p">(</span><span class="n">pgerror</span><span class="p">)}),</span> <span class="p">{</span>
    <span class="s1">&#39;23502&#39;</span><span class="p">:</span> <span class="n">convert_pgerror_not_null</span><span class="p">,</span>
    <span class="s1">&#39;23505&#39;</span><span class="p">:</span> <span class="n">convert_pgerror_unique</span><span class="p">,</span>
<span class="p">})</span>

<span class="k">def</span> <span class="nf">_normalize_ids</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">atoms</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">IdType</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot; Normalizes the ids argument for ``browse`` (v7 and v8) to a tuple.</span>

<span class="sd">    Various implementations were tested on the corpus of all browse() calls</span>
<span class="sd">    performed during a full crawler run (after having installed all website_*</span>
<span class="sd">    modules) and this one was the most efficient overall.</span>

<span class="sd">    A possible bit of correctness was sacrificed by not doing any test on</span>
<span class="sd">    Iterable and just assuming that any non-atomic type was an iterable of</span>
<span class="sd">    some kind.</span>

<span class="sd">    :rtype: tuple</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># much of the corpus is falsy objects (empty list, tuple or set, None)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">()</span>

    <span class="c1"># `type in set` is significantly faster (because more restrictive) than</span>
    <span class="c1"># isinstance(arg, set) or issubclass(type, set); and for new-style classes</span>
    <span class="c1"># obj.__class__ is equivalent to but faster than type(obj). Not relevant</span>
    <span class="c1"># (and looks much worse) in most cases, but over millions of calls it</span>
    <span class="c1"># does have a very minor effect.</span>
    <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">arg</span><span class="p">,</span>

    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

<span class="c1"># keep those imports here to avoid dependency cycle errors</span>
<span class="kn">from</span> <span class="nn">.osv</span> <span class="k">import</span> <span class="n">expression</span>
<span class="kn">from</span> <span class="nn">.fields</span> <span class="k">import</span> <span class="n">Field</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Gahan Corporation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>