
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Building Interface Extensions &#8212; gerp v0.0.1 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     'v0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="building-interface-extensions">
<h1>Building Interface Extensions<a class="headerlink" href="#building-interface-extensions" title="Permalink to this headline">¶</a></h1>
<p>This guide is about creating modules for Odoo’s web client.</p>
<p>To create websites with Odoo, see <a class="reference internal" href="website.html"><span class="doc">Building a Website</span></a>; to add business capabilities
or extend existing business systems of Odoo, see <a class="reference internal" href="backend.html"><span class="doc">Building a Module</span></a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>This guide assumes knowledge of:</p>
<ul class="simple">
<li>Javascript basics and good practices</li>
<li><a class="reference external" href="http://jquery.org">jQuery</a></li>
<li><a class="reference external" href="http://underscorejs.org">Underscore.js</a></li>
</ul>
<p class="last">It also requires <a class="reference internal" href="../setup/install.html#setup-install"><span class="std std-ref">an installed Odoo</span></a>, and <a class="reference external" href="http://git-scm.com">Git</a>.</p>
</div>
<div class="section" id="a-simple-module">
<h2>A Simple Module<a class="headerlink" href="#a-simple-module" title="Permalink to this headline">¶</a></h2>
<p>Let’s start with a simple Odoo module holding basic web component
configuration and letting us test the web framework.</p>
<p>The example module is available online and can be downloaded using the
following command:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="gp">$</span> git clone http://github.com/gerp/petstore
</pre></div>
</div>
<p>This will create a <code class="docutils literal"><span class="pre">petstore</span></code> folder wherever you executed the command.
You then need to add that folder to Odoo’s
<a class="reference internal" href="../reference/cmdline.html#cmdoption-gerp-bin-addons-path"><code class="xref std std-option docutils literal"><span class="pre">addons</span> <span class="pre">path</span></code></a>, create a new database and
install the <code class="docutils literal"><span class="pre">oepetstore</span></code> module.</p>
<p>If you browse the <code class="docutils literal"><span class="pre">petstore</span></code> folder, you should see the following content:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>oepetstore
|-- images
|   |-- alligator.jpg
|   |-- ball.jpg
|   |-- crazy_circle.jpg
|   |-- fish.jpg
|   `-- mice.jpg
|-- __init__.py
|-- oepetstore.message_of_the_day.csv
|-- __manifest__.py
|-- petstore_data.xml
|-- petstore.py
|-- petstore.xml
`-- static
    `-- src
        |-- css
        |   `-- petstore.css
        |-- js
        |   `-- petstore.js
        `-- xml
            `-- petstore.xml
</pre></div>
</div>
<p>The module already holds various server customizations. We’ll come back to
these later, for now let’s focus on the web-related content, in the <code class="docutils literal"><span class="pre">static</span></code>
folder.</p>
<p>Files used in the “web” side of an Odoo module must be placed in a <code class="docutils literal"><span class="pre">static</span></code>
folder so they are available to a web browser, files outside that folder can
not be fetched by browsers. The <code class="docutils literal"><span class="pre">src/css</span></code>, <code class="docutils literal"><span class="pre">src/js</span></code> and <code class="docutils literal"><span class="pre">src/xml</span></code>
sub-folders are conventional and not strictly necessary.</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">oepetstore/static/css/petstore.css</span></code></dt>
<dd>Currently empty, will hold the <a class="reference external" href="http://www.w3.org/Style/CSS/Overview.en.html">CSS</a> for pet store content</dd>
<dt><code class="docutils literal"><span class="pre">oepetstore/static/xml/petstore.xml</span></code></dt>
<dd>Mostly empty, will hold <a class="reference internal" href="../reference/qweb.html#reference-qweb"><span class="std std-ref">QWeb</span></a> templates</dd>
<dt><code class="docutils literal"><span class="pre">oepetstore/static/js/petstore.js</span></code></dt>
<dd><p class="first">The most important (and interesting) part, contains the logic of the
application (or at least its web-browser side) as javascript. It should
currently look like:</p>
<div class="last highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">gerp</span><span class="p">.</span><span class="nx">oepetstore</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">local</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_t</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">_t</span><span class="p">,</span>
        <span class="nx">_lt</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">_lt</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">QWeb</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">qweb</span><span class="p">;</span>

    <span class="nx">local</span><span class="p">.</span><span class="nx">HomePage</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
        <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;pet store home page loaded&quot;</span><span class="p">);</span>
        <span class="p">},</span>
    <span class="p">});</span>

    <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">client_actions</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span>
        <span class="s1">&#39;petstore.homepage&#39;</span><span class="p">,</span> <span class="s1">&#39;instance.oepetstore.HomePage&#39;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</dd>
</dl>
<p>Which only prints a small message in the browser’s console.</p>
<p>The files in the <code class="docutils literal"><span class="pre">static</span></code> folder, need to be defined within the module in order for them to be loaded correctly. Everything in <code class="docutils literal"><span class="pre">src/xml</span></code> is defined in <code class="docutils literal"><span class="pre">__manifest__.py</span></code> while the contents of <code class="docutils literal"><span class="pre">src/css</span></code> and <code class="docutils literal"><span class="pre">src/js</span></code> are defined in <code class="docutils literal"><span class="pre">petstore.xml</span></code>, or a similar file.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>All JavaScript files are concatenated and <a class="reference internal" href="../glossary.html#term-minified"><span class="xref std std-term">minified</span></a> to improve
application load time.</p>
<p>One of the drawback is debugging becomes more difficult as
individual files disappear and the code is made significantly less
readable. It is possible to disable this process by enabling the
“developer mode”: log into your Odoo instance (user <em>admin</em> password
<em>admin</em> by default) open the user menu (in the top-right corner of the
Odoo screen) and select <span class="guilabel">About Odoo</span> then <span class="guilabel">Activate
the developer mode</span>:</p>
<img alt="../_images/about_gerp.png" class="align-center" src="../_images/about_gerp.png" />
<img alt="../_images/devmode.png" class="align-center" src="../_images/devmode.png" />
<p class="last">This will reload the web client with optimizations disabled, making
development and debugging significantly more comfortable.</p>
</div>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">qweb files hooked via __manifest__.py, but js and CSS use bundles</p>
</div>
</div>
<div class="section" id="gerp-javascript-module">
<h2>Odoo JavaScript Module<a class="headerlink" href="#gerp-javascript-module" title="Permalink to this headline">¶</a></h2>
<p>Javascript doesn’t have built-in modules. As a result variables defined in
different files are all mashed together and may conflict. This has given rise
to various module patterns used to build clean namespaces and limit risks of
naming conflicts.</p>
<p>The Odoo framework uses one such pattern to define modules within web addons,
in order to both namespace code and correctly order its loading.</p>
<p><code class="docutils literal"><span class="pre">oepetstore/static/js/petstore.js</span></code> contains a module declaration:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">gerp</span><span class="p">.</span><span class="nx">oepetstore</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="nx">local</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">local</span><span class="p">.</span><span class="nx">xxx</span> <span class="o">=</span> <span class="p">...;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In Odoo web, modules are declared as functions set on the global <code class="docutils literal"><span class="pre">gerp</span></code>
variable. The function’s name must be the same as the addon (in this case
<code class="docutils literal"><span class="pre">oepetstore</span></code>) so the framework can find it, and automatically initialize it.</p>
<p>When the web client loads your module it will call the root function
and provide two parameters:</p>
<ul class="simple">
<li>the first parameter is the current instance of the Odoo web client, it gives
access to various capabilities defined by the Odoo (translations,
network services) as well as objects defined by the core or by other
modules.</li>
<li>the second parameter is your own local namespace automatically created by
the web client. Objects and variables which should be accessible from
outside your module (either because the Odoo web client needs to call them
or because others may want to customize them) should be set inside that
namespace.</li>
</ul>
</div>
<div class="section" id="classes">
<h2>Classes<a class="headerlink" href="#classes" title="Permalink to this headline">¶</a></h2>
<p>Much as modules, and contrary to most object-oriented languages, javascript
does not build in <em>classes</em><a class="footnote-reference" href="#id4" id="id1">[1]</a> although it provides roughly
equivalent (if lower-level and more verbose) mechanisms.</p>
<p>For simplicity and developer-friendliness Odoo web provides a class
system based on John Resig’s <a class="reference external" href="http://ejohn.org/blog/simple-javascript-inheritance/">Simple JavaScript Inheritance</a>.</p>
<p>New classes are defined by calling the <code class="xref js js-func docutils literal"><span class="pre">extend()</span></code>
method of <code class="xref js js-class docutils literal"><span class="pre">gerp.web.Class()</span></code>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">MyClass</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">Class</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">say_hello</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">);</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<p>The <code class="xref js js-func docutils literal"><span class="pre">extend()</span></code> method takes a dictionary describing
the new class’s content (methods and static attributes). In this case, it will
only have a <code class="docutils literal"><span class="pre">say_hello</span></code> method which takes no parameters.</p>
<p>Classes are instantiated using the <code class="docutils literal"><span class="pre">new</span></code> operator:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">my_object</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyClass</span><span class="p">();</span>
<span class="nx">my_object</span><span class="p">.</span><span class="nx">say_hello</span><span class="p">();</span>
<span class="c1">// print &quot;hello&quot; in the console</span>
</pre></div>
</div>
<p>And attributes of the instance can be accessed via <code class="docutils literal"><span class="pre">this</span></code>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">MyClass</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">Class</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">say_hello</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">},</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">my_object</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyClass</span><span class="p">();</span>
<span class="nx">my_object</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;Bob&quot;</span><span class="p">;</span>
<span class="nx">my_object</span><span class="p">.</span><span class="nx">say_hello</span><span class="p">();</span>
<span class="c1">// print &quot;hello Bob&quot; in the console</span>
</pre></div>
</div>
<p>Classes can provide an initializer to perform the initial setup of the
instance, by defining an <code class="docutils literal"><span class="pre">init()</span></code> method. The initializer receives the
parameters passed when using the <code class="docutils literal"><span class="pre">new</span></code> operator:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">MyClass</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">Class</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">say_hello</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">},</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">my_object</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyClass</span><span class="p">(</span><span class="s2">&quot;Bob&quot;</span><span class="p">);</span>
<span class="nx">my_object</span><span class="p">.</span><span class="nx">say_hello</span><span class="p">();</span>
<span class="c1">// print &quot;hello Bob&quot; in the console</span>
</pre></div>
</div>
<p>It is also possible to create subclasses from existing (used-defined) classes
by calling <code class="xref js js-func docutils literal"><span class="pre">extend()</span></code> on the parent class, as is done
to subclass <code class="xref js js-class docutils literal"><span class="pre">Class()</span></code>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">MySpanishClass</span> <span class="o">=</span> <span class="nx">MyClass</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">say_hello</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;hola&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">},</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">my_object</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MySpanishClass</span><span class="p">(</span><span class="s2">&quot;Bob&quot;</span><span class="p">);</span>
<span class="nx">my_object</span><span class="p">.</span><span class="nx">say_hello</span><span class="p">();</span>
<span class="c1">// print &quot;hola Bob&quot; in the console</span>
</pre></div>
</div>
<p>When overriding a method using inheritance, you can use <code class="docutils literal"><span class="pre">this._super()</span></code> to
call the original method:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">MySpanishClass</span> <span class="o">=</span> <span class="nx">MyClass</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">say_hello</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">();</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;translation in Spanish: hola&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">},</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">my_object</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MySpanishClass</span><span class="p">(</span><span class="s2">&quot;Bob&quot;</span><span class="p">);</span>
<span class="nx">my_object</span><span class="p">.</span><span class="nx">say_hello</span><span class="p">();</span>
<span class="c1">// print &quot;hello Bob \n translation in Spanish: hola Bob&quot; in the console</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p><code class="docutils literal"><span class="pre">_super</span></code> is not a standard method, it is set on-the-fly to the next
method in the current inheritance chain, if any. It is only defined
during the <em>synchronous</em> part of a method call, for use in asynchronous
handlers (after network calls or in <code class="docutils literal"><span class="pre">setTimeout</span></code> callbacks) a reference
to its value should be retained, it should not be accessed via <code class="docutils literal"><span class="pre">this</span></code>:</p>
<div class="last highlight-javascript"><div class="highlight"><pre><span></span><span class="c1">// broken, will generate an error</span>
<span class="nx">say_hello</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">();</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// correct</span>
<span class="nx">say_hello</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// don&#39;t forget .bind()</span>
    <span class="kd">var</span> <span class="nx">_super</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">_super</span><span class="p">();</span>
    <span class="p">}.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="widgets-basics">
<h2>Widgets Basics<a class="headerlink" href="#widgets-basics" title="Permalink to this headline">¶</a></h2>
<p>The Odoo web client bundles <a class="reference external" href="http://jquery.org">jQuery</a> for easy DOM manipulation. It is useful
and provides a better API than standard <a class="reference external" href="http://www.w3.org/TR/DOM-Level-3-Core/">W3C DOM</a><a class="footnote-reference" href="#dombugs" id="id2">[2]</a>, but
insufficient to structure complex applications leading to difficult
maintenance.</p>
<p>Much like object-oriented desktop UI toolkits (e.g. <a class="reference external" href="http://qt-project.org">Qt</a>, <a class="reference external" href="https://developer.apple.com/technologies/mac/cocoa.html">Cocoa</a> or <a class="reference external" href="http://www.gtk.org">GTK</a>),
Odoo Web makes specific components responsible for sections of a page. In
Odoo web, the base for such components is the <code class="xref js js-class docutils literal"><span class="pre">Widget()</span></code>
class, a component specialized in handling a page section and displaying
information for the user.</p>
<div class="section" id="your-first-widget">
<h3>Your First Widget<a class="headerlink" href="#your-first-widget" title="Permalink to this headline">¶</a></h3>
<p>The initial demonstration module already provides a basic widget:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">HomePage</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;pet store home page loaded&quot;</span><span class="p">);</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<p>It extends <code class="xref js js-class docutils literal"><span class="pre">Widget()</span></code> and overrides the standard method
<code class="xref js js-func docutils literal"><span class="pre">start()</span></code>, which — much like the previous <code class="docutils literal"><span class="pre">MyClass</span></code>
— does little for now.</p>
<p>This line at the end of the file:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">client_actions</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span>
    <span class="s1">&#39;petstore.homepage&#39;</span><span class="p">,</span> <span class="s1">&#39;instance.oepetstore.HomePage&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>registers our basic widget as a client action. Client actions will be
explained later, for now this is just what allows our widget to
be called and displayed when we select the
<span class="menuselection">Pet Store ‣ Pet Store ‣ Home Page</span> menu.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">because the widget will be called from outside our module, the web client
needs its “fully qualified” name, not the local version.</p>
</div>
</div>
<div class="section" id="display-content">
<h3>Display Content<a class="headerlink" href="#display-content" title="Permalink to this headline">¶</a></h3>
<p>Widgets have a number of methods and features, but the basics are simple:</p>
<ul class="simple">
<li>set up a widget</li>
<li>format the widget’s data</li>
<li>display the widget</li>
</ul>
<p>The <code class="docutils literal"><span class="pre">HomePage</span></code> widget already has a <code class="xref js js-func docutils literal"><span class="pre">start()</span></code>
method. That method is part of the normal widget lifecycle and automatically
called once the widget is inserted in the page. We can use it to display some
content.</p>
<p>All widgets have a <code class="xref js js-attr docutils literal"><span class="pre">$el</span></code> which represents the
section of page they’re in charge of (as a <a class="reference external" href="http://jquery.org">jQuery</a> object). Widget content
should be inserted there. By default, <code class="xref js js-attr docutils literal"><span class="pre">$el</span></code> is an
empty <code class="docutils literal"><span class="pre">&lt;div&gt;</span></code> element.</p>
<p>A <code class="docutils literal"><span class="pre">&lt;div&gt;</span></code> element is usually invisible to the user if it has no content (or
without specific styles giving it a size) which is why nothing is displayed
on the page when <code class="docutils literal"><span class="pre">HomePage</span></code> is launched.</p>
<p>Let’s add some content to the widget’s root element, using jQuery:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">HomePage</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;Hello dear Odoo user!&lt;/div&gt;&quot;</span><span class="p">);</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<p>That message will now appear when you open <span class="menuselection">Pet Store
‣ Pet Store ‣ Home Page</span></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">to refresh the javascript code loaded in Odoo Web, you will need to reload
the page. There is no need to restart the Odoo server.</p>
</div>
<p>The <code class="docutils literal"><span class="pre">HomePage</span></code> widget is used by Odoo Web and managed automatically.
To learn how to use a widget “from scratch” let’s create a new one:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">GreetingsWidget</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;We are so happy to see you again in this menu!&lt;/div&gt;&quot;</span><span class="p">);</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<p>We can now add our <code class="docutils literal"><span class="pre">GreetingsWidget</span></code> to the <code class="docutils literal"><span class="pre">HomePage</span></code> by using the
<code class="docutils literal"><span class="pre">GreetingsWidget</span></code>’s <code class="xref js js-func docutils literal"><span class="pre">appendTo()</span></code> method:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">HomePage</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;Hello dear Odoo user!&lt;/div&gt;&quot;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">greeting</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">local</span><span class="p">.</span><span class="nx">GreetingsWidget</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">greeting</span><span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">);</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">HomePage</span></code> first adds its own content to its DOM root</li>
<li><code class="docutils literal"><span class="pre">HomePage</span></code> then instantiates <code class="docutils literal"><span class="pre">GreetingsWidget</span></code></li>
<li>Finally it tells <code class="docutils literal"><span class="pre">GreetingsWidget</span></code> where to insert itself, delegating part
of its <code class="xref js js-attr docutils literal"><span class="pre">$el</span></code> to the <code class="docutils literal"><span class="pre">GreetingsWidget</span></code>.</li>
</ul>
<p>When the <code class="xref js js-func docutils literal"><span class="pre">appendTo()</span></code> method is called, it asks the
widget to insert itself at the specified position and to display its content.
The <code class="xref js js-func docutils literal"><span class="pre">start()</span></code> method will be called during the call
to <code class="xref js js-func docutils literal"><span class="pre">appendTo()</span></code>.</p>
<p>To see what happens under the displayed interface, we will use the browser’s
DOM Explorer. But first let’s alter our widgets slightly so we can more easily
find where they are, by <code class="xref js js-attr docutils literal"><span class="pre">adding</span> <span class="pre">a</span> <span class="pre">class</span> <span class="pre">to</span> <span class="pre">their</span> <span class="pre">root</span> <span class="pre">elements</span></code>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">HomePage</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">className</span><span class="o">:</span> <span class="s1">&#39;oe_petstore_homepage&#39;</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">});</span>
<span class="nx">local</span><span class="p">.</span><span class="nx">GreetingsWidget</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">className</span><span class="o">:</span> <span class="s1">&#39;oe_petstore_greetings&#39;</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">});</span>
</pre></div>
</div>
<p>If you can find the relevant section of the DOM (right-click on the text
then <span class="guilabel">Inspect Element</span>), it should look like this:</p>
<div class="highlight-html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;oe_petstore_homepage&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>Hello dear Odoo user!<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;oe_petstore_greetings&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>We are so happy to see you again in this menu!<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>Which clearly shows the two <code class="docutils literal"><span class="pre">&lt;div&gt;</span></code> elements automatically created by
<code class="xref js js-class docutils literal"><span class="pre">Widget()</span></code>, because we added some classes on them.</p>
<p>We can also see the two message-holding divs we added ourselves</p>
<p>Finally, note the <code class="docutils literal"><span class="pre">&lt;div</span> <span class="pre">class=&quot;oe_petstore_greetings&quot;&gt;</span></code> element which
represents the <code class="docutils literal"><span class="pre">GreetingsWidget</span></code> instance is <em>inside</em> the
<code class="docutils literal"><span class="pre">&lt;div</span> <span class="pre">class=&quot;oe_petstore_homepage&quot;&gt;</span></code> which represents the <code class="docutils literal"><span class="pre">HomePage</span></code>
instance, since we appended</p>
</div>
<div class="section" id="widget-parents-and-children">
<h3>Widget Parents and Children<a class="headerlink" href="#widget-parents-and-children" title="Permalink to this headline">¶</a></h3>
<p>In the previous part, we instantiated a widget using this syntax:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="k">new</span> <span class="nx">local</span><span class="p">.</span><span class="nx">GreetingsWidget</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</pre></div>
</div>
<p>The first argument is <code class="docutils literal"><span class="pre">this</span></code>, which in that case was a <code class="docutils literal"><span class="pre">HomePage</span></code>
instance. This tells the widget being created which other widget is its
<em>parent</em>.</p>
<p>As we’ve seen, widgets are usually inserted in the DOM by another widget and
<em>inside</em> that other widget’s root element. This means most widgets are “part”
of another widget, and exist on behalf of it. We call the container the
<em>parent</em>, and the contained widget the <em>child</em>.</p>
<p>Due to multiple technical and conceptual reasons, it is necessary for a widget
to know who is its parent and who are its children.</p>
<dl class="docutils">
<dt><code class="xref js js-func docutils literal"><span class="pre">getParent()</span></code></dt>
<dd><p class="first">can be used to get the parent of a widget:</p>
<div class="last highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">GreetingsWidget</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getParent</span><span class="p">().</span><span class="nx">$el</span> <span class="p">);</span>
        <span class="c1">// will print &quot;div.oe_petstore_homepage&quot; in the console</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
</dd>
<dt><code class="xref js js-func docutils literal"><span class="pre">getChildren()</span></code></dt>
<dd><p class="first">can be used to get a list of its children:</p>
<div class="last highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">HomePage</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">greeting</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">local</span><span class="p">.</span><span class="nx">GreetingsWidget</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="nx">greeting</span><span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getChildren</span><span class="p">()[</span><span class="mi">0</span><span class="p">].</span><span class="nx">$el</span><span class="p">);</span>
        <span class="c1">// will print &quot;div.oe_petstore_greetings&quot; in the console</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
</dd>
</dl>
<p>When overriding the <code class="xref js js-func docutils literal"><span class="pre">init()</span></code> method of a widget it is
<em>of the utmost importance</em> to pass the parent to the <code class="docutils literal"><span class="pre">this._super()</span></code> call,
otherwise the relation will not be set up correctly:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">GreetingsWidget</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">(</span><span class="nx">parent</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Finally, if a widget does not have a parent (e.g. because it’s the root
widget of the application), <code class="docutils literal"><span class="pre">null</span></code> can be provided as parent:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="k">new</span> <span class="nx">local</span><span class="p">.</span><span class="nx">GreetingsWidget</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="destroying-widgets">
<h3>Destroying Widgets<a class="headerlink" href="#destroying-widgets" title="Permalink to this headline">¶</a></h3>
<p>If you can display content to your users, you should also be able to erase
it. This is done via the <code class="xref js js-func docutils literal"><span class="pre">destroy()</span></code> method:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">greeting</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
</pre></div>
</div>
<p>When a widget is destroyed it will first call
<code class="xref js js-func docutils literal"><span class="pre">destroy()</span></code> on all its children. Then it erases itself
from the DOM. If you have set up permanent structures in
<code class="xref js js-func docutils literal"><span class="pre">init()</span></code> or <code class="xref js js-func docutils literal"><span class="pre">start()</span></code> which
must be explicitly cleaned up (because the garbage collector will not handle
them), you can override <code class="xref js js-func docutils literal"><span class="pre">destroy()</span></code>.</p>
<div class="admonition danger">
<p class="first admonition-title">Danger</p>
<p class="last">when overriding <code class="xref js js-func docutils literal"><span class="pre">destroy()</span></code>, <code class="docutils literal"><span class="pre">_super()</span></code>
<em>must always</em> be called otherwise the widget and its children are not
correctly cleaned up leaving possible memory leaks and “phantom events”,
even if no error is displayed</p>
</div>
</div>
</div>
<div class="section" id="the-qweb-template-engine">
<h2>The QWeb Template Engine<a class="headerlink" href="#the-qweb-template-engine" title="Permalink to this headline">¶</a></h2>
<p>In the previous section we added content to our widgets by directly
manipulating (and adding to) their DOM:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;Hello dear Odoo user!&lt;/div&gt;&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>This allows generating and displaying any type of content, but gets unwieldy
when generating significant amounts of DOM (lots of duplication, quoting
issues, …)</p>
<p>As many other environments, Odoo’s solution is to use a <a class="reference external" href="http://en.wikipedia.org/wiki/Web_template_system">template engine</a>.
Odoo’s template engine is called <a class="reference internal" href="../reference/qweb.html#reference-qweb"><span class="std std-ref">QWeb</span></a>.</p>
<p>QWeb is an XML-based templating language, similar to <a class="reference external" href="http://en.wikipedia.org/wiki/Genshi_(templating_language)">Genshi</a>, <a class="reference external" href="http://en.wikipedia.org/wiki/Thymeleaf">Thymeleaf</a> or <a class="reference external" href="http://en.wikipedia.org/wiki/Facelets">Facelets</a>. It has the following
characteristics:</p>
<ul class="simple">
<li>It’s implemented fully in JavaScript and rendered in the browser</li>
<li>Each template file (XML files) contains multiple templates</li>
<li>It has special support in Odoo Web’s <code class="xref js js-class docutils literal"><span class="pre">Widget()</span></code>, though it
can be used outside of Odoo’s web client (and it’s possible to use
<code class="xref js js-class docutils literal"><span class="pre">Widget()</span></code> without relying on QWeb)</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The rationale behind using QWeb instead of existing javascript template
engines is the extensibility of pre-existing (third-party) templates, much
like Odoo <a class="reference internal" href="../reference/views.html#reference-views"><span class="std std-ref">views</span></a>.</p>
<p class="last">Most javascript template engines are text-based which precludes easy
structural extensibility where an XML-based templating engine can be
generically altered using e.g. XPath or CSS and a tree-alteration DSL (or
even just XSLT). This flexibility and extensibility is a core
characteristic of Odoo, and losing it was considered unacceptable.</p>
</div>
<div class="section" id="using-qweb">
<h3>Using QWeb<a class="headerlink" href="#using-qweb" title="Permalink to this headline">¶</a></h3>
<p>First let’s define a simple QWeb template in the almost-empty
<code class="docutils literal"><span class="pre">oepetstore/static/src/xml/petstore.xml</span></code> file:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;templates</span> <span class="na">xml:space=</span><span class="s">&quot;preserve&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;t</span> <span class="na">t-name=</span><span class="s">&quot;HomePageTemplate&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;background-color: red;&quot;</span><span class="nt">&gt;</span>This is some simple HTML<span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/t&gt;</span>
<span class="nt">&lt;/templates&gt;</span>
</pre></div>
</div>
<p>Now we can use this template inside of the <code class="docutils literal"><span class="pre">HomePage</span></code> widget. Using the
<code class="docutils literal"><span class="pre">QWeb</span></code> loader variable defined at the top of the page, we can call to the
template defined in the XML file:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">HomePage</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">QWeb</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s2">&quot;HomePageTemplate&quot;</span><span class="p">));</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<p><code class="xref js js-func docutils literal"><span class="pre">QWeb.render()</span></code> looks for the specified template, renders it to a string
and returns the result.</p>
<p>However, because <code class="xref js js-class docutils literal"><span class="pre">Widget()</span></code> has special integration for QWeb
the template can be set directly on the widget via its
<code class="xref js js-attr docutils literal"><span class="pre">template</span></code> attribute:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">HomePage</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">template</span><span class="o">:</span> <span class="s2">&quot;HomePageTemplate&quot;</span><span class="p">,</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Although the result looks similar, there are two differences between these
usages:</p>
<ul class="simple">
<li>with the second version, the template is rendered right before
<code class="xref js js-func docutils literal"><span class="pre">start()</span></code> is called</li>
<li>in the first version the template’s content is added to the widget’s root
element, whereas in the second version the template’s root element is
directly <em>set as</em> the widget’s root element. Which is why the “greetings”
sub-widget also gets a red background</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">templates should have a single non-<code class="docutils literal"><span class="pre">t</span></code> root element, especially if
they’re set as a widget’s <code class="xref js js-attr docutils literal"><span class="pre">template</span></code>. If there are
multiple “root elements”, results are undefined (usually only the first
root element will be used and the others will be ignored)</p>
</div>
<div class="section" id="qweb-context">
<h4>QWeb Context<a class="headerlink" href="#qweb-context" title="Permalink to this headline">¶</a></h4>
<p>QWeb templates can be given data and can contain basic display logic.</p>
<p>For explicit calls to <code class="xref js js-func docutils literal"><span class="pre">QWeb.render()</span></code>, the template data is passed as
second parameter:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">QWeb</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s2">&quot;HomePageTemplate&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Klaus&quot;</span><span class="p">});</span>
</pre></div>
</div>
<p>with the template modified to:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;t</span> <span class="na">t-name=</span><span class="s">&quot;HomePageTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div&gt;</span>Hello <span class="nt">&lt;t</span> <span class="na">t-esc=</span><span class="s">&quot;name&quot;</span><span class="nt">/&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/t&gt;</span>
</pre></div>
</div>
<p>will result in:</p>
<div class="highlight-html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>Hello Klaus<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>When using <code class="xref js js-class docutils literal"><span class="pre">Widget()</span></code>’s integration it is not possible to
provide additional data to the template. The template will be given a single
<code class="docutils literal"><span class="pre">widget</span></code> context variable, referencing the widget being rendered right
before <code class="xref js js-func docutils literal"><span class="pre">start()</span></code> is called (the widget’s state will
essentially be that set up by <code class="xref js js-func docutils literal"><span class="pre">init()</span></code>):</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;t</span> <span class="na">t-name=</span><span class="s">&quot;HomePageTemplate&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div&gt;</span>Hello <span class="nt">&lt;t</span> <span class="na">t-esc=</span><span class="s">&quot;widget.name&quot;</span><span class="nt">/&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/t&gt;</span>
</pre></div>
</div>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">HomePage</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">template</span><span class="o">:</span> <span class="s2">&quot;HomePageTemplate&quot;</span><span class="p">,</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">(</span><span class="nx">parent</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;Mordecai&quot;</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Result:</p>
<div class="highlight-html"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>Hello Mordecai<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="template-declaration">
<h4>Template Declaration<a class="headerlink" href="#template-declaration" title="Permalink to this headline">¶</a></h4>
<p>We’ve seen how to <em>render</em> QWeb templates, let’s now see the syntax of
the templates themselves.</p>
<p>A QWeb template is composed of regular XML mixed with QWeb <em>directives</em>. A
QWeb directive is declared with XML attributes starting with <code class="docutils literal"><span class="pre">t-</span></code>.</p>
<p>The most basic directive is <code class="docutils literal"><span class="pre">t-name</span></code>, used to declare new templates in
a template file:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;templates&gt;</span>
    <span class="nt">&lt;t</span> <span class="na">t-name=</span><span class="s">&quot;HomePageTemplate&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div&gt;</span>This is some simple HTML<span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/t&gt;</span>
<span class="nt">&lt;/templates&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">t-name</span></code> takes the name of the template being defined, and declares that
it can be called using <code class="xref js js-func docutils literal"><span class="pre">QWeb.render()</span></code>. It can only be used at the
top-level of a template file.</p>
</div>
<div class="section" id="escaping">
<h4>Escaping<a class="headerlink" href="#escaping" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal"><span class="pre">t-esc</span></code> directive can be used to output text:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;div&gt;</span>Hello <span class="nt">&lt;t</span> <span class="na">t-esc=</span><span class="s">&quot;name&quot;</span><span class="nt">/&gt;&lt;/div&gt;</span>
</pre></div>
</div>
<p>It takes a Javascript expression which is evaluated, the result of the
expression is then HTML-escaped and inserted in the document. Since it’s an
expression it’s possible to provide just a variable name as above, or a more
complex expression like a computation:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;div&gt;&lt;t</span> <span class="na">t-esc=</span><span class="s">&quot;3+5&quot;</span><span class="nt">/&gt;&lt;/div&gt;</span>
</pre></div>
</div>
<p>or method calls:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;div&gt;&lt;t</span> <span class="na">t-esc=</span><span class="s">&quot;name.toUpperCase()&quot;</span><span class="nt">/&gt;&lt;/div&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="outputting-html">
<h4>Outputting HTML<a class="headerlink" href="#outputting-html" title="Permalink to this headline">¶</a></h4>
<p>To inject HTML in the page being rendered, use <code class="docutils literal"><span class="pre">t-raw</span></code>. Like <code class="docutils literal"><span class="pre">t-esc</span></code> it
takes an arbitrary Javascript expression as parameter, but it does not
perform an HTML-escape step.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;div&gt;&lt;t</span> <span class="na">t-raw=</span><span class="s">&quot;name.link(user_account)&quot;</span><span class="nt">/&gt;&lt;/div&gt;</span>
</pre></div>
</div>
<div class="admonition danger">
<p class="first admonition-title">Danger</p>
<p class="last"><code class="docutils literal"><span class="pre">t-raw</span></code> <em>must not</em> be used on any data which may contain non-escaped
user-provided content as this leads to <a class="reference external" href="http://en.wikipedia.org/wiki/Cross-site_scripting">cross-site scripting</a>
vulnerabilities</p>
</div>
</div>
<div class="section" id="conditionals">
<h4>Conditionals<a class="headerlink" href="#conditionals" title="Permalink to this headline">¶</a></h4>
<p>QWeb can have conditional blocks using <code class="docutils literal"><span class="pre">t-if</span></code>. The directive takes an
arbitrary expression, if the expression is falsy (<code class="docutils literal"><span class="pre">false</span></code>, <code class="docutils literal"><span class="pre">null</span></code>, <code class="docutils literal"><span class="pre">0</span></code>
or an empty string) the whole block is suppressed, otherwise it is displayed.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;t</span> <span class="na">t-if=</span><span class="s">&quot;true == true&quot;</span><span class="nt">&gt;</span>
        true is true
    <span class="nt">&lt;/t&gt;</span>
    <span class="nt">&lt;t</span> <span class="na">t-if=</span><span class="s">&quot;true == false&quot;</span><span class="nt">&gt;</span>
        true is not true
    <span class="nt">&lt;/t&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">QWeb doesn’t have an “else” structure, use a second <code class="docutils literal"><span class="pre">t-if</span></code> with the
original condition inverted. You may want to store the condition in a
local variable if it’s a complex or expensive expression.</p>
</div>
</div>
<div class="section" id="iteration">
<h4>Iteration<a class="headerlink" href="#iteration" title="Permalink to this headline">¶</a></h4>
<p>To iterate on a list, use <code class="docutils literal"><span class="pre">t-foreach</span></code> and <code class="docutils literal"><span class="pre">t-as</span></code>. <code class="docutils literal"><span class="pre">t-foreach</span></code> takes an
expression returning a list to iterate on <code class="docutils literal"><span class="pre">t-as</span></code> takes a variable name to
bind to each item during iteration.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;t</span> <span class="na">t-foreach=</span><span class="s">&quot;names&quot;</span> <span class="na">t-as=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div&gt;</span>
            Hello <span class="nt">&lt;t</span> <span class="na">t-esc=</span><span class="s">&quot;name&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/t&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">t-foreach</span></code> can also be used with numbers and objects
(dictionaries)</p>
</div>
</div>
<div class="section" id="defining-attributes">
<h4>Defining attributes<a class="headerlink" href="#defining-attributes" title="Permalink to this headline">¶</a></h4>
<p>QWeb provides two related directives to define computed attributes:
<code class="samp docutils literal"><span class="pre">t-att-</span><em><span class="pre">name</span></em></code> and <code class="samp docutils literal"><span class="pre">t-attf-</span><em><span class="pre">name</span></em></code>. In either case, <em>name</em> is the
name of the attribute to create (e.g. <code class="docutils literal"><span class="pre">t-att-id</span></code> defines the attribute
<code class="docutils literal"><span class="pre">id</span></code> after rendering).</p>
<p><code class="docutils literal"><span class="pre">t-att-</span></code> takes a javascript expression whose result is set as the
attribute’s value, it is most useful if all of the attribute’s value is
computed:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;div&gt;</span>
    Input your name:
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">t-att-value=</span><span class="s">&quot;defaultName&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">t-attf-</span></code> takes a <em>format string</em>. A format string is literal text with
interpolation blocks inside, an interpolation block is a javascript
expression between <code class="docutils literal"><span class="pre">{{</span></code> and <code class="docutils literal"><span class="pre">}}</span></code>, which will be replaced by the result
of the expression. It is most useful for attributes which are partially
literal and partially computed such as a class:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;div</span> <span class="na">t-attf-class=</span><span class="s">&quot;container {{ left ? &#39;text-left&#39; : &#39;&#39; }} {{ extra_class }}&quot;</span><span class="nt">&gt;</span>
    insert content here
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="calling-other-templates">
<h4>Calling other templates<a class="headerlink" href="#calling-other-templates" title="Permalink to this headline">¶</a></h4>
<p>Templates can be split into sub-templates (for simplicity, maintainability,
reusability or to avoid excessive markup nesting).</p>
<p>This is done using the <code class="docutils literal"><span class="pre">t-call</span></code> directive, which takes the name of the
template to render:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;t</span> <span class="na">t-name=</span><span class="s">&quot;A&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;i-am-a&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;t</span> <span class="na">t-call=</span><span class="s">&quot;B&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/t&gt;</span>
<span class="nt">&lt;t</span> <span class="na">t-name=</span><span class="s">&quot;B&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;i-am-b&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/t&gt;</span>
</pre></div>
</div>
<p>rendering the <code class="docutils literal"><span class="pre">A</span></code> template will result in:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;i-am-a&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;i-am-b&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p>Sub-templates inherit the rendering context of their caller.</p>
</div>
<div class="section" id="to-learn-more-about-qweb">
<h4>To Learn More About QWeb<a class="headerlink" href="#to-learn-more-about-qweb" title="Permalink to this headline">¶</a></h4>
<p>For a QWeb reference, see <a class="reference internal" href="../reference/qweb.html#reference-qweb"><span class="std std-ref">QWeb</span></a>.</p>
</div>
<div class="section" id="exercise">
<h4>Exercise<a class="headerlink" href="#exercise" title="Permalink to this headline">¶</a></h4>
</div>
</div>
</div>
<div class="section" id="widget-helpers">
<h2>Widget Helpers<a class="headerlink" href="#widget-helpers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="widget-s-jquery-selector">
<h3><code class="docutils literal"><span class="pre">Widget</span></code>’s jQuery Selector<a class="headerlink" href="#widget-s-jquery-selector" title="Permalink to this headline">¶</a></h3>
<p>Selecting DOM elements within a widget can be performed by calling the
<code class="docutils literal"><span class="pre">find()</span></code> method on the widget’s DOM root:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;input.my_input&quot;</span><span class="p">)...</span>
</pre></div>
</div>
<p>But because it’s a common operation, <code class="xref js js-class docutils literal"><span class="pre">Widget()</span></code> provides an
equivalent shortcut through the <code class="xref js js-func docutils literal"><span class="pre">$()</span></code> method:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">MyWidget</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;input.my_input&quot;</span><span class="p">)...</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The global jQuery function <code class="docutils literal"><span class="pre">$()</span></code> should <em>never</em> be used unless it is
absolutely necessary: selection on a widget’s root are scoped to the
widget and local to it, but selections with <code class="docutils literal"><span class="pre">$()</span></code> are global to the
page/application and may match parts of other widgets and views, leading
to odd or dangerous side-effects. Since a widget should generally act
only on the DOM section it owns, there is no cause for global selection.</p>
</div>
</div>
<div class="section" id="easier-dom-events-binding">
<h3>Easier DOM Events Binding<a class="headerlink" href="#easier-dom-events-binding" title="Permalink to this headline">¶</a></h3>
<p>We have previously bound DOM events using normal jQuery event handlers (e.g.
<code class="docutils literal"><span class="pre">.click()</span></code> or <code class="docutils literal"><span class="pre">.change()</span></code>) on widget elements:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">MyWidget</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.my_button&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">button_clicked</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">button_clicked</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="p">..</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<p>While this works it has a few issues:</p>
<ol class="arabic simple">
<li>it is rather verbose</li>
<li>it does not support replacing the widget’s root element at runtime as
the binding is only performed when <code class="docutils literal"><span class="pre">start()</span></code> is run (during widget
initialization)</li>
<li>it requires dealing with <code class="docutils literal"><span class="pre">this</span></code>-binding issues</li>
</ol>
<p>Widgets thus provide a shortcut to DOM event binding via
<code class="xref js js-attr docutils literal"><span class="pre">events</span></code>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">MyWidget</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;click .my_button&quot;</span><span class="o">:</span> <span class="s2">&quot;button_clicked&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nx">button_clicked</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="p">..</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<p><code class="xref js js-attr docutils literal"><span class="pre">events</span></code> is an object (mapping) of an event to the
function or method to call when the event is triggered:</p>
<ul>
<li><p class="first">the key is an event name, possibly refined with a CSS selector in which
case only if the event happens on a selected sub-element will the function
or method run: <code class="docutils literal"><span class="pre">click</span></code> will handle all clicks within the widget, but
<code class="docutils literal"><span class="pre">click</span> <span class="pre">.my_button</span></code> will only handle clicks in elements bearing the
<code class="docutils literal"><span class="pre">my_button</span></code> class</p>
</li>
<li><p class="first">the value is the action to perform when the event is triggered</p>
<p>It can be either a function:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;click&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* code here */</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>or the name of a method on the object (see example above).</p>
<p>In either case, the <code class="docutils literal"><span class="pre">this</span></code> is the widget instance and the handler is given
a single parameter, the <a class="reference external" href="http://api.jquery.com/category/events/event-object/">jQuery event object</a> for the event.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="widget-events-and-properties">
<h2>Widget Events and Properties<a class="headerlink" href="#widget-events-and-properties" title="Permalink to this headline">¶</a></h2>
<div class="section" id="events">
<h3>Events<a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h3>
<p>Widgets provide an event system (separate from the DOM/jQuery event system
described above): a widget can fire events on itself, and other widgets (or
itself) can bind themselves and listen for these events:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">ConfirmWidget</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">events</span><span class="o">:</span> <span class="p">{</span>
        <span class="s1">&#39;click button.ok_button&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;user_chose&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="s1">&#39;click button.cancel_button&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;user_chose&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;Are you sure you want to perform this action?&lt;/div&gt;&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;&lt;button class=&#39;ok_button&#39;&gt;Ok&lt;/button&gt;&quot;</span> <span class="o">+</span>
            <span class="s2">&quot;&lt;button class=&#39;cancel_button&#39;&gt;Cancel&lt;/button&gt;&quot;</span><span class="p">);</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<p>This widget acts as a facade, transforming user input (through DOM events)
into a documentable internal event to which parent widgets can bind
themselves.</p>
<p><code class="xref js js-func docutils literal"><span class="pre">trigger()</span></code> takes the name of the event to trigger as
its first (mandatory) argument, any further arguments are treated as event
data and passed directly to listeners.</p>
<p>We can then set up a parent event instantiating our generic widget and
listening to the <code class="docutils literal"><span class="pre">user_chose</span></code> event using <code class="xref js js-func docutils literal"><span class="pre">on()</span></code>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">HomePage</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">widget</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">local</span><span class="p">.</span><span class="nx">ConfirmWidget</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="nx">widget</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;user_chose&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">user_chose</span><span class="p">);</span>
        <span class="nx">widget</span><span class="p">.</span><span class="nx">appendTo</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">user_chose</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">confirm</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">confirm</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The user agreed to continue&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The user refused to continue&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<p><code class="xref js js-func docutils literal"><span class="pre">on()</span></code> binds a function to be called when the
event identified by <code class="docutils literal"><span class="pre">event_name</span></code> is. The <code class="docutils literal"><span class="pre">func</span></code> argument is the
function to call and <code class="docutils literal"><span class="pre">object</span></code> is the object to which that function is
related if it is a method. The bound function will be called with the
additional arguments of <code class="xref js js-func docutils literal"><span class="pre">trigger()</span></code> if it has
any. Example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">widget</span> <span class="o">=</span> <span class="p">...</span>
    <span class="nx">widget</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;my_event&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">my_event_triggered</span><span class="p">);</span>
    <span class="nx">widget</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s2">&quot;my_event&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
<span class="p">},</span>
<span class="nx">my_event_triggered</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">);</span>
    <span class="c1">// will print &quot;1 2 3&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Triggering events on an other widget is generally a bad idea. The main
exception to that rule is <code class="docutils literal"><span class="pre">gerp.web.bus</span></code> which exists specifically
to broadcasts evens in which any widget could be interested throughout
the Odoo web application.</p>
</div>
</div>
<div class="section" id="properties">
<h3>Properties<a class="headerlink" href="#properties" title="Permalink to this headline">¶</a></h3>
<p>Properties are very similar to normal object attributes in that they allow
storing data on a widget instance, however they have the additional feature
that they trigger events when set:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">widget</span> <span class="o">=</span> <span class="p">...</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:name&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">name_changed</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;Nicolas&quot;</span><span class="p">);</span>
<span class="p">},</span>
<span class="nx">name_changed</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The new value of the property &#39;name&#39; is&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">widget</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="xref js js-func docutils literal"><span class="pre">set()</span></code> sets the value of a property and triggers
<code class="samp docutils literal"><span class="pre">change:</span><em><span class="pre">propname</span></em></code> (where <em>propname</em> is the property name passed as
first parameter to <code class="xref js js-func docutils literal"><span class="pre">set()</span></code>) and <code class="docutils literal"><span class="pre">change</span></code></li>
<li><code class="xref js js-func docutils literal"><span class="pre">get()</span></code> retrieves the value of a property.</li>
</ul>
</div>
<div class="section" id="id3">
<h3>Exercise<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="modify-existing-widgets-and-classes">
<h2>Modify existing widgets and classes<a class="headerlink" href="#modify-existing-widgets-and-classes" title="Permalink to this headline">¶</a></h2>
<p>The class system of the Odoo web framework allows direct modification of
existing classes using the <code class="xref js js-func docutils literal"><span class="pre">include()</span></code> method:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">TestClass</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">Class</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">testMethod</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">&quot;hello&quot;</span><span class="p">;</span>
    <span class="p">},</span>
<span class="p">});</span>

<span class="nx">TestClass</span><span class="p">.</span><span class="nx">include</span><span class="p">({</span>
    <span class="nx">testMethod</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot; world&quot;</span><span class="p">;</span>
    <span class="p">},</span>
<span class="p">});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">new</span> <span class="nx">TestClass</span><span class="p">().</span><span class="nx">testMethod</span><span class="p">());</span>
<span class="c1">// will print &quot;hello world&quot;</span>
</pre></div>
</div>
<p>This system is similar to the inheritance mechanism, except it will alter the
target class in-place instead of creating a new class.</p>
<p>In that case, <code class="docutils literal"><span class="pre">this._super()</span></code> will call the original implementation of a
method being replaced/redefined. If the class already had sub-classes, all
calls to <code class="docutils literal"><span class="pre">this._super()</span></code> in sub-classes will call the new implementations
defined in the call to <code class="xref js js-func docutils literal"><span class="pre">include()</span></code>. This will also work
if some instances of the class (or of any of its sub-classes) were created
prior to the call to <code class="xref js js-func docutils literal"><span class="pre">include()</span></code>.</p>
</div>
<div class="section" id="translations">
<h2>Translations<a class="headerlink" href="#translations" title="Permalink to this headline">¶</a></h2>
<p>The process to translate text in Python and JavaScript code is very
similar. You could have noticed these lines at the beginning of the
<code class="docutils literal"><span class="pre">petstore.js</span></code> file:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">_t</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">_t</span><span class="p">,</span>
    <span class="nx">_lt</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">_lt</span><span class="p">;</span>
</pre></div>
</div>
<p>These lines are simply used to import the translation functions in the current
JavaScript module. They are used thus:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">_t</span><span class="p">(</span><span class="s2">&quot;Hello user!&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>In Odoo, translations files are automatically generated by scanning the source
code. All piece of code that calls a certain function are detected and their
content is added to a translation file that will then be sent to the
translators. In Python, the function is <code class="docutils literal"><span class="pre">_()</span></code>. In JavaScript the function is
<code class="xref js js-func docutils literal"><span class="pre">_t()</span></code> (and also <code class="xref js js-func docutils literal"><span class="pre">_lt()</span></code>).</p>
<p><code class="docutils literal"><span class="pre">_t()</span></code> will return the translation defined for the text it is given. If no
translation is defined for that text, it will return the original text as-is.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>To inject user-provided values in translatable strings, it is recommended
to use <a class="reference external" href="http://gabceb.github.io/underscore.string.site/#sprintf">_.str.sprintf</a> with named
arguments <em>after</em> the translation:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">str</span><span class="p">.</span><span class="nx">sprintf</span><span class="p">(</span>
    <span class="nx">_t</span><span class="p">(</span><span class="s2">&quot;Hello, %(user)s!&quot;</span><span class="p">),</span> <span class="p">{</span>
    <span class="nx">user</span><span class="o">:</span> <span class="s2">&quot;Ed&quot;</span>
<span class="p">}));</span>
</pre></div>
</div>
<p class="last">This makes translatable strings more readable to translators, and gives
them more flexibility to reorder or ignore parameters.</p>
</div>
<p><code class="xref js js-func docutils literal"><span class="pre">_lt()</span></code> (“lazy translate”) is similar but somewhat more
complex: instead of translating its parameter immediately, it returns
an object which, when converted to a string, will perform the translation.</p>
<p>It is used to define translatable terms before the translations system is
initialized, for class attributes for instance (as modules are loaded before
the user’s language is configured and translations are downloaded).</p>
</div>
<div class="section" id="communication-with-the-gerp-server">
<h2>Communication with the Odoo Server<a class="headerlink" href="#communication-with-the-gerp-server" title="Permalink to this headline">¶</a></h2>
<div class="section" id="contacting-models">
<h3>Contacting Models<a class="headerlink" href="#contacting-models" title="Permalink to this headline">¶</a></h3>
<p>Most operations with Odoo involve communicating with <em>models</em> implementing
business concern, these models will then (potentially) interact with some
storage engine (usually <a class="reference external" href="http://en.wikipedia.org/wiki/PostgreSQL">PostgreSQL</a>).</p>
<p>Although <a class="reference external" href="http://jquery.org">jQuery</a> provides a <a class="reference external" href="http://api.jquery.com/jquery.ajax/">$.ajax</a> function for network interactions,
communicating with Odoo requires additional metadata whose setup before every
call would be verbose and error-prone. As a result, Odoo web provides
higher-level communication primitives.</p>
<p>To demonstrate this, the file <code class="docutils literal"><span class="pre">petstore.py</span></code> already contains a small model
with a sample method:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">message_of_the_day</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">_name</span> <span class="o">=</span> <span class="s2">&quot;oepetstore.message_of_the_day&quot;</span>

    <span class="nd">@api.model</span>
    <span class="k">def</span> <span class="nf">my_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;hello&quot;</span><span class="p">:</span> <span class="s2">&quot;world&quot;</span><span class="p">}</span>

    <span class="n">message</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Text</span><span class="p">(),</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">Char</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
</pre></div>
</div>
<p>This declares a model with two fields, and a method <code class="docutils literal"><span class="pre">my_method()</span></code> which
returns a literal dictionary.</p>
<p>Here is a sample widget that calls <code class="docutils literal"><span class="pre">my_method()</span></code> and displays the result:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">HomePage</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">Model</span><span class="p">(</span><span class="s2">&quot;oepetstore.message_of_the_day&quot;</span><span class="p">);</span>
        <span class="nx">model</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;my_method&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="k">new</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">CompoundContext</span><span class="p">()}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;Hello &quot;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">[</span><span class="s2">&quot;hello&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">);</span>
            <span class="c1">// will show &quot;Hello world&quot; to the user</span>
        <span class="p">});</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<p>The class used to call Odoo models is <code class="xref js js-class docutils literal"><span class="pre">gerp.Model()</span></code>. It is
instantiated with the Odoo model’s name as first parameter
(<code class="docutils literal"><span class="pre">oepetstore.message_of_the_day</span></code> here).</p>
<p><code class="xref js js-func docutils literal"><span class="pre">call()</span></code> can be used to call any (public) method of an
Odoo model. It takes the following positional arguments:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">name</span></code></dt>
<dd>The name of the method to call, <code class="docutils literal"><span class="pre">my_method</span></code> here</dd>
<dt><code class="docutils literal"><span class="pre">args</span></code></dt>
<dd><p class="first">an array of <a class="reference external" href="https://docs.python.org/2/glossary.html#term-argument">positional arguments</a> to provide to the method. Because the
example has no positional argument to provide, the <code class="docutils literal"><span class="pre">args</span></code> parameter is not
provided.</p>
<p>Here is an other example with positional arguments:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@api.model</span>
<span class="k">def</span> <span class="nf">my_method2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</div>
<div class="last highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">model</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;my_method&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">...</span>
<span class="c1">// with this a=1, b=2 and c=3</span>
</pre></div>
</div>
</dd>
<dt><code class="docutils literal"><span class="pre">kwargs</span></code></dt>
<dd><p class="first">a mapping of <a class="reference external" href="https://docs.python.org/2/glossary.html#term-argument">keyword arguments</a> to pass. The example provides a single
named argument <code class="docutils literal"><span class="pre">context</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@api.model</span>
<span class="k">def</span> <span class="nf">my_method2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</div>
<div class="last highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">model</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;my_method&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">c</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="p">...</span>
<span class="c1">// with this a=1, b=2 and c=3</span>
</pre></div>
</div>
</dd>
</dl>
<p><code class="xref js js-func docutils literal"><span class="pre">call()</span></code> returns a deferred resolved with the value
returned by the model’s method as first argument.</p>
</div>
<div class="section" id="compoundcontext">
<h3>CompoundContext<a class="headerlink" href="#compoundcontext" title="Permalink to this headline">¶</a></h3>
<p>The previous section used a <code class="docutils literal"><span class="pre">context</span></code> argument which was not explained in
the method call:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">model</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;my_method&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="k">new</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">CompoundContext</span><span class="p">()})</span>
</pre></div>
</div>
<p>The context is like a “magic” argument that the web client will always give to
the server when calling a method. The context is a dictionary containing
multiple keys. One of the most important key is the language of the user, used
by the server to translate all the messages of the application. Another one is
the time zone of the user, used to compute correctly dates and times if Odoo
is used by people in different countries.</p>
<p>The <code class="docutils literal"><span class="pre">argument</span></code> is necessary in all methods, otherwise bad things could
happen (such as the application not being translated correctly). That’s why,
when you call a model’s method, you should always provide that argument. The
solution to achieve that is to use <code class="xref js js-class docutils literal"><span class="pre">gerp.web.CompoundContext()</span></code>.</p>
<p><code class="xref js js-class docutils literal"><span class="pre">CompoundContext()</span></code> is a class used to pass the user’s
context (with language, time zone, etc…) to the server as well as adding new
keys to the context (some models’ methods use arbitrary keys added to the
context). It is created by giving to its constructor any number of
dictionaries or other <code class="xref js js-class docutils literal"><span class="pre">CompoundContext()</span></code> instances. It will
merge all those contexts before sending them to the server.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">model</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s2">&quot;my_method&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">context</span><span class="o">:</span> <span class="k">new</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">CompoundContext</span><span class="p">({</span><span class="s1">&#39;new_key&#39;</span><span class="o">:</span> <span class="s1">&#39;key_value&#39;</span><span class="p">})})</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@api.model</span>
<span class="k">def</span> <span class="nf">my_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">context</span>
    <span class="o">//</span> <span class="n">will</span> <span class="k">print</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;lang&#39;</span><span class="p">:</span> <span class="s1">&#39;en_US&#39;</span><span class="p">,</span> <span class="s1">&#39;new_key&#39;</span><span class="p">:</span> <span class="s1">&#39;key_value&#39;</span><span class="p">,</span> <span class="s1">&#39;tz&#39;</span><span class="p">:</span> <span class="s1">&#39;Europe/Brussels&#39;</span><span class="p">,</span> <span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</pre></div>
</div>
<p>You can see the dictionary in the argument <code class="docutils literal"><span class="pre">context</span></code> contains some keys that
are related to the configuration of the current user in Odoo plus the
<code class="docutils literal"><span class="pre">new_key</span></code> key that was added when instantiating
<code class="xref js js-class docutils literal"><span class="pre">CompoundContext()</span></code>.</p>
</div>
<div class="section" id="queries">
<h3>Queries<a class="headerlink" href="#queries" title="Permalink to this headline">¶</a></h3>
<p>While <code class="xref js js-func docutils literal"><span class="pre">call()</span></code> is sufficient for any interaction with Odoo
models, Odoo Web provides a helper for simpler and clearer querying of models
(fetching of records based on various conditions):
<code class="xref js js-func docutils literal"><span class="pre">query()</span></code> which acts as a shortcut for the common
combination of <code class="xref py py-meth docutils literal"><span class="pre">search()</span></code> and
:<code class="xref py py-meth docutils literal"><span class="pre">read()</span></code>. It provides a clearer syntax to search
and read models:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">model</span><span class="p">.</span><span class="nx">query</span><span class="p">([</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;user_email&#39;</span><span class="p">,</span> <span class="s1">&#39;signature&#39;</span><span class="p">])</span>
     <span class="p">.</span><span class="nx">filter</span><span class="p">([[</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nx">main_company</span><span class="p">]])</span>
     <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
     <span class="p">.</span><span class="nx">all</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">users</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do work with users records</span>
<span class="p">});</span>
</pre></div>
</div>
<p>versus:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">model</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="p">[[</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;company_id&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nx">main_company</span><span class="p">]],</span> <span class="p">{</span><span class="nx">limit</span><span class="o">:</span> <span class="mi">15</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">ids</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">ids</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="s1">&#39;user_email&#39;</span><span class="p">,</span> <span class="s1">&#39;signature&#39;</span><span class="p">]]);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">users</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// do work with users records</span>
    <span class="p">});</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="xref js js-func docutils literal"><span class="pre">query()</span></code> takes an optional list of fields as
parameter (if no field is provided, all fields of the model are fetched). It
returns a <a class="reference internal" href="../reference/javascript.html#gerp.web.Query" title="gerp.web.Query"><code class="xref js js-class docutils literal"><span class="pre">gerp.web.Query()</span></code></a> which can be further customized before
being executed</li>
<li><a class="reference internal" href="../reference/javascript.html#gerp.web.Query" title="gerp.web.Query"><code class="xref js js-class docutils literal"><span class="pre">Query()</span></code></a> represents the query being built. It is
immutable, methods to customize the query actually return a modified copy,
so it’s possible to use the original and the new version side-by-side. See
<a class="reference internal" href="../reference/javascript.html#gerp.web.Query" title="gerp.web.Query"><code class="xref js js-class docutils literal"><span class="pre">Query()</span></code></a> for its customization options.</li>
</ul>
<p>When the query is set up as desired, simply call
<code class="xref js js-func docutils literal"><span class="pre">all()</span></code> to execute it and return a
deferred to its result. The result is the same as
<code class="xref py py-meth docutils literal"><span class="pre">read()</span></code>’s, an array of dictionaries where each
dictionary is a requested record, with each requested field a dictionary key.</p>
</div>
</div>
<div class="section" id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="existing-web-components">
<h2>Existing web components<a class="headerlink" href="#existing-web-components" title="Permalink to this headline">¶</a></h2>
<div class="section" id="the-action-manager">
<h3>The Action Manager<a class="headerlink" href="#the-action-manager" title="Permalink to this headline">¶</a></h3>
<p>In Odoo, many operations start from an <a class="reference internal" href="../reference/actions.html#reference-actions"><span class="std std-ref">action</span></a>:
opening a menu item (to a view), printing a report, …</p>
<p>Actions are pieces of data describing how a client should react to the
activation of a piece of content. Actions can be stored (and read through a
model) or they can be generated on-the fly (locally to the client by
javascript code, or remotely by a method of a model).</p>
<p>In Odoo Web, the component responsible for handling and reacting to these
actions is the <em>Action Manager</em>.</p>
<div class="section" id="using-the-action-manager">
<h4>Using the Action Manager<a class="headerlink" href="#using-the-action-manager" title="Permalink to this headline">¶</a></h4>
<p>The action manager can be invoked explicitly from javascript code by creating
a dictionary describing <a class="reference internal" href="../reference/actions.html#reference-actions"><span class="std std-ref">an action</span></a> of the right
type, and calling an action manager instance with it.</p>
<p><code class="xref js js-func docutils literal"><span class="pre">do_action()</span></code> is a shortcut of <code class="xref js js-class docutils literal"><span class="pre">Widget()</span></code>
looking up the “current” action manager and executing the action:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">TestWidget</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">Widget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">dispatch_to_new_action</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">do_action</span><span class="p">({</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;ir.actions.act_window&#39;</span><span class="p">,</span>
            <span class="nx">res_model</span><span class="o">:</span> <span class="s2">&quot;product.product&quot;</span><span class="p">,</span>
            <span class="nx">res_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nx">views</span><span class="o">:</span> <span class="p">[[</span><span class="kc">false</span><span class="p">,</span> <span class="s1">&#39;form&#39;</span><span class="p">]],</span>
            <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span>
            <span class="nx">context</span><span class="o">:</span> <span class="p">{},</span>
        <span class="p">});</span>
    <span class="p">},</span>
<span class="p">});</span>
</pre></div>
</div>
<p>The most common action <code class="docutils literal"><span class="pre">type</span></code> is <code class="docutils literal"><span class="pre">ir.actions.act_window</span></code> which provides
views to a model (displays a model in various manners), its most common
attributes are:</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">res_model</span></code></dt>
<dd>The model to display in views</dd>
<dt><code class="docutils literal"><span class="pre">res_id</span></code> (optional)</dt>
<dd>For form views, a preselected record in <code class="docutils literal"><span class="pre">res_model</span></code></dd>
<dt><code class="docutils literal"><span class="pre">views</span></code></dt>
<dd>Lists the views available through the action. A list of
<code class="docutils literal"><span class="pre">[view_id,</span> <span class="pre">view_type]</span></code>, <code class="docutils literal"><span class="pre">view_id</span></code> can either be the database identifier
of a view of the right type, or <code class="docutils literal"><span class="pre">false</span></code> to use the view by default for
the specified type. View types can not be present multiple times. The action
will open the first view of the list by default.</dd>
<dt><code class="docutils literal"><span class="pre">target</span></code></dt>
<dd>Either <code class="docutils literal"><span class="pre">current</span></code> (the default) which replaces the “content” section of the
web client by the action, or <code class="docutils literal"><span class="pre">new</span></code> to open the action in a dialog box.</dd>
<dt><code class="docutils literal"><span class="pre">context</span></code></dt>
<dd>Additional context data to use within the action.</dd>
</dl>
</div>
</div>
<div class="section" id="client-actions">
<h3>Client Actions<a class="headerlink" href="#client-actions" title="Permalink to this headline">¶</a></h3>
<p>Throughout this guide, we used a simple <code class="docutils literal"><span class="pre">HomePage</span></code> widget which the web
client automatically starts when we select the right menu item. But how did
the Odoo web know to start this widget? Because the widget is registered as
a <em>client action</em>.</p>
<p>A client action is (as its name implies) an action type defined almost
entirely in the client, in javascript for Odoo web. The server simply sends
an action tag (an arbitrary name), and optionally adds a few parameters, but
beyond that <em>everything</em> is handled by custom client code.</p>
<p>Our widget is registered as the handler for the client action through this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">client_actions</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;petstore.homepage&#39;</span><span class="p">,</span> <span class="s1">&#39;instance.oepetstore.HomePage&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">instance.web.client_actions</span></code> is a <code class="xref js js-class docutils literal"><span class="pre">Registry()</span></code> in which
the action manager looks up client action handlers when it needs to execute
one. The first parameter of <code class="xref js js-class docutils literal"><span class="pre">add()</span></code> is the name
(tag) of the client action, and the second parameter is the path to the widget
from the Odoo web client root.</p>
<p>When a client action must be executed, the action manager looks up its tag
in the registry, walks the specified path and displays the widget it finds at
the end.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">a client action handler can also be a regular function, in whch case
it’ll be called and its result (if any) will be interpreted as the
next action to execute.</p>
</div>
<p>On the server side, we had simply defined an <code class="docutils literal"><span class="pre">ir.actions.client</span></code> action:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;record</span> <span class="na">id=</span><span class="s">&quot;action_home_page&quot;</span> <span class="na">model=</span><span class="s">&quot;ir.actions.client&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;tag&quot;</span><span class="nt">&gt;</span>petstore.homepage<span class="nt">&lt;/field&gt;</span>
<span class="nt">&lt;/record&gt;</span>
</pre></div>
</div>
<p>and a menu opening the action:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;menuitem</span> <span class="na">id=</span><span class="s">&quot;home_page_petstore_menu&quot;</span> <span class="na">parent=</span><span class="s">&quot;petstore_menu&quot;</span>
          <span class="na">name=</span><span class="s">&quot;Home Page&quot;</span> <span class="na">action=</span><span class="s">&quot;action_home_page&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="architecture-of-the-views">
<h3>Architecture of the Views<a class="headerlink" href="#architecture-of-the-views" title="Permalink to this headline">¶</a></h3>
<p>Much of Odoo web’s usefulness (and complexity) resides in views. Each view
type is a way of displaying a model in the client.</p>
<div class="section" id="the-view-manager">
<h4>The View Manager<a class="headerlink" href="#the-view-manager" title="Permalink to this headline">¶</a></h4>
<p>When an <code class="docutils literal"><span class="pre">ActionManager</span></code> instance receive an action of type
<code class="docutils literal"><span class="pre">ir.actions.act_window</span></code>, it delegates the synchronization and handling of
the views themselves to a <em>view manager</em>, which will then set up one or
multiple views depending on the original action’s requirements:</p>
<a class="reference internal image-reference" href="../_images/viewarchitecture.svg"><div align="center" class="align-center"><img alt="../_images/viewarchitecture.svg" src="../_images/viewarchitecture.svg" width="40%" /></div>
</a>
</div>
<div class="section" id="the-views">
<h4>The Views<a class="headerlink" href="#the-views" title="Permalink to this headline">¶</a></h4>
<p>Most <a class="reference internal" href="../reference/views.html#reference-views"><span class="std std-ref">Odoo views</span></a> are implemented through a subclass
of <code class="xref js js-class docutils literal"><span class="pre">gerp.web.View()</span></code> which provides a bit of generic basic structure
for handling events and displaying model information.</p>
<p>The <em>search view</em> is considered a view type by the main Odoo framework, but
handled separately by the web client (as it’s a more permanent fixture and
can interact with other views, which regular views don’t do).</p>
<p>A view is responsible for loading its own description XML (using
<code class="xref py py-class docutils literal"><span class="pre">fields_view_get</span></code>) and any other data source
it needs. To that purpose, views are provided with an optional view
identifier set as the <code class="xref js js-attr docutils literal"><span class="pre">view_id</span></code> attribute.</p>
<p>Views are also provided with a <code class="xref js js-class docutils literal"><span class="pre">DataSet()</span></code> instance which
holds most necessary model information (the model name and possibly various
record ids).</p>
<p>Views may also want to handle search queries by overriding
<code class="xref js js-func docutils literal"><span class="pre">do_search()</span></code>, and updating their
<code class="xref js js-class docutils literal"><span class="pre">DataSet()</span></code> as necessary.</p>
</div>
</div>
<div class="section" id="the-form-view-fields">
<h3>The Form View Fields<a class="headerlink" href="#the-form-view-fields" title="Permalink to this headline">¶</a></h3>
<p>A common need is the extension of the web form view to add new ways of
displaying fields.</p>
<p>All built-in fields have a default display implementation, a new
form widget may be necessary to correctly interact with a new field type
(e.g. a <a class="reference internal" href="../glossary.html#term-gis"><span class="xref std std-term">GIS</span></a> field) or to provide new representations and ways to
interact with existing field types (e.g. validate
<code class="xref py py-class docutils literal"><span class="pre">Char</span></code> fields which should contain email addresses
and display them as email links).</p>
<p>To explicitly specify which form widget should be used to display a field,
simply use the <code class="docutils literal"><span class="pre">widget</span></code> attribute in the view’s XML description:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;field</span> <span class="na">name=</span><span class="s">&quot;contact_mail&quot;</span> <span class="na">widget=</span><span class="s">&quot;email&quot;</span><span class="nt">/&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last simple">
<li>the same widget is used in both “view” (read-only) and “edition” modes
of a form view, it’s not possible to use a widget in one and an other
widget in the other</li>
<li>and a given field (name) can not be used multiple times in the same form</li>
<li>a widget may ignore the current mode of the form view and remain the
same in both view and edition</li>
</ul>
</div>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">most of this should probably move to an advanced form view guide</p>
</div>
<p>Fields are instantiated by the form view after it has read its XML description
and constructed the corresponding HTML representing that description. After
that, the form view will communicate with the field objects using some
methods. These methods are defined by the <code class="docutils literal"><span class="pre">FieldInterface</span></code>
interface. Almost all fields inherit the <code class="docutils literal"><span class="pre">AbstractField</span></code> abstract
class. That class defines some default mechanisms that need to be implemented
by most fields.</p>
<p>Here are some of the responsibilities of a field class:</p>
<ul class="simple">
<li>The field class must display and allow the user to edit the value of the field.</li>
<li>It must correctly implement the 3 field attributes available in all fields
of Odoo. The <code class="docutils literal"><span class="pre">AbstractField</span></code> class already implements an algorithm that
dynamically calculates the value of these attributes (they can change at any
moment because their value change according to the value of other
fields). Their values are stored in <em>Widget Properties</em> (the widget
properties were explained earlier in this guide). It is the responsibility
of each field class to check these widget properties and dynamically adapt
depending of their values. Here is a description of each of these
attributes:<ul>
<li><code class="docutils literal"><span class="pre">required</span></code>: The field must have a value before saving. If <code class="docutils literal"><span class="pre">required</span></code>
is <code class="docutils literal"><span class="pre">true</span></code> and the field doesn’t have a value, the method
<code class="docutils literal"><span class="pre">is_valid()</span></code> of the field must return <code class="docutils literal"><span class="pre">false</span></code>.</li>
<li><code class="docutils literal"><span class="pre">invisible</span></code>: When this is <code class="docutils literal"><span class="pre">true</span></code>, the field must be invisible. The
<code class="docutils literal"><span class="pre">AbstractField</span></code> class already has a basic implementation of this
behavior that fits most fields.</li>
<li><code class="docutils literal"><span class="pre">readonly</span></code>: When <code class="docutils literal"><span class="pre">true</span></code>, the field must not be editable by the
user. Most fields in Odoo have a completely different behavior depending
on the value of <code class="docutils literal"><span class="pre">readonly</span></code>. As example, the <code class="docutils literal"><span class="pre">FieldChar</span></code> displays an
HTML <code class="docutils literal"><span class="pre">&lt;input&gt;</span></code> when it is editable and simply displays the text when
it is read-only. This also means it has much more code it would need to
implement only one behavior, but this is necessary to ensure a good user
experience.</li>
</ul>
</li>
<li>Fields have two methods, <code class="docutils literal"><span class="pre">set_value()</span></code> and <code class="docutils literal"><span class="pre">get_value()</span></code>, which are
called by the form view to give it the value to display and get back the new
value entered by the user. These methods must be able to handle the value as
given by the Odoo server when a <code class="docutils literal"><span class="pre">read()</span></code> is performed on a model and give
back a valid value for a <code class="docutils literal"><span class="pre">write()</span></code>.  Remember that the JavaScript/Python
data types used to represent the values given by <code class="docutils literal"><span class="pre">read()</span></code> and given to
<code class="docutils literal"><span class="pre">write()</span></code> is not necessarily the same in Odoo. As example, when you read a
many2one, it is always a tuple whose first value is the id of the pointed
record and the second one is the name get (ie: <code class="docutils literal"><span class="pre">(15,</span> <span class="pre">&quot;Agrolait&quot;)</span></code>). But
when you write a many2one it must be a single integer, not a tuple
anymore. <code class="docutils literal"><span class="pre">AbstractField</span></code> has a default implementation of these methods
that works well for simple data type and set a widget property named
<code class="docutils literal"><span class="pre">value</span></code>.</li>
</ul>
<p>Please note that, to better understand how to implement fields, you are
strongly encouraged to look at the definition of the <code class="docutils literal"><span class="pre">FieldInterface</span></code>
interface and the <code class="docutils literal"><span class="pre">AbstractField</span></code> class directly in the code of the Odoo web
client.</p>
<div class="section" id="creating-a-new-type-of-field">
<h4>Creating a New Type of Field<a class="headerlink" href="#creating-a-new-type-of-field" title="Permalink to this headline">¶</a></h4>
<p>In this part we will explain how to create a new type of field. The example
here will be to re-implement the <code class="docutils literal"><span class="pre">FieldChar</span></code> class and progressively explain
each part.</p>
<div class="section" id="simple-read-only-field">
<h5>Simple Read-Only Field<a class="headerlink" href="#simple-read-only-field" title="Permalink to this headline">¶</a></h5>
<p>Here is a first implementation that will only display text. The
user will not be able to modify the content of the field.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">FieldChar2</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">AbstractField</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">render_value</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">));</span>
    <span class="p">},</span>
<span class="p">});</span>

<span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">widgets</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;char2&#39;</span><span class="p">,</span> <span class="s1">&#39;instance.oepetstore.FieldChar2&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>In this example, we declare a class named <code class="docutils literal"><span class="pre">FieldChar2</span></code> inheriting from
<code class="docutils literal"><span class="pre">AbstractField</span></code>. We also register this class in the registry
<code class="docutils literal"><span class="pre">instance.web.form.widgets</span></code> under the key <code class="docutils literal"><span class="pre">char2</span></code>. That will allow us to
use this new field in any form view by specifying <code class="docutils literal"><span class="pre">widget=&quot;char2&quot;</span></code> in the
<code class="docutils literal"><span class="pre">&lt;field/&gt;</span></code> tag in the XML declaration of the view.</p>
<p>In this example, we define a single method: <code class="docutils literal"><span class="pre">render_value()</span></code>. All it does is
display the widget property <code class="docutils literal"><span class="pre">value</span></code>.  Those are two tools defined by the
<code class="docutils literal"><span class="pre">AbstractField</span></code> class. As explained before, the form view will call the
method <code class="docutils literal"><span class="pre">set_value()</span></code> of the field to set the value to display. This method
already has a default implementation in <code class="docutils literal"><span class="pre">AbstractField</span></code> which simply sets
the widget property <code class="docutils literal"><span class="pre">value</span></code>. <code class="docutils literal"><span class="pre">AbstractField</span></code> also watch the
<code class="docutils literal"><span class="pre">change:value</span></code> event on itself and calls the <code class="docutils literal"><span class="pre">render_value()</span></code> when it
occurs. So, <code class="docutils literal"><span class="pre">render_value()</span></code> is a convenience method to implement in child
classes to perform some operation each time the value of the field changes.</p>
<p>In the <code class="docutils literal"><span class="pre">init()</span></code> method, we also define the default value of the field if
none is specified by the form view (here we assume the default value of a
<code class="docutils literal"><span class="pre">char</span></code> field should be an empty string).</p>
</div>
<div class="section" id="read-write-field">
<h5>Read-Write Field<a class="headerlink" href="#read-write-field" title="Permalink to this headline">¶</a></h5>
<p>Read-only fields, which only display content and don’t allow the
user to modify it can be useful, but most fields in Odoo also allow editing.
This makes the field classes more complicated, mostly because fields are
supposed to handle both editable and non-editable mode, those modes are
often completely different (for design and usability purpose) and the fields
must be able to switch between modes at any moment.</p>
<p>To know in which mode the current field should be, the <code class="docutils literal"><span class="pre">AbstractField</span></code> class
sets a widget property named <code class="docutils literal"><span class="pre">effective_readonly</span></code>. The field should watch
for changes in that widget property and display the correct mode
accordingly. Example:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">FieldChar2</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">AbstractField</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change:effective_readonly&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">display_field</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">render_value</span><span class="p">();</span>
        <span class="p">});</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">display_field</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">display_field</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">QWeb</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s2">&quot;FieldChar2&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">widget</span><span class="o">:</span> <span class="k">this</span><span class="p">}));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;effective_readonly&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">).</span><span class="nx">change</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">internal_set_value</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">render_value</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;effective_readonly&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">},</span>
<span class="p">});</span>

<span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">widgets</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;char2&#39;</span><span class="p">,</span> <span class="s1">&#39;instance.oepetstore.FieldChar2&#39;</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;t</span> <span class="na">t-name=</span><span class="s">&quot;FieldChar2&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;oe_field_char2&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;t</span> <span class="na">t-if=</span><span class="s">&quot;! widget.get(&#39;effective_readonly&#39;)&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
        <span class="nt">&lt;/t&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/t&gt;</span>
</pre></div>
</div>
<p>In the <code class="docutils literal"><span class="pre">start()</span></code> method (which is called immediately after a widget has been
appended to the DOM), we bind on the event <code class="docutils literal"><span class="pre">change:effective_readonly</span></code>. That
allows us to redisplay the field each time the widget property
<code class="docutils literal"><span class="pre">effective_readonly</span></code> changes. This event handler will call
<code class="docutils literal"><span class="pre">display_field()</span></code>, which is also called directly in <code class="docutils literal"><span class="pre">start()</span></code>. This
<code class="docutils literal"><span class="pre">display_field()</span></code> was created specifically for this field, it’s not a method
defined in <code class="docutils literal"><span class="pre">AbstractField</span></code> or any other class. We can use this method
to display the content of the field depending on the current mode.</p>
<p>From now on the conception of this field is typical, except there is a
lot of verifications to know the state of the <code class="docutils literal"><span class="pre">effective_readonly</span></code> property:</p>
<ul class="simple">
<li>In the QWeb template used to display the content of the widget, it displays
an <code class="docutils literal"><span class="pre">&lt;input</span> <span class="pre">type=&quot;text&quot;</span> <span class="pre">/&gt;</span></code> if we are in read-write mode and nothing in
particular in read-only mode.</li>
<li>In the <code class="docutils literal"><span class="pre">display_field()</span></code> method, we have to bind on the <code class="docutils literal"><span class="pre">change</span></code> event
of the <code class="docutils literal"><span class="pre">&lt;input</span> <span class="pre">type=&quot;text&quot;</span> <span class="pre">/&gt;</span></code> to know when the user has changed the
value. When it happens, we call the <code class="docutils literal"><span class="pre">internal_set_value()</span></code> method with the
new value of the field. This is a convenience method provided by the
<code class="docutils literal"><span class="pre">AbstractField</span></code> class. That method will set a new value in the <code class="docutils literal"><span class="pre">value</span></code>
property but will not trigger a call to <code class="docutils literal"><span class="pre">render_value()</span></code> (which is not
necessary since the <code class="docutils literal"><span class="pre">&lt;input</span> <span class="pre">type=&quot;text&quot;</span> <span class="pre">/&gt;</span></code> already contains the correct
value).</li>
<li>In <code class="docutils literal"><span class="pre">render_value()</span></code>, we use a completely different code to display the
value of the field depending if we are in read-only or in read-write mode.</li>
</ul>
</div>
</div>
</div>
<div class="section" id="the-form-view-custom-widgets">
<h3>The Form View Custom Widgets<a class="headerlink" href="#the-form-view-custom-widgets" title="Permalink to this headline">¶</a></h3>
<p>Form fields are used to edit a single field, and are intrinsically linked to
a field. Because this may be limiting, it is also possible to create
<em>form widgets</em> which are not so restricted and have less ties to a specific
lifecycle.</p>
<p>Custom form widgets can be added to a form view through the <code class="docutils literal"><span class="pre">widget</span></code> tag:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;widget</span> <span class="na">type=</span><span class="s">&quot;xxx&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>
<p>This type of widget will simply be created by the form view during the
creation of the HTML according to the XML definition. They have properties in
common with the fields (like the <code class="docutils literal"><span class="pre">effective_readonly</span></code> property) but they are
not assigned a precise field. And so they don’t have methods like
<code class="docutils literal"><span class="pre">get_value()</span></code> and <code class="docutils literal"><span class="pre">set_value()</span></code>. They must inherit from the <code class="docutils literal"><span class="pre">FormWidget</span></code>
abstract class.</p>
<p>Form widgets can interact with form fields by listening for their changes and
fetching or altering their values. They can access form fields through
their <code class="xref js js-attr docutils literal"><span class="pre">field_manager</span></code> attribute:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="nx">local</span><span class="p">.</span><span class="nx">WidgetMultiplication</span> <span class="o">=</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">FormWidget</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
    <span class="nx">start</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_super</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">field_manager</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;field_changed:integer_a&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">display_result</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">field_manager</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;field_changed:integer_b&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">display_result</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">display_result</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="nx">display_result</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">field_manager</span><span class="p">.</span><span class="nx">get_field_value</span><span class="p">(</span><span class="s2">&quot;integer_a&quot;</span><span class="p">)</span> <span class="o">*</span>
                     <span class="k">this</span><span class="p">.</span><span class="nx">field_manager</span><span class="p">.</span><span class="nx">get_field_value</span><span class="p">(</span><span class="s2">&quot;integer_b&quot;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s2">&quot;a*b = &quot;</span> <span class="o">+</span> <span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">instance</span><span class="p">.</span><span class="nx">web</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">custom_widgets</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;multiplication&#39;</span><span class="p">,</span> <span class="s1">&#39;instance.oepetstore.WidgetMultiplication&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="xref js js-attr docutils literal"><span class="pre">FormWidget</span></code> is generally the
<code class="xref js js-class docutils literal"><span class="pre">FormView()</span></code> itself, but features used from it should
be limited to those defined by <code class="xref js js-class docutils literal"><span class="pre">FieldManagerMixin()</span></code>,
the most useful being:</p>
<ul class="simple">
<li><code class="xref js js-func docutils literal"><span class="pre">get_field_value(field_name)()</span></code>
which returns the value of a field.</li>
<li><code class="xref js js-func docutils literal"><span class="pre">set_values(values)()</span></code> sets multiple
field values, takes a mapping of <code class="docutils literal"><span class="pre">{field_name:</span> <span class="pre">value_to_set}</span></code></li>
<li>An event <code class="samp docutils literal"><span class="pre">field_changed:</span><em><span class="pre">field_name</span></em></code> is triggered any time the value
of the field called <code class="docutils literal"><span class="pre">field_name</span></code> is changed</li>
</ul>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>as a separate concept from instances. In many languages classes
are full-fledged objects and themselves instance (of
metaclasses) but there remains two fairly separate hierarchies
between classes and instances</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="dombugs" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>as well as papering over cross-browser differences, although
this has become less necessary over time</td></tr>
</tbody>
</table>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Gahan Corporation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/howtos/web.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>